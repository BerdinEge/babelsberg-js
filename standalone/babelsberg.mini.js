function __oldNamespace(spec,context){var i,N;if(context=context||window,spec=spec.valueOf(),"object"!=typeof spec){if("string"==typeof spec)return function(){var parts;for(parts=spec.split("."),i=0,N=parts.length;N>i;i++)spec=parts[i],context[spec]=context[spec]||{},context=context[spec]}(),context;throw new TypeError}if("number"==typeof spec.length)for(i=0,N=spec.length;N>i;i++)return namespace(spec[i],context);else for(i in spec)if(spec.hasOwnProperty(i))return context[i]=context[i],namespace(spec[i],context[i])}function namespace(spec,context){var codeDB;"$"==spec[0]&&(codeDB=spec.substring(1,spec.indexOf(".")),spec=spec.substring(spec.indexOf(".")+1));var ret=__oldNamespace(spec,context);return codeDB&&(ret.fromDB=codeDB),ret}function StringBuffer(){this.strings=[];for(var idx=0;idx<arguments.length;idx++)this.nextPutAll(arguments[idx])}function ReadStream(anArrayOrString){this.src=anArrayOrString,this.pos=0}function ometaUnescape(s){if("\\"!=s.charAt(0))return s;switch(s.charAt(1)){case"'":return"'";case'"':return'"';case"\\":return"\\";case"b":return"\b";case"f":return"\f";case"n":return"\n";case"r":return"\r";case"t":return"	";case"v":return"";case"x":return String.fromCharCode(parseInt(s.substring(2,4),16));case"u":return String.fromCharCode(parseInt(s.substring(2,6),16));default:return s.charAt(1)}}function tempnam(s){return(s?s:"_tmpnam_")+tempnam.n++}function OMInputStream(hd,tl){this.memo={},this.lst=tl.lst,this.idx=tl.idx,this.hd=hd,this.tl=tl}function OMInputStreamEnd(lst,idx){this.memo={},this.lst=lst,this.idx=idx}function ListOMInputStream(lst,idx){this.memo={},this.lst=lst,this.idx=idx,this.hd=lst.at(idx)}function makeListOMInputStream(lst,idx){return new(idx<lst.length?ListOMInputStream:OMInputStreamEnd)(lst,idx)}function makeOMInputStreamProxy(target){return objectThatDelegatesTo(target,{memo:{},target:target,tl:void 0,tail:function(){return this.tl||(this.tl=makeOMInputStreamProxy(target.tail()))}})}function Failer(){}window.module||(window.module=function(dottedPath){if(""==dottedPath)return window;var path=dottedPath.split("."),name=path.pop(),parent=module(path.join("."));return parent[name]||(parent[name]={requires:function(){return this},toRun:function(code){code()}}),parent[name]},window.Properties={all:function(object,predicate){var a=[];for(var name in object)!object.__lookupGetter__(name)&&Object.isFunction(object[name])||(predicate?!predicate(name,object):0)||a.push(name);return a},allOwnPropertiesOrFunctions:function(obj,predicate){var result=[];return Object.getOwnPropertyNames(obj).forEach(function(name){predicate(obj,name)&&result.push(name)}),result},own:function(object){var a=[];for(var name in object)!object.hasOwnProperty(name)||!object.__lookupGetter__(name)&&Object.isFunction(object[name])||a.push(name);return a},forEachOwn:function(object,func,context){var result=[];for(var name in object)if(object.hasOwnProperty(name)){var value=object[name];Object.isFunction(value)||result.push(func.call(context||this,name,value))}return result},nameFor:function(object,value){for(var name in object)if(object[name]===value)return name;return void 0},values:function(obj){var values=[];for(var name in obj)values.push(obj[name]);return values},ownValues:function(obj){var values=[];for(var name in obj)obj.hasOwnProperty(name)&&values.push(obj[name]);return values},printObjectSize:function(obj){return Numbers.humanReadableByteSize(JSON.stringify(obj).length)},any:function(obj,predicate){for(var name in obj)if(predicate(obj,name))return!0;return!1},allProperties:function(obj,predicate){var result=[];for(var name in obj)predicate(obj,name)&&result.push(name);return result},hash:function(obj){return Object.keys(obj).sort().join("").hashCode()}},window.Config={},window.cop={},window.Global=window,window.lively=window,lively.Module=function(){return null},window.dbgOn=function(b){},window.JSLoader=function(){throw"Stubbed JSLoader actually in use"},Object.extend(Class,{isClass:function(object){return object===Object||object===Array||object===Function||object===String||object===Boolean||object===Date||object===RegExp||object===Number?!0:object instanceof Function&&void 0!==object.superclass},namespaceFor:function(className){var lastDot=className.lastIndexOf(".");return 0>lastDot?window:namespace(className.substring(0,lastDot))},unqualifiedNameFor:function(name){var lastDot=name.lastIndexOf("."),unqualifiedName=name.substring(lastDot+1);return unqualifiedName}}),Object.extend(Function.prototype,{subclass:function(){var args=$A(arguments),className=args.shift(),targetScope=Global,shortName=null;className?(targetScope=lively.Class.namespaceFor(className),shortName=lively.Class.unqualifiedNameFor(className)):(shortName="anonymous_"+lively.Class.anonymousCounter++,className=shortName);var klass;if(className&&targetScope[shortName]&&targetScope[shortName].superclass===this)klass=targetScope[shortName];else{klass=function(){return this.initialize&&this.initialize.apply(this,arguments),this},klass.name=shortName,klass.superclass=this;var protoclass=function(){};protoclass.prototype=this.prototype,klass.prototype=new protoclass,klass.prototype.constructor=klass,klass.prototype.constructor.type=className,klass.prototype.constructor.displayName=className,className&&(targetScope[shortName]=klass),Global.lively&&lively.Module&&lively.Module.current&&(klass.sourceModule=lively.Module.current())}return this.addMethods.apply(klass,args),klass.prototype.initialize||(klass.prototype.initialize=function(){}),klass},addMethods:function(){for(var args=arguments,i=0;i<args.length;i++)Object.isString(args[i])||this.addCategorizedMethods(args[i]instanceof Function?args[i]():args[i])},addCategorizedMethods:function(source){var ancestor=this.superclass&&this.superclass.prototype,className=this.type||"Anonymous";for(var property in source)if("constructor"!=property){var getter=source.__lookupGetter__(property);getter&&this.prototype.__defineGetter__(property,getter);var setter=source.__lookupSetter__(property);if(setter&&this.prototype.__defineSetter__(property,setter),!getter&&!setter){var value=source[property],hasSuperCall=ancestor&&Object.isFunction(value)&&value.argumentNames&&"$super"==value.argumentNames().first();if(hasSuperCall&&!function(){var method=value,advice=function(m){return function(){var method=ancestor[m];if(!method)throw new Error(Strings.format("Trying to call super of%s>>%s but super method non existing in %s",className,m,ancestor.constructor.type));return method.apply(this,arguments)}}(property);advice.methodName="$super:"+(this.superclass?this.superclass.type+">>":"")+property,value=Object.extend(advice.wrap(method),{valueOf:function(){return method},toString:function(){return method.toString()},originalFunction:method}),method.varMapping={$super:advice}}(),this.prototype[property]=value,"formals"===property)Class.addPins(this,value);else if(Object.isFunction(value))for(value.displayName=className+"$"+property;value;value=value.originalFunction)value.methodName,value.declaredClass=this.prototype.constructor.type,value.methodName=property}}return this},binds:function(){return this},getVarMapping:function(){return this.varMapping}}),window.Strings={newUUID:function(){var id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=0|16*Math.random(),v="x"==c?r:8|3&r;return v.toString(16)}).toUpperCase();return id},format:function(){return Strings.formatFromArray(Array.from(arguments))},formatFromArray:function(objects){function appendText(object){return""+object}function appendInteger(value){return value.toString()}function appendFloat(value,string,precision){return precision>-1?value.toFixed(precision):value.toString()}function appendObject(value){return Objects.inspect(value)}function parseFormat(fmt){for(var parts=[],m=reg.exec(fmt);m;m=reg.exec(fmt)){var type=m[8]||m[5],appender=type in appenderMap?appenderMap[type]:appendObject,precision=m[3]?parseInt(m[3]):"."==m[4]?-1:0;parts.push(fmt.substr(0,"%"==m[0][0]?m.index:m.index+1)),parts.push({appender:appender,precision:precision}),fmt=fmt.substr(m.index+m[0].length)}return fmt&&parts.push(fmt.toString()),parts}var self=objects.shift();self||console.log("Error in Strings>>formatFromArray, first arg is undefined");for(var appenderMap={s:appendText,d:appendInteger,i:appendInteger,f:appendFloat,o:appendObject},reg=/((^%|[^\\]%)(\d+)?(\.)([a-zA-Z]))|((^%|[^\\]%)([a-zA-Z]))/,parts=parseFormat(self),str="",objIndex=0,i=0;i<parts.length;++i){var part=parts[i];if(part&&"object"==typeof part){var object=objects[objIndex++];str+=(part.appender||appendText)(object,str,part.precision)}else str+=appendText(part,str)}return str}}),module("cop.Layers").requires().toRun(function(){Config.ignoredepricatedProceed=!0;var log_layer_code=!1;Object.extend(cop,{dynamicInlining:Config.copDynamicInlining&&!document.URL.include("noDynamicInlining"),staticInlining:!1,proceedStack:[],GlobalLayers:[],object_id_counter:0}),Object.extend(cop,{withLogLayerCode:function(func){try{var old=log_layer_code;log_layer_code=!0,func()}finally{log_layer_code=old}},getLayerDefinitionForObject:function(layer,object){if(layer&&object){var result=layer[object._layer_object_id];return result?result:cop.getLayerDefinitionForObject(layer,object.prototype)}},ensurePartialLayer:function(layer,object){if(!layer)throw new Error("in ensurePartialLayer: layer is nil");return object.hasOwnProperty("_layer_object_id")||(object._layer_object_id=cop.object_id_counter++),layer[object._layer_object_id]||(layer[object._layer_object_id]={_layered_object:object}),layer[object._layer_object_id]},layerMethod:function(layer,object,property,func){cop.ensurePartialLayer(layer,object)[property]=func,func.displayName="layered "+layer.name+" "+(object.constructor?object.constructor.type+"$":"")+property,cop.makeFunctionLayerAware(object,property,layer.isHidden),Object.isFunction(object.getName)&&(layer.layeredFunctionsList[object][property]=!0)},layerGetterMethod:function(layer,object,property,getter){cop.ensurePartialLayer(layer,object).__defineGetter__(property,getter)},layerSetterMethod:function(layer,object,property,setter){cop.ensurePartialLayer(layer,object).__defineSetter__(property,setter)},layerProperty:function(layer,object,property,defs){var getter=defs.__lookupGetter__(property);getter&&cop.layerGetterMethod(layer,object,property,getter);var setter=defs.__lookupSetter__(property);setter&&cop.layerSetterMethod(layer,object,property,setter),getter||setter?cop.makePropertyLayerAware(object,property):cop.layerMethod(layer,object,property,defs[property])},layerPropertyWithShadow:function(layer,object,property){var defs={},baseValue=object[property],layeredPropName="_layered_"+layer.getName()+"_"+property;defs.__defineGetter__(property,function(){return void 0===this[layeredPropName]?cop.proceed():this[layeredPropName]}.binds({layeredPropName:layeredPropName,baseValue:baseValue})),defs.__defineSetter__(property,function(v){this[layeredPropName]=v}.binds({layeredPropName:layeredPropName})),cop.layerProperty(layer,object,property,defs)},computeLayersFor:function(obj){return obj&&obj.activeLayers?obj.activeLayers(cop.currentLayers):cop.currentLayers()},composeLayers:function(stack){for(var result=cop.GlobalLayers.clone(),i=0;i<stack.length;i++){var current=stack[i];current.withLayers?result=result.without.apply(result,current.withLayers).concat(current.withLayers):current.withoutLayers&&(result=result.without.apply(result,current.withoutLayers))}return result},currentLayers:function(){if(0==cop.LayerStack.length)throw new Error("The default layer is missing");var current=cop.LayerStack.last();return(!current.composition||cop.dynamicInlining&&!current.composition.hash)&&(current.composition=cop.composeLayers(cop.LayerStack),cop.dynamicInlining&&(current.composition.hash=cop.computeHashForLayers(current.composition))),current.composition},invalidateLayerComposition:function(){cop.LayerStack.forEach(function(ea){ea.composition=null})},resetLayerStack:function(){cop.LayerStack=[{isStatic:!0,toString:function(){return"BaseLayer"},composition:null}],cop.invalidateLayerComposition()},lookupLayeredFunctionForObject:function(self,layer,function_name,methodType){if(!layer)return void 0;var layered_function,layer_definition_for_object=cop.getLayerDefinitionForObject(layer,self);if(layer_definition_for_object&&("getter"==methodType?layered_function=layer_definition_for_object.__lookupGetter__(function_name):"setter"==methodType?layered_function=layer_definition_for_object.__lookupSetter__(function_name):layer_definition_for_object.hasOwnProperty(function_name)&&(layered_function=layer_definition_for_object[function_name])),!layered_function){var superclass=self.constructor.superclass;if(superclass)return foundClass=superclass,cop.lookupLayeredFunctionForObject(superclass.prototype,layer,function_name,methodType)}return layered_function},pvtMakeFunctionOrPropertyLayerAware:function(obj,slotName,baseValue,type,isHidden){return baseValue.isLayerAware?void 0:cop.staticInlining?cop.makeSlotLayerAwareWithStaticInlining(obj,slotName,baseValue,type):cop.dynamicInlining?cop.makeSlotLayerAwareWithDynamicInlining(obj,slotName,baseValue,type):(cop.makeSlotLayerAwareWithNormalLookup(obj,slotName,baseValue,type,isHidden),void 0)},makeSlotLayerAwareWithNormalLookup:function(obj,slotName,baseValue,type,isHidden){var wrapped_function=function(){var composition=new cop.PartialLayerComposition(this,obj,slotName,baseValue,type);cop.proceedStack.push(composition);try{return cop.proceed.apply(this,arguments)}finally{cop.proceedStack.pop()}};wrapped_function.isLayerAware=!0,wrapped_function.isContextJSWrapper=!0,isHidden&&(wrapped_function.toString=function(){return this.getOriginal().toString()}),wrapped_function.originalFunction=baseValue,"getter"==type?obj.__defineGetter__(slotName,wrapped_function):"setter"==type?obj.__defineSetter__(slotName,wrapped_function):obj[slotName]=wrapped_function},makeFunctionLayerAware:function(base_obj,function_name,isHidden){if(!base_obj)throw new Error("can't layer an non existent object");var base_function=base_obj[function_name];base_function||(base_function=function(){return null}),cop.pvtMakeFunctionOrPropertyLayerAware(base_obj,function_name,base_function,void 0,isHidden)},makePropertyLayerAware:function(baseObj,property){if(!baseObj)throw new Error("can't layer an non existent object");var getter=baseObj.__lookupGetter__(property),propName="__layered_"+property+"__";getter||(baseObj[propName]=baseObj[property],getter=function(){return this[propName]}.binds({propName:propName}),baseObj.__defineGetter__(property,getter));var setter=baseObj.__lookupSetter__(property);setter||(setter=function(value){return this[propName]=value}.binds({propName:propName}),baseObj.__defineSetter__(property,setter)),cop.pvtMakeFunctionOrPropertyLayerAware(baseObj,property,getter,"getter"),cop.pvtMakeFunctionOrPropertyLayerAware(baseObj,property,setter,"setter")},makeFunctionLayerUnaware:function(base_obj,function_name){if(!base_obj)throw new Error("need object to makeFunctionLayerUnaware");var prevFunction,currentFunction=base_obj[function_name];if(void 0!==currentFunction){for(;"function"==typeof currentFunction.originalFunction&&!currentFunction.isLayerAware;){var prevFunction=currentFunction;currentFunction=currentFunction.originalFunction}if(currentFunction.isLayerAware){var originalFunction=currentFunction.originalFunction;if(!(originalFunction instanceof Function))throw new Error("makeFunctionLayerUnaware Error: no orignal function");prevFunction instanceof Function?prevFunction.originalFunction=originalFunction:base_obj[function_name]=originalFunction}}},uninstallLayersInObject:function(object){Functions.own(object).forEach(function(ea){cop.makeFunctionLayerUnaware(object,ea)})},uninstallLayersInAllClasses:function(){Global.classes(!0).forEach(function(ea){cop.uninstallLayersInObject(ea.prototype)})},allLayers:function(optObject){return Object.values(optObject||Global).select(function(ea){return ea instanceof Layer})}}),Object.extend(cop,{create:function(name){var context=lively.Class.namespaceFor(name),layerName=lively.Class.unqualifiedNameFor(name);return context[layerName]=cop.basicCreate(layerName,context)},basicCreate:function(layerName,context){return context=context||Global,context[layerName]||new Layer(layerName,context.namespaceIdentifier)},layer:function(name){return console.log("SyntaxDepricated: cop.layer(... use cop.create("),cop.create(name,!0)},createLayer:function(name){return console.log("SyntaxDepricated: cop.createLayer(... use cop.create("),cop.create(name,!1)},layerObject:function(layer,object,defs){Object.isFunction(object.getName)&&(layer.layeredFunctionsList[object]={}),Object.keys(defs).forEach(function(function_name){cop.layerProperty(layer,object,function_name,defs)})},layerClass:function(layer,classObject,defs){if(!classObject||!classObject.prototype)throw new Error("ContextJS: can not refine class '"+classObject+"' in "+layer);cop.layerObject(layer,classObject.prototype,defs)},layerClassAndSubclasses:function(layer,classObject,defs){cop.layerClass(layer,classObject,defs),classObject.allSubclasses().forEach(function(eaClass){var obj=eaClass.prototype;Object.keys(defs).forEach(function(eaFunctionName){obj.hasOwnProperty(eaFunctionName)&&obj[eaFunctionName]instanceof Function&&cop.makeFunctionLayerAware(obj,eaFunctionName)})})},withLayers:function(layers,func){cop.LayerStack.push({withLayers:layers});try{return func()}finally{cop.LayerStack.pop()}},withoutLayers:function(layers,func){cop.LayerStack.push({withoutLayers:layers});try{return func()}finally{cop.LayerStack.pop()}},enableLayer:function(layer){cop.GlobalLayers.include(layer)||(cop.GlobalLayers.push(layer),cop.invalidateLayerComposition())},disableLayer:function(layer){var idx=cop.GlobalLayers.indexOf(layer);0>idx||(cop.GlobalLayers.removeAt(idx),cop.invalidateLayerComposition())},proceed:function(){var composition=cop.proceedStack.last();if(!composition)return console.log("ContextJS: no composition to proceed (stack is empty) "),void 0;void 0==composition.partialMethodIndex&&(composition.partialMethodIndex=composition.partialMethods.length-1);var index=composition.partialMethodIndex,partialMethod=composition.partialMethods[index];if(partialMethod){try{if(composition.partialMethodIndex=index-1,!Config.ignoredepricatedProceed&&partialMethod.toString().match(/^[\t ]*function ?\(\$?proceed/)){var args=$A(arguments);args.unshift(cop.proceed);var msg="proceed in arguments list in "+composition.functionName;if(Config.throwErrorOnDepricated)throw new Error("DEPRICATED ERROR: "+msg);Config.logDepricated&&console.log("DEPRICATED WARNING: "+msg);var result=partialMethod.apply(composition.object,args)}else var result=partialMethod.apply(composition.object,arguments)}finally{composition.partialMethodIndex=index}return result}if(!partialMethod)throw new COPError("no partialMethod to proceed")}});var markNamespaceEntryAsDepricated=function(newNamespace,newName,oldNamespace,oldName){oldNamespace[oldName]=newNamespace[newName].wrap(function(proceed){if(Config.throwErrorOnDepricated)throw new Error("DEPRICATED ERROR: "+oldName+" is depricated");Config.logDepricated&&console.log("DEPRICATED WARNING: "+oldName+" is depricated");var args=$A(arguments);return args.shift(),proceed.apply(this,args)})};markNamespaceEntryAsDepricated(cop,"enableLayer",Global,"enableLayer"),markNamespaceEntryAsDepricated(cop,"disableLayer",Global,"disableLayer"),markNamespaceEntryAsDepricated(cop,"withLayers",Global,"withLayers"),markNamespaceEntryAsDepricated(cop,"withoutLayers",Global,"withoutLayers"),markNamespaceEntryAsDepricated(cop,"createLayer",Global,"createLayer"),markNamespaceEntryAsDepricated(cop,"layerObject",Global,"layerObject"),markNamespaceEntryAsDepricated(cop,"layerClass",Global,"layerClass"),markNamespaceEntryAsDepricated(cop,"layerClassAndSubclasses",Global,"layerClassAndSubclasses"),Object.subclass("Layer","initializing",{initialize:function(name,namespaceName){this.name=name,this.namespaceName=namespaceName||"Global",this.layeredFunctionsList={},Global.lively&&lively.lang&&lively.Module&&(this.sourceModule=lively.Module.current())}},"accessing",{getName:function(){return this.name},fullName:function(){return this.namespaceName+"."+this.getName()},layeredObjects:function(){return Properties.own(this).collect(function(ea){return this[ea]&&this[ea]._layered_object},this).select(function(ea){return ea})},layeredClasses:function(){return this.layeredObjects().collect(function(ea){return ea.constructor}).select(function(ea){return lively.Class.isClass(ea)})}},"testing",{isGlobal:function(){return cop.GlobalLayers.include(this)}},"removing",{remove:function(){this.isGlobal()&&this.beNotGlobal();var ns=module(this.namespaceName);delete ns[this.name]},uninstall:function(){var layer=this;this.layeredObjects().each(function(eachLayeredObj){var layerIdx=Object.isFunction(eachLayeredObj.activeLayers)?eachLayeredObj.activeLayers().indexOf(layer):-1;Properties.own(layer.layeredFunctionsList[eachLayeredObj]).each(function(eachLayeredFunc){var newerLayer=eachLayeredObj.activeLayers().find(function(eachOtherLayer){var eachOtherLayerIdx=eachLayeredObj.activeLayers().indexOf(eachOtherLayer),isNewer=-1!==eachOtherLayerIdx&&layerIdx>eachOtherLayerIdx;return isNewer&&eachOtherLayer.layeredFunctionsList[eachLayeredObj][eachLayeredFunc]});newerLayer||cop.makeFunctionLayerUnaware(eachLayeredObj,eachLayeredFunc)})}),this.remove(),alertOK("Successfully uninstalled Layer "+this+" in Global Classes")}},"layer installation",{layerClass:function(classObj,methods){return cop.layerClass(this,classObj,methods),this},layerObject:function(obj,methods){return cop.layerObject(this,obj,methods),this},refineClass:function(classObj,methods){return cop.layerClass(this,classObj,methods),this},refineObject:function(obj,methods){return cop.layerObject(this,obj,methods),this},unrefineObject:function(obj){var id=obj._layer_object_id;void 0!==id&&delete this[id]},unrefineClass:function(classObj){this.unrefineObject(classObj.prototype)}},"layer activation",{beGlobal:function(){return cop.enableLayer(this),this},beNotGlobal:function(){return cop.disableLayer(this),this},hide:function(){return this.isHidden=!0,this}},"debugging",{toString:function(){return this.getName()}},"deprecated serialization",{toLiteral:function(){return this.name||console.warn("Layer: Can not serialize without a name!"),{name:this.name}}}),Object.extend(Layer,{fromLiteral:function(literal){return cop.create(literal.name,!1)}}),Object.extend(Global,{LayerableObjectTrait:{}}),Object.extend(LayerableObjectTrait,{activeLayers:function(){var result={withLayers:[],withoutLayers:[]};return this.dynamicLayers(result),this.structuralLayers(result),this.globalLayers(result),result.withLayers},collectWithLayersIn:function(layers,result){for(var i=0;i<layers.length;i++){var ea=layers[i];-1===result.withLayers.indexOf(ea)&&-1===result.withoutLayers.indexOf(ea)&&result.withLayers.unshift(ea)}},collectWithoutLayersIn:function(layers,result){for(var i=0;i<layers.length;i++){var ea=layers[i];-1===result.withoutLayers.indexOf(ea)&&result.withoutLayers.push(ea)}},dynamicLayers:function(result){for(var stack=cop.LayerStack,j=stack.length-1;j>0;j--){var current=stack[j];current.withLayers&&this.collectWithLayersIn(current.withLayers,result),current.withoutLayers&&this.collectWithoutLayersIn(current.withoutLayers,result)}return result},structuralLayers:function(result){for(var obj=(result.withLayers,result.withoutLayers,this);obj;)obj.withLayers&&this.collectWithLayersIn(obj.withLayers,result),obj.withoutLayers&&this.collectWithoutLayersIn(obj.withoutLayers,result),obj=obj.owner;return result},globalLayers:function(result){return this.collectWithLayersIn(cop.GlobalLayers,result),result},setWithLayers:function(layers){this.withLayers=layers},addWithLayer:function(layer){var layers=this.getWithLayers();layers.include(layer)||this.setWithLayers(layers.concat([layer]))},removeWithLayer:function(layer){var layers=this.getWithLayers();layers.include(layer)&&this.setWithLayers(layers.without(layer))},addWithoutLayer:function(layer){var layers=this.getWithoutLayers();layers.include(layer)||this.setWithoutLayers(layers.concat([layer]))},removeWithoutLayer:function(layer){var layers=this.getWithoutLayers();this.setWithoutLayers(layers.without(layer))},setWithoutLayers:function(layers){this.withoutLayers=layers},getWithLayers:function(){return this.withLayers||[]},getWithoutLayers:function(){return this.withoutLayers||[]}}),Object.subclass("LayerableObject",LayerableObjectTrait),Object.subclass("COPError",{initialize:function(msg){this.msg=msg},toString:function(){return"COP Error: "+this.msg}}),Object.subclass("cop.PartialLayerComposition",{initialize:function(obj,prototypeObject,functionName,baseFunction,methodType){this.partialMethods=[baseFunction];for(var layers=cop.computeLayersFor(obj),i=0;i<layers.length;i++){var layer=layers[i],partialMethod=cop.lookupLayeredFunctionForObject(obj,layer,functionName,methodType);partialMethod&&this.partialMethods.push(partialMethod)}this.object=obj,this.prototypeObject=prototypeObject,this.functionName=functionName}}),Object.extend(Function.prototype,{subclass:Object.subclass.wrap(function(proceed){var args=$A(arguments);args.shift();for(var layeredMethods=[],i=1;i<args.length;i++){var methods=args[i];Object.isString(methods)||Object.keys(methods).forEach(function(ea){var m=ea.match(/([A-Za-z0-9]+)\$([A-Za-z0-9]*)/);if(m){var getter=methods.__lookupGetter__(m[0]),setter=methods.__lookupSetter__(m[0]);layeredMethods.push({layerName:m[1],methodName:m[2],methodBody:methods[ea],getterMethod:getter,setterMethod:setter}),delete methods[ea]}})}var klass=proceed.apply(this,args);return layeredMethods.forEach(function(ea){var layer=Global[ea.layerName];if(!layer)throw new Error("could not find layer: "+ea.layerName);ea.getterMethod||ea.setterMethod?(ea.getterMethod&&cop.layerGetterMethod(layer,klass.prototype,ea.methodName,ea.getterMethod),ea.setterMethod&&cop.layerSetterMethod(layer,klass.prototype,ea.methodName,ea.setterMethod),cop.makePropertyLayerAware(klass.prototype,ea.methodName)):cop.layerMethod(layer,klass.prototype,ea.methodName,ea.methodBody)}),klass})}),cop.resetLayerStack(),cop.dynamicInlining&&module("cop.Flatten").load(!0)}),StringBuffer.prototype.nextPutAll=function(s){this.strings.push(s)},StringBuffer.prototype.contents=function(){return this.strings.join("")},String.prototype.writeStream=function(){return new StringBuffer(this)},printOn=function(x,ws){if(void 0===x||null===x)ws.nextPutAll(""+x);else if(x.constructor===Array){ws.nextPutAll("[");for(var idx=0;idx<x.length;idx++)idx>0&&ws.nextPutAll(", "),printOn(x[idx],ws);ws.nextPutAll("]")}else ws.nextPutAll(x.toString())},Array.prototype.ometaToString=function(){var ws="".writeStream();return printOn(this,ws),ws.contents()},objectThatDelegatesTo=function(x,props){var f=function(){};f.prototype=x;var r=new f;for(var p in props)props.hasOwnProperty(p)&&(r[p]=props[p]);return r},ownPropertyNames=function(x){var r=[];for(var name in x)x.hasOwnProperty(name)&&r.push(name);return r},isImmutable=function(x){return null===x||void 0===x||"boolean"==typeof x||"number"==typeof x||"string"==typeof x},String.prototype.digitValue=function(){return this.charCodeAt(0)-"0".charCodeAt(0)},isSequenceable=function(x){return"string"==typeof x||x.constructor===Array},Array.prototype.map=Array.prototype.map||function(f){for(var r=[],idx=0;idx<this.length;idx++)r[idx]=f(this[idx]);return r},Array.prototype.reduce=Array.prototype.reduce||function(f,z){for(var r=z,idx=0;idx<this.length;idx++)r=f(r,this[idx]);return r},Array.prototype.delimWith=function(d){return this.reduce(function(xs,x){return xs.length>0&&xs.push(d),xs.push(x),xs},[])},ReadStream.prototype.atEnd=function(){return this.pos>=this.src.length},ReadStream.prototype.next=function(){return this.src.at(this.pos++)},String.prototype.pad=function(s,len){for(var r=this;r.length<len;)r=s+r;return r},escapeStringFor=new Object;for(var c=0;128>c;c++)escapeStringFor[c]=String.fromCharCode(c);escapeStringFor["'".charCodeAt(0)]="\\'",escapeStringFor['"'.charCodeAt(0)]='\\"',escapeStringFor["\\".charCodeAt(0)]="\\\\",escapeStringFor["\b".charCodeAt(0)]="\\b",escapeStringFor["\f".charCodeAt(0)]="\\f",escapeStringFor["\n".charCodeAt(0)]="\\n",escapeStringFor["\r".charCodeAt(0)]="\\r",escapeStringFor["	".charCodeAt(0)]="\\t",escapeStringFor["".charCodeAt(0)]="\\v",escapeChar=function(c){var charCode=c.charCodeAt(0);return 128>charCode?escapeStringFor[charCode]:charCode>=128&&256>charCode?"\\x"+charCode.toString(16).pad("0",2):"\\u"+charCode.toString(16).pad("0",4)},String.prototype.toProgramString=function(){for(var ws='"'.writeStream(),idx=0;idx<this.length;idx++)ws.nextPutAll(escapeChar(this.charAt(idx)));return ws.nextPutAll('"'),ws.contents()},tempnam.n=0,getTag=function(){var numIdx=0;return function(x){if(null===x||void 0===x)return x;switch(typeof x){case"boolean":return 1==x?"Btrue":"Bfalse";case"string":return"S"+x;case"number":return"N"+x;default:return x.hasOwnProperty("_id_")?x._id_:x._id_="R"+numIdx++}}}(),fail={toString:function(){return"match failed"}},OMInputStream.prototype.head=function(){return this.hd},OMInputStream.prototype.tail=function(){return this.tl},OMInputStream.prototype.type=function(){return this.lst.constructor},OMInputStream.prototype.upTo=function(that){for(var r=[],curr=this;curr!=that;)r.push(curr.head()),curr=curr.tail();return this.type()==String?r.join(""):r},OMInputStreamEnd.prototype=objectThatDelegatesTo(OMInputStream.prototype),OMInputStreamEnd.prototype.head=function(){throw fail},OMInputStreamEnd.prototype.tail=function(){throw fail},Array.prototype.at=function(idx){return this[idx]},String.prototype.at=String.prototype.charAt,ListOMInputStream.prototype=objectThatDelegatesTo(OMInputStream.prototype),ListOMInputStream.prototype.head=function(){return this.hd},ListOMInputStream.prototype.tail=function(){return this.tl||(this.tl=makeListOMInputStream(this.lst,this.idx+1))},Array.prototype.toOMInputStream=function(){return makeListOMInputStream(this,0)},String.prototype.toOMInputStream=function(){return makeListOMInputStream(this,0)},Failer.prototype.used=!1,OMeta={_apply:function(rule){var memoRec=this.input.memo[rule];if(void 0==memoRec){var origInput=this.input,failer=new Failer;if(void 0===this[rule])throw'tried to apply undefined rule "'+rule+'"';if(this.input.memo[rule]=failer,this.input.memo[rule]=memoRec={ans:this[rule].call(this),nextInput:this.input},failer.used)for(var sentinel=this.input;;)try{this.input=origInput;var ans=this[rule].call(this);if(this.input==sentinel)throw fail;memoRec.ans=ans,memoRec.nextInput=this.input}catch(f){if(f!=fail)throw f;break}}else if(memoRec instanceof Failer)throw memoRec.used=!0,fail;return this.input=memoRec.nextInput,memoRec.ans},_applyWithArgs:function(rule){for(var ruleFn=this[rule],ruleFnArity=ruleFn.length,idx=arguments.length-1;idx>=ruleFnArity+1;idx--)this._prependInput(arguments[idx]);return 0==ruleFnArity?ruleFn.call(this):ruleFn.apply(this,Array.prototype.slice.call(arguments,1,ruleFnArity+1))},_superApplyWithArgs:function(recv,rule){for(var ruleFn=this[rule],ruleFnArity=ruleFn.length,idx=arguments.length-1;idx>ruleFnArity+2;idx--)recv._prependInput(arguments[idx]);return 0==ruleFnArity?ruleFn.call(recv):ruleFn.apply(recv,Array.prototype.slice.call(arguments,2,ruleFnArity+2))},_prependInput:function(v){this.input=new OMInputStream(v,this.input)},memoizeParameterizedRules:function(){this._prependInput=function(v){var newInput;isImmutable(v)?(newInput=this.input[getTag(v)],newInput||(newInput=new OMInputStream(v,this.input),this.input[getTag(v)]=newInput)):newInput=new OMInputStream(v,this.input),this.input=newInput},this._applyWithArgs=function(rule){for(var ruleFnArity=this[rule].length,idx=arguments.length-1;idx>=ruleFnArity+1;idx--)this._prependInput(arguments[idx]);return 0==ruleFnArity?this._apply(rule):this[rule].apply(this,Array.prototype.slice.call(arguments,1,ruleFnArity+1))
}},_pred:function(b){if(b)return!0;throw fail},_not:function(x){var origInput=this.input;try{x.call(this)}catch(f){if(f!=fail)throw f;return this.input=origInput,!0}throw fail},_lookahead:function(x){var origInput=this.input,r=x.call(this);return this.input=origInput,r},_or:function(){for(var origInput=this.input,idx=0;idx<arguments.length;idx++)try{return this.input=origInput,arguments[idx].call(this)}catch(f){if(f!=fail)throw f}throw fail},_xor:function(ruleName){for(var newInput,ans,origInput=this.input,idx=1;idx<arguments.length;){try{if(this.input=origInput,ans=arguments[idx].call(this),newInput)throw'more than one choice matched by "exclusive-OR" in '+ruleName;newInput=this.input}catch(f){if(f!=fail)throw f}idx++}if(newInput)return this.input=newInput,ans;throw fail},disableXORs:function(){this._xor=this._or},_opt:function(x){var ans,origInput=this.input;try{ans=x.call(this)}catch(f){if(f!=fail)throw f;this.input=origInput}return ans},_many:function(x){for(var ans=void 0!=arguments[1]?[arguments[1]]:[];;){var origInput=this.input;try{ans.push(x.call(this))}catch(f){if(f!=fail)throw f;this.input=origInput;break}}return ans},_many1:function(x){return this._many(x,x.call(this))},_form:function(x){var v=this._apply("anything");if(!isSequenceable(v))throw fail;var origInput=this.input;return this.input=v.toOMInputStream(),x.call(this),this._apply("end"),this.input=origInput,v},_consumedBy:function(x){var origInput=this.input;return x.call(this),origInput.upTo(this.input)},_idxConsumedBy:function(x){var origInput=this.input;return x.call(this),{fromIdx:origInput.idx,toIdx:this.input.idx}},_interleave:function(){for(var currInput=this.input,ans=[],idx=0;idx<arguments.length;idx+=2)ans[idx/2]="*"==arguments[idx]||"+"==arguments[idx]?[]:void 0;for(;;){for(var idx=0,allDone=!0;idx<arguments.length;){if("0"!=arguments[idx])try{switch(this.input=currInput,arguments[idx]){case"*":ans[idx/2].push(arguments[idx+1].call(this));break;case"+":ans[idx/2].push(arguments[idx+1].call(this)),arguments[idx]="*";break;case"?":ans[idx/2]=arguments[idx+1].call(this),arguments[idx]="0";break;case"1":ans[idx/2]=arguments[idx+1].call(this),arguments[idx]="0";break;default:throw"invalid mode '"+arguments[idx]+"' in OMeta._interleave"}currInput=this.input;break}catch(f){if(f!=fail)throw f;allDone=allDone&&("*"==arguments[idx]||"?"==arguments[idx])}idx+=2}if(idx==arguments.length){if(allDone)return ans;throw fail}}},_currIdx:function(){return this.input.idx},anything:function(){var r=this.input.head();return this.input=this.input.tail(),r},end:function(){return this._not(function(){return this._apply("anything")})},pos:function(){return this.input.idx},empty:function(){return!0},apply:function(r){return this._apply(r)},foreign:function(g,r){var gi=objectThatDelegatesTo(g,{input:makeOMInputStreamProxy(this.input)}),ans=gi._apply(r);return this.input=gi.input.target,ans},exactly:function(wanted){if(wanted===this._apply("anything"))return wanted;throw fail},"true":function(){var r=this._apply("anything");return this._pred(r===!0),r},"false":function(){var r=this._apply("anything");return this._pred(r===!1),r},undefined:function(){var r=this._apply("anything");return this._pred(void 0===r),r},number:function(){var r=this._apply("anything");return this._pred("number"==typeof r),r},string:function(){var r=this._apply("anything");return this._pred("string"==typeof r),r},"char":function(){var r=this._apply("anything");return this._pred("string"==typeof r&&1==r.length),r},space:function(){var r=this._apply("char"),code=r.charCodeAt(0);return this._pred(32>=code||160===code),r},spaces:function(){return this._many(function(){return this._apply("space")})},digit:function(){var r=this._apply("char");return this._pred(r>="0"&&"9">=r),r},lower:function(){var r=this._apply("char");return this._pred(r>="a"&&"z">=r),r},upper:function(){var r=this._apply("char");return this._pred(r>="A"&&"Z">=r),r},letter:function(){return this._or(function(){return this._apply("lower")},function(){return this._apply("upper")})},letterOrDigit:function(){return this._or(function(){return this._apply("letter")},function(){return this._apply("digit")})},firstAndRest:function(first,rest){return this._many(function(){return this._apply(rest)},this._apply(first))},seq:function(xs){for(var idx=0;idx<xs.length;idx++)this._applyWithArgs("exactly",xs.at(idx));return xs},notLast:function(rule){var r=this._apply(rule);return this._lookahead(function(){return this._apply(rule)}),r},listOf:function(rule,delim){return this._or(function(){var r=this._apply(rule);return this._many(function(){return this._applyWithArgs("token",delim),this._apply(rule)},r)},function(){return[]})},token:function(cs){return this._apply("spaces"),this._applyWithArgs("seq",cs)},fromTo:function(x,y){return this._consumedBy(function(){this._applyWithArgs("seq",x),this._many(function(){this._not(function(){this._applyWithArgs("seq",y)}),this._apply("char")}),this._applyWithArgs("seq",y)})},initialize:function(){},_genericMatch:function(input,rule,args,matchFailed){void 0==args&&(args=[]);for(var realArgs=[rule],idx=0;idx<args.length;idx++)realArgs.push(args[idx]);var m=objectThatDelegatesTo(this,{input:input});m.initialize();try{return 1==realArgs.length?m._apply.call(m,realArgs[0]):m._applyWithArgs.apply(m,realArgs)}catch(f){if(f==fail&&void 0!=matchFailed){var input=m.input;if(void 0!=input.idx){for(;void 0!=input.tl&&void 0!=input.tl.idx;)input=input.tl;input.idx--}return matchFailed(m,input.idx)}throw f}},match:function(obj,rule,args,matchFailed){var toString=Array.prototype.toString;Array.prototype.toString=Array.prototype.ometaToString;try{return this._genericMatch([obj].toOMInputStream(),rule,args,matchFailed)}finally{Array.prototype.toString=toString}},matchAll:function(listyObj,rule,args,matchFailed){var toString=Array.prototype.toString;Array.prototype.toString=Array.prototype.ometaToString;try{return this._genericMatch(listyObj.toOMInputStream(),rule,args,matchFailed)}finally{Array.prototype.toString=toString}},createInstance:function(){var m=objectThatDelegatesTo(this);return m.initialize(),m.matchAll=function(listyObj,aRule){return this.input=listyObj.toOMInputStream(),this._apply(aRule)},m}},Parser=objectThatDelegatesTo(OMeta,{}),Global.ChunkParser={start:function(ometaParser,chunkStart,chunkEnd){this.ometaParser=ometaParser,this.isString=chunkStart===chunkEnd&&("'"===chunkStart||'"'===chunkStart),this.chunkStart=chunkStart,this.chunkEnd=chunkEnd,this.chunkEndFound=!1,this.next=null,this.counter=0,this.result=[],this.parseStart();do this.makeStep();while(!this.parseRest());return this.result},parseStart:function(){this.result.push(this.ometaParser._applyWithArgs("exactly",this.chunkStart))},makeStep:function(){return this.next=this.ometaParser._apply("anything"),this.result.push(this.next),this.nextNext=this.ometaParser.input.hd,this.next},backup:function(){this.backupRecorded=!0,this.backupInput=this.ometaParser.input,this.backupNext=this.next,this.backupNextNext=this.nextNext,this.backupCounter=this.counter,this.backupResult=this.result},useBackup:function(){if(!this.backupRecorded)throw dbgOn(new Error("Using Chunk parser backup but did not record it!"));this.ometaParser.input=this.backupInput,this.next=this.backupNext,this.nextNext=this.backupNextNext,this.counter=this.backupCounter,this.result=this.backupResult},parseEscapedChar:function(){for(;"\\"===this.next;)this.makeStep(),this.makeStep()},parseComment:function(){if("/"!==this.next)return!1;var comment1Opened="/"===this.nextNext,comment2Opened="*"===this.nextNext;if(comment1Opened||comment2Opened)for(this.makeStep(),this.makeStep();;){if(this.parseEscapedChar(),comment1Opened&&("\n"===this.next||"\r"===this.next))return;if(comment2Opened&&"*"===this.next&&"/"===this.nextNext&&this.makeStep())return;this.makeStep()}},parseString:function(){var string1Opened,string2Opened;if("'"!==this.chunkStart&&'"'!==this.chunkStart&&("'"===this.next&&(string1Opened=!0),'"'===this.next&&(string2Opened=!0),string1Opened||string2Opened))for(this.makeStep();;){if(this.parseEscapedChar(),string1Opened&&"'"===this.next)return;if(string2Opened&&'"'===this.next)return;this.makeStep()}},parseRegex:function(){var regexOpen="/"===this.next&&"*"!==this.nextNext&&"/"!==this.nextNext;if(regexOpen)for(this.backup(),this.makeStep();;){if(this.parseEscapedChar(),"\n"===this.next||"\r"===this.next)return this.useBackup(),void 0;if("/"===this.next)return;this.makeStep()}},parseRest:function(){return this.parseEscapedChar(),this.isString||(this.parseRegex(),this.parseString(),this.parseComment()),this.next===this.chunkEnd&&0===this.counter?!0:this.next===this.chunkEnd?(this.counter--,!1):(this.next===this.chunkStart&&this.counter++,!1)}},OMeta.basicChunk=function(){var chunkStart=this._apply("anything"),chunkEnd=this._apply("anything");return this.chunkParser||(this.chunkParser=objectThatDelegatesTo(ChunkParser,{})),this.chunkParser.start(this,chunkStart,chunkEnd)},BSOMetaParser=objectThatDelegatesTo(OMeta,{space:function(){return this.input.idx,this._or(function(){return OMeta._superApplyWithArgs(this,"space")},function(){return this._applyWithArgs("fromTo","//","\n")},function(){return this._applyWithArgs("fromTo","/*","*/")})},nameFirst:function(){return this.input.idx,this._or(function(){return function(){switch(this._apply("anything")){case"_":return"_";case"$":return"$";default:throw fail}}.call(this)},function(){return this._apply("letter")})},nameRest:function(){return this.input.idx,this._or(function(){return this._apply("nameFirst")},function(){return this._apply("digit")})},tsName:function(){return this.input.idx,this._consumedBy(function(){return function(){return this._apply("nameFirst"),this._many(function(){return this._apply("nameRest")})}.call(this)})},name:function(){return this.input.idx,function(){return this._apply("spaces"),this._apply("tsName")}.call(this)},hexDigit:function(){var x,v;return this.input.idx,function(){return x=this._apply("char"),v=this.hexDigits.indexOf(x.toLowerCase()),this._pred(v>=0),v}.call(this)},eChar:function(){var s;return this.input.idx,this._or(function(){return function(){return s=this._consumedBy(function(){return function(){return this._applyWithArgs("exactly","\\"),this._or(function(){return function(){switch(this._apply("anything")){case"u":return function(){return this._apply("hexDigit"),this._apply("hexDigit"),this._apply("hexDigit"),this._apply("hexDigit")}.call(this);case"x":return function(){return this._apply("hexDigit"),this._apply("hexDigit")}.call(this);default:throw fail}}.call(this)},function(){return this._apply("char")})}.call(this)}),unescape(s)}.call(this)},function(){return this._apply("char")})},tsString:function(){var xs;return this.input.idx,function(){return this._applyWithArgs("exactly","'"),xs=this._many(function(){return function(){return this._not(function(){return this._applyWithArgs("exactly","'")}),this._apply("eChar")}.call(this)}),this._applyWithArgs("exactly","'"),xs.join("")}.call(this)},characters:function(){var xs;return this.input.idx,function(){return this._applyWithArgs("exactly","`"),this._applyWithArgs("exactly","`"),xs=this._many(function(){return function(){return this._not(function(){return function(){return this._applyWithArgs("exactly","'"),this._applyWithArgs("exactly","'")}.call(this)}),this._apply("eChar")}.call(this)}),this._applyWithArgs("exactly","'"),this._applyWithArgs("exactly","'"),["App","seq",xs.join("").toProgramString()]}.call(this)},sCharacters:function(){var xs;return this.input.idx,function(){return this._applyWithArgs("exactly",'"'),xs=this._many(function(){return function(){return this._not(function(){return this._applyWithArgs("exactly",'"')}),this._apply("eChar")}.call(this)}),this._applyWithArgs("exactly",'"'),["App","token",xs.join("").toProgramString()]}.call(this)},string:function(){var xs;return this.input.idx,function(){return xs=this._or(function(){return function(){return function(){switch(this._apply("anything")){case"#":return"#";case"`":return"`";default:throw fail}}.call(this),this._apply("tsName")}.call(this)},function(){return this._apply("tsString")}),["App","exactly",xs.toProgramString()]}.call(this)},number:function(){var n;return this.input.idx,function(){return n=this._consumedBy(function(){return function(){return this._opt(function(){return this._applyWithArgs("exactly","-")}),this._many1(function(){return this._apply("digit")})}.call(this)}),["App","exactly",n]}.call(this)},keyword:function(){var xs;return this.input.idx,function(){return xs=this._apply("anything"),this._applyWithArgs("token",xs),this._not(function(){return this._apply("letterOrDigit")}),xs}.call(this)},args:function(){var xs;return this.input.idx,this._or(function(){return function(){switch(this._apply("anything")){case"(":return function(){return xs=this._applyWithArgs("listOf","hostExpr",","),this._applyWithArgs("token",")"),xs}.call(this);default:throw fail}}.call(this)},function(){return function(){return this._apply("empty"),[]}.call(this)})},application:function(){var rule,as,grm;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token","^"),rule=this._apply("name"),as=this._apply("args"),["App","super","'"+rule+"'"].concat(as)}.call(this)},function(){return function(){return grm=this._apply("name"),this._applyWithArgs("token","."),rule=this._apply("name"),as=this._apply("args"),["App","foreign",grm,"'"+rule+"'"].concat(as)}.call(this)},function(){return function(){return rule=this._apply("name"),as=this._apply("args"),["App",rule].concat(as)}.call(this)})},hostExpr:function(){var r;return this.input.idx,function(){return r=this._applyWithArgs("foreign",BSSemActionParser,"expr"),this._applyWithArgs("foreign",BSJSTranslator,"trans",r)}.call(this)},curlyHostExpr:function(){var r;return this.input.idx,function(){return r=this._applyWithArgs("foreign",BSSemActionParser,"curlySemAction"),this._applyWithArgs("foreign",BSJSTranslator,"trans",r)}.call(this)},primHostExpr:function(){var r;return this.input.idx,function(){return r=this._applyWithArgs("foreign",BSSemActionParser,"semAction"),this._applyWithArgs("foreign",BSJSTranslator,"trans",r)}.call(this)},atomicHostExpr:function(){return this.input.idx,this._or(function(){return this._apply("curlyHostExpr")},function(){return this._apply("primHostExpr")})},semAction:function(){var x;return this.input.idx,this._or(function(){return function(){return x=this._apply("curlyHostExpr"),["Act",x]}.call(this)},function(){return function(){return this._applyWithArgs("token","!"),x=this._apply("atomicHostExpr"),["Act",x]}.call(this)})},arrSemAction:function(){var x;return this.input.idx,function(){return this._applyWithArgs("token","->"),x=this._apply("atomicHostExpr"),["Act",x]}.call(this)},semPred:function(){var x;return this.input.idx,function(){return this._applyWithArgs("token","?"),x=this._apply("atomicHostExpr"),["Pred",x]}.call(this)},expr:function(){var x,xs;return this.input.idx,this._or(function(){return function(){return x=this._applyWithArgs("expr5",!0),xs=this._many1(function(){return function(){return this._applyWithArgs("token","|"),this._applyWithArgs("expr5",!0)}.call(this)}),["Or",x].concat(xs)}.call(this)},function(){return function(){return x=this._applyWithArgs("expr5",!0),xs=this._many1(function(){return function(){return this._applyWithArgs("token","||"),this._applyWithArgs("expr5",!0)}.call(this)}),["XOr",x].concat(xs)}.call(this)},function(){return this._applyWithArgs("expr5",!1)})},expr5:function(){var ne,x,xs;return this.input.idx,function(){return ne=this._apply("anything"),this._or(function(){return function(){return x=this._apply("interleavePart"),xs=this._many1(function(){return function(){return this._applyWithArgs("token","&&"),this._apply("interleavePart")}.call(this)}),["Interleave",x].concat(xs)}.call(this)},function(){return this._applyWithArgs("expr4",ne)})}.call(this)},interleavePart:function(){var part;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token","("),part=this._applyWithArgs("expr4",!0),this._applyWithArgs("token",")"),["1",part]}.call(this)},function(){return function(){return part=this._applyWithArgs("expr4",!0),this._applyWithArgs("modedIPart",part)}.call(this)})},modedIPart:function(){var part;return this.input.idx,this._or(function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","And"),this._form(function(){return function(){return this._applyWithArgs("exactly","Many"),part=this._apply("anything")}.call(this)})}.call(this)}),["*",part]}.call(this)},function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","And"),this._form(function(){return function(){return this._applyWithArgs("exactly","Many1"),part=this._apply("anything")}.call(this)})}.call(this)}),["+",part]}.call(this)},function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","And"),this._form(function(){return function(){return this._applyWithArgs("exactly","Opt"),part=this._apply("anything")}.call(this)})}.call(this)}),["?",part]}.call(this)},function(){return function(){return part=this._apply("anything"),["1",part]}.call(this)})},expr4:function(){var ne,xs,act;return this.input.idx,function(){return ne=this._apply("anything"),this._or(function(){return function(){return xs=this._many(function(){return this._apply("expr3")}),act=this._apply("arrSemAction"),["And"].concat(xs).concat([act])}.call(this)},function(){return function(){return this._pred(ne),xs=this._many1(function(){return this._apply("expr3")}),["And"].concat(xs)}.call(this)},function(){return function(){return this._pred(0==ne),xs=this._many(function(){return this._apply("expr3")}),["And"].concat(xs)}.call(this)})}.call(this)},optIter:function(){var x;return this.input.idx,function(){return x=this._apply("anything"),this._or(function(){return function(){switch(this._apply("anything")){case"*":return["Many",x];case"+":return["Many1",x];case"?":return["Opt",x];default:throw fail}}.call(this)},function(){return function(){return this._apply("empty"),x}.call(this)})}.call(this)},optBind:function(){var x,n;return this.input.idx,function(){return x=this._apply("anything"),this._or(function(){return function(){switch(this._apply("anything")){case":":return function(){return n=this._apply("name"),function(){return this.locals[n]=!0,["Set",n,x]}.call(this)}.call(this);default:throw fail}}.call(this)},function(){return function(){return this._apply("empty"),x}.call(this)})}.call(this)},expr3:function(){var n,x,e;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token",":"),n=this._apply("name"),function(){return this.locals[n]=!0,["Set",n,["App","anything"]]}.call(this)}.call(this)},function(){return function(){return e=this._or(function(){return function(){return x=this._apply("expr2"),this._applyWithArgs("optIter",x)}.call(this)},function(){return this._apply("semAction")}),this._applyWithArgs("optBind",e)}.call(this)},function(){return this._apply("semPred")})},expr2:function(){var x;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token","~"),x=this._apply("expr2"),["Not",x]}.call(this)},function(){return function(){return this._applyWithArgs("token","&"),x=this._apply("expr1"),["Lookahead",x]}.call(this)},function(){return this._apply("expr1")})},expr1:function(){var x;return this.input.idx,this._or(function(){return this._apply("application")},function(){return function(){return x=this._or(function(){return this._applyWithArgs("keyword","undefined")},function(){return this._applyWithArgs("keyword","nil")},function(){return this._applyWithArgs("keyword","true")},function(){return this._applyWithArgs("keyword","false")}),["App","exactly",x]}.call(this)},function(){return function(){return this._apply("spaces"),this._or(function(){return this._apply("characters")},function(){return this._apply("sCharacters")},function(){return this._apply("string")},function(){return this._apply("number")})}.call(this)},function(){return function(){return this._applyWithArgs("token","["),x=this._apply("expr"),this._applyWithArgs("token","]"),["Form",x]}.call(this)},function(){return function(){return this._applyWithArgs("token","<"),x=this._apply("expr"),this._applyWithArgs("token",">"),["ConsBy",x]}.call(this)},function(){return function(){return this._applyWithArgs("token","@<"),x=this._apply("expr"),this._applyWithArgs("token",">"),["IdxConsBy",x]}.call(this)},function(){return function(){return this._applyWithArgs("token","("),x=this._apply("expr"),this._applyWithArgs("token",")"),x}.call(this)})},ruleName:function(){return this.input.idx,this._or(function(){return this._apply("name")},function(){return function(){return this._apply("spaces"),this._apply("tsString")}.call(this)})},rule:function(){var n,x,xs;return this.input.idx,function(){return this._lookahead(function(){return n=this._apply("ruleName")}),this.locals={"$elf=this":!0,"_fromIdx=this.input.idx":!0},x=this._applyWithArgs("rulePart",n),xs=this._many(function(){return function(){return this._applyWithArgs("token",","),this._applyWithArgs("rulePart",n)}.call(this)}),["Rule",n,ownPropertyNames(this.locals),["Or",x].concat(xs)]}.call(this)},rulePart:function(){var rn,n,b1,b2;return this.input.idx,function(){return rn=this._apply("anything"),n=this._apply("ruleName"),this._pred(n==rn),b1=this._applyWithArgs("expr4",!1),this._or(function(){return function(){return this._applyWithArgs("token","="),b2=this._apply("expr"),["And",b1,b2]}.call(this)},function(){return function(){return this._apply("empty"),b1}.call(this)})}.call(this)},grammar:function(){var n,sn,rs;return this.input.idx,function(){return this._applyWithArgs("keyword","ometa"),n=this._apply("name"),sn=this._or(function(){return function(){return this._applyWithArgs("token","<:"),this._apply("name")}.call(this)},function(){return function(){return this._apply("empty"),"OMeta"}.call(this)}),this._applyWithArgs("token","{"),rs=this._applyWithArgs("listOf","rule",","),this._applyWithArgs("token","}"),this._applyWithArgs("foreign",BSOMetaOptimizer,"optimizeGrammar",["Grammar",n,sn].concat(rs))}.call(this)}}),BSOMetaParser.hexDigits="0123456789abcdef",BSOMetaTranslator=objectThatDelegatesTo(OMeta,{App:function(){var args,rule;return this.input.idx,this._or(function(){return function(){switch(this._apply("anything")){case"super":return function(){return args=this._many1(function(){return this._apply("anything")}),[this.sName,"._superApplyWithArgs(this,",args.join(","),")"].join("")}.call(this);default:throw fail}}.call(this)},function(){return function(){return rule=this._apply("anything"),args=this._many1(function(){return this._apply("anything")}),['this._applyWithArgs("',rule,'",',args.join(","),")"].join("")}.call(this)},function(){return function(){return rule=this._apply("anything"),['this._apply("',rule,'")'].join("")}.call(this)})},Act:function(){var expr;return this.input.idx,function(){return expr=this._apply("anything")}.call(this)},Pred:function(){var expr;return this.input.idx,function(){return expr=this._apply("anything"),["this._pred(",expr,")"].join("")}.call(this)},Or:function(){var xs;return this.input.idx,function(){return xs=this._many(function(){return this._apply("transFn")}),["this._or(",xs.join(","),")"].join("")}.call(this)},XOr:function(){var xs;return this.input.idx,function(){return xs=this._many(function(){return this._apply("transFn")}),xs.unshift((this.name+"."+this.rName).toProgramString()),["this._xor(",xs.join(","),")"].join("")}.call(this)},And:function(){var xs,y;return this.input.idx,this._or(function(){return function(){return xs=this._many(function(){return this._applyWithArgs("notLast","trans")}),y=this._apply("trans"),xs.push("return "+y),["(function(){",xs.join(";"),"}).call(this)"].join("")}.call(this)},function(){return"undefined"})},Opt:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._opt(",x,")"].join("")}.call(this)},Many:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._many(",x,")"].join("")}.call(this)},Many1:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._many1(",x,")"].join("")}.call(this)},Set:function(){var n,v;return this.input.idx,function(){return n=this._apply("anything"),v=this._apply("trans"),[n,"=",v].join("")}.call(this)},Not:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._not(",x,")"].join("")}.call(this)},Lookahead:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._lookahead(",x,")"].join("")}.call(this)},Form:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._form(",x,")"].join("")}.call(this)},ConsBy:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._consumedBy(",x,")"].join("")}.call(this)},IdxConsBy:function(){var x;return this.input.idx,function(){return x=this._apply("transFn"),["this._idxConsumedBy(",x,")"].join("")}.call(this)},JumpTable:function(){var cases;return this.input.idx,function(){return cases=this._many(function(){return this._apply("jtCase")}),this.jumpTableCode(cases)}.call(this)},Interleave:function(){var xs;return this.input.idx,function(){return xs=this._many(function(){return this._apply("intPart")}),["this._interleave(",xs.join(","),")"].join("")}.call(this)},Rule:function(){var name,ls,body;return this.input.idx,function(){return name=this._apply("anything"),this.rName=name,ls=this._apply("locals"),body=this._apply("trans"),['\n"',name,'":function(){',ls,"return ",body,"}"].join("")}.call(this)},Grammar:function(){var name,sName,rules;return this.input.idx,function(){return name=this._apply("anything"),sName=this._apply("anything"),this.name=name,this.sName=sName,rules=this._many(function(){return this._apply("trans")}),[name,"=objectThatDelegatesTo(",sName,",{",rules.join(","),"})"].join("")}.call(this)},intPart:function(){var mode,part;return this.input.idx,function(){return this._form(function(){return function(){return mode=this._apply("anything"),part=this._apply("transFn")}.call(this)}),mode.toProgramString()+","+part}.call(this)},jtCase:function(){var x,e;return this.input.idx,function(){return this._form(function(){return function(){return x=this._apply("anything"),e=this._apply("trans")}.call(this)}),[x.toProgramString(),e]}.call(this)},locals:function(){var vs;return this.input.idx,this._or(function(){return function(){return this._form(function(){return vs=this._many1(function(){return this._apply("string")})}),["var ",vs.join(","),";"].join("")}.call(this)},function(){return function(){return this._form(function(){return void 0}),""}.call(this)})},trans:function(){var t,ans;return this.input.idx,function(){return this._form(function(){return function(){return t=this._apply("anything"),ans=this._applyWithArgs("apply",t)}.call(this)}),ans}.call(this)},transFn:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["(function(){return ",x,"})"].join("")}.call(this)}}),BSOMetaTranslator.jumpTableCode=function(cases){var buf=new StringBuffer;buf.nextPutAll("(function(){switch(this._apply('anything')){");for(var i=0;i<cases.length;i+=1)buf.nextPutAll("case "+cases[i][0]+":return "+cases[i][1]+";");return buf.nextPutAll("default: throw fail}}).call(this)"),buf.contents()},BSJSParser=objectThatDelegatesTo(OMeta,{space:function(){return this.input.idx,this._or(function(){return OMeta._superApplyWithArgs(this,"space")},function(){return this._applyWithArgs("fromTo","//","\n")},function(){return this._applyWithArgs("fromTo","/*","*/")})},nameFirst:function(){return this.input.idx,this._or(function(){return this._apply("letter")},function(){return function(){switch(this._apply("anything")){case"$":return"$";case"_":return"_";default:throw fail}}.call(this)})},nameRest:function(){return this.input.idx,this._or(function(){return this._apply("nameFirst")},function(){return this._apply("digit")})},iName:function(){return this.input.idx,this._consumedBy(function(){return function(){return this._apply("nameFirst"),this._many(function(){return this._apply("nameRest")})}.call(this)})},isKeyword:function(){var x;return this.input.idx,function(){return x=this._apply("anything"),this._pred(BSJSParser._isKeyword(x))}.call(this)},name:function(){var n;return this.input.idx,function(){return n=this._apply("iName"),this._not(function(){return this._applyWithArgs("isKeyword",n)}),["name","self"==n?"$elf":n]}.call(this)},keyword:function(){var k;return this.input.idx,function(){return k=this._apply("iName"),this._applyWithArgs("isKeyword",k),[k,k]}.call(this)},hexDigit:function(){var x,v;return this.input.idx,function(){return x=this._apply("char"),v=this.hexDigits.indexOf(x.toLowerCase()),this._pred(v>=0),v}.call(this)},hexLit:function(){var n,d;return this.input.idx,this._or(function(){return function(){return n=this._apply("hexLit"),d=this._apply("hexDigit"),16*n+d}.call(this)},function(){return this._apply("hexDigit")})},number:function(){var n,f;return this.input.idx,this._or(function(){return function(){switch(this._apply("anything")){case"0":return function(){return this._applyWithArgs("exactly","x"),n=this._apply("hexLit"),["number",n]}.call(this);default:throw fail}}.call(this)},function(){return function(){return f=this._consumedBy(function(){return function(){return this._many1(function(){return this._apply("digit")}),this._opt(function(){return function(){return this._applyWithArgs("exactly","."),this._many1(function(){return this._apply("digit")})}.call(this)})}.call(this)}),["number",parseFloat(f)]}.call(this)})},escapeChar:function(){var s;return this.input.idx,function(){return s=this._consumedBy(function(){return function(){return this._applyWithArgs("exactly","\\"),this._or(function(){return function(){switch(this._apply("anything")){case"u":return function(){return this._apply("hexDigit"),this._apply("hexDigit"),this._apply("hexDigit"),this._apply("hexDigit")}.call(this);case"x":return function(){return this._apply("hexDigit"),this._apply("hexDigit")}.call(this);default:throw fail}}.call(this)},function(){return this._apply("char")})}.call(this)}),unescape(s)}.call(this)},str:function(){var cs,n;return this.input.idx,this._or(function(){return function(){switch(this._apply("anything")){case'"':return this._or(function(){return function(){switch(this._apply("anything")){case'"':return function(){return this._applyWithArgs("exactly",'"'),cs=this._many(function(){return function(){return this._not(function(){return function(){return this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),'"""'}.call(this)}),this._apply("char")}.call(this)}),this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),["string",cs.join("")]}.call(this);default:throw fail}}.call(this)},function(){return function(){return cs=this._many(function(){return this._or(function(){return this._apply("escapeChar")},function(){return function(){return this._not(function(){return this._applyWithArgs("exactly",'"')}),this._apply("char")}.call(this)})}),this._applyWithArgs("exactly",'"'),["string",cs.join("")]}.call(this)});case"'":return function(){return cs=this._many(function(){return this._or(function(){return this._apply("escapeChar")},function(){return function(){return this._not(function(){return this._applyWithArgs("exactly","'")}),this._apply("char")}.call(this)})}),this._applyWithArgs("exactly","'"),["string",cs.join("")]}.call(this);default:throw fail}}.call(this)},function(){return function(){return function(){switch(this._apply("anything")){case"#":return"#";case"`":return"`";default:throw fail}}.call(this),n=this._apply("iName"),["string",n]}.call(this)
})},special:function(){var s;return this.input.idx,function(){return s=function(){switch(this._apply("anything")){case"(":return"(";case")":return")";case"{":return"{";case"}":return"}";case"[":return"[";case"]":return"]";case",":return",";case";":return";";case"?":return"?";case":":return":";case"!":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"!==";default:throw fail}}.call(this)},function(){return"!="});default:throw fail}}.call(this)},function(){return"!"});case"=":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"===";default:throw fail}}.call(this)},function(){return"=="});default:throw fail}}.call(this)},function(){return"="});case">":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return">=";default:throw fail}}.call(this)},function(){return">"});case"<":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"<=";default:throw fail}}.call(this)},function(){return"<"});case"+":return this._or(function(){return function(){switch(this._apply("anything")){case"+":return"++";case"=":return"+=";default:throw fail}}.call(this)},function(){return"+"});case"-":return this._or(function(){return function(){switch(this._apply("anything")){case"-":return"--";case"=":return"-=";default:throw fail}}.call(this)},function(){return"-"});case"*":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"*=";default:throw fail}}.call(this)},function(){return"*"});case"/":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"/=";default:throw fail}}.call(this)},function(){return"/"});case"%":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"%=";default:throw fail}}.call(this)},function(){return"%"});case"&":return function(){switch(this._apply("anything")){case"&":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"&&=";default:throw fail}}.call(this)},function(){return"&&"});default:throw fail}}.call(this);case"|":return function(){switch(this._apply("anything")){case"|":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"||=";default:throw fail}}.call(this)},function(){return"||"});default:throw fail}}.call(this);case".":return".";default:throw fail}}.call(this),[s,s]}.call(this)},tok:function(){return this.input.idx,function(){return this._apply("spaces"),this._or(function(){return this._apply("name")},function(){return this._apply("keyword")},function(){return this._apply("number")},function(){return this._apply("str")},function(){return this._apply("special")})}.call(this)},toks:function(){var ts;return this.input.idx,function(){return ts=this._many(function(){return this._apply("token")}),this._apply("spaces"),this._apply("end"),ts}.call(this)},token:function(){var tt,t;return this.input.idx,function(){return tt=this._apply("anything"),t=this._apply("tok"),this._pred(t[0]==tt),t[1]}.call(this)},spacesNoNl:function(){return this.input.idx,this._many(function(){return function(){return this._not(function(){return this._applyWithArgs("exactly","\n")}),this._apply("space")}.call(this)})},expr:function(){var e,t,f,rhs;return this.input.idx,function(){return e=this._apply("orExpr"),this._or(function(){return function(){return this._applyWithArgs("token","?"),t=this._apply("expr"),this._applyWithArgs("token",":"),f=this._apply("expr"),["condExpr",e,t,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","="),rhs=this._apply("expr"),["set",e,rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","+="),rhs=this._apply("expr"),["mset",e,"+",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","-="),rhs=this._apply("expr"),["mset",e,"-",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","*="),rhs=this._apply("expr"),["mset",e,"*",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","/="),rhs=this._apply("expr"),["mset",e,"/",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","%="),rhs=this._apply("expr"),["mset",e,"%",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","&&="),rhs=this._apply("expr"),["mset",e,"&&",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","||="),rhs=this._apply("expr"),["mset",e,"||",rhs]}.call(this)},function(){return function(){return this._apply("empty"),e}.call(this)})}.call(this)},orExpr:function(){var x,y;return this.input.idx,this._or(function(){return function(){return x=this._apply("orExpr"),this._applyWithArgs("token","||"),y=this._apply("andExpr"),["binop","||",x,y]}.call(this)},function(){return this._apply("andExpr")})},andExpr:function(){var x,y;return this.input.idx,this._or(function(){return function(){return x=this._apply("andExpr"),this._applyWithArgs("token","&&"),y=this._apply("eqExpr"),["binop","&&",x,y]}.call(this)},function(){return this._apply("eqExpr")})},eqExpr:function(){var x,y;return this.input.idx,this._or(function(){return function(){return x=this._apply("eqExpr"),this._or(function(){return function(){return this._applyWithArgs("token","=="),y=this._apply("relExpr"),["binop","==",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","!="),y=this._apply("relExpr"),["binop","!=",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","==="),y=this._apply("relExpr"),["binop","===",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","!=="),y=this._apply("relExpr"),["binop","!==",x,y]}.call(this)})}.call(this)},function(){return this._apply("relExpr")})},relExpr:function(){var x,y;return this.input.idx,this._or(function(){return function(){return x=this._apply("relExpr"),this._or(function(){return function(){return this._applyWithArgs("token",">"),y=this._apply("addExpr"),["binop",">",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token",">="),y=this._apply("addExpr"),["binop",">=",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","<"),y=this._apply("addExpr"),["binop","<",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","<="),y=this._apply("addExpr"),["binop","<=",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","instanceof"),y=this._apply("addExpr"),["binop","instanceof",x,y]}.call(this)})}.call(this)},function(){return this._apply("addExpr")})},addExpr:function(){var x,y;return this.input.idx,this._or(function(){return function(){return x=this._apply("addExpr"),this._applyWithArgs("token","+"),y=this._apply("mulExpr"),["binop","+",x,y]}.call(this)},function(){return function(){return x=this._apply("addExpr"),this._applyWithArgs("token","-"),y=this._apply("mulExpr"),["binop","-",x,y]}.call(this)},function(){return this._apply("mulExpr")})},mulExpr:function(){var x,y;return this.input.idx,this._or(function(){return function(){return x=this._apply("mulExpr"),this._applyWithArgs("token","*"),y=this._apply("unary"),["binop","*",x,y]}.call(this)},function(){return function(){return x=this._apply("mulExpr"),this._applyWithArgs("token","/"),y=this._apply("unary"),["binop","/",x,y]}.call(this)},function(){return function(){return x=this._apply("mulExpr"),this._applyWithArgs("token","%"),y=this._apply("unary"),["binop","%",x,y]}.call(this)},function(){return this._apply("unary")})},unary:function(){var p;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token","-"),p=this._apply("postfix"),["unop","-",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","+"),p=this._apply("postfix"),["unop","+",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","++"),p=this._apply("postfix"),["preop","++",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","--"),p=this._apply("postfix"),["preop","--",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","!"),p=this._apply("unary"),["unop","!",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","void"),p=this._apply("unary"),["unop","void",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","delete"),p=this._apply("unary"),["unop","delete",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","typeof"),p=this._apply("unary"),["unop","typeof",p]}.call(this)},function(){return this._apply("postfix")})},postfix:function(){var p;return this.input.idx,function(){return p=this._apply("primExpr"),this._or(function(){return function(){return this._apply("spacesNoNl"),this._applyWithArgs("token","++"),["postop","++",p]}.call(this)},function(){return function(){return this._apply("spacesNoNl"),this._applyWithArgs("token","--"),["postop","--",p]}.call(this)},function(){return function(){return this._apply("empty"),p}.call(this)})}.call(this)},primExpr:function(){var p,i,m,as,f;return this.input.idx,this._or(function(){return function(){return p=this._apply("primExpr"),this._or(function(){return function(){return this._applyWithArgs("token","["),i=this._apply("expr"),this._applyWithArgs("token","]"),["getp",i,p]}.call(this)},function(){return function(){return this._applyWithArgs("token","."),m=this._applyWithArgs("token","name"),this._applyWithArgs("token","("),as=this._applyWithArgs("listOf","expr",","),this._applyWithArgs("token",")"),["send",m,p].concat(as)}.call(this)},function(){return function(){return this._applyWithArgs("token","."),f=this._applyWithArgs("token","name"),["getp",["string",f],p]}.call(this)},function(){return function(){return this._applyWithArgs("token","("),as=this._applyWithArgs("listOf","expr",","),this._applyWithArgs("token",")"),["call",p].concat(as)}.call(this)})}.call(this)},function(){return this._apply("primExprHd")})},primExprHd:function(){var e,n,s,as,es;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token","("),e=this._apply("expr"),this._applyWithArgs("token",")"),e}.call(this)},function(){return function(){return this._applyWithArgs("token","this"),["this"]}.call(this)},function(){return function(){return n=this._applyWithArgs("token","name"),["get",n]}.call(this)},function(){return function(){return n=this._applyWithArgs("token","number"),["number",n]}.call(this)},function(){return function(){return s=this._applyWithArgs("token","string"),["string",s]}.call(this)},function(){return function(){return this._applyWithArgs("token","function"),this._apply("funcRest")}.call(this)},function(){return function(){return this._applyWithArgs("token","new"),n=this._applyWithArgs("token","name"),this._applyWithArgs("token","("),as=this._applyWithArgs("listOf","expr",","),this._applyWithArgs("token",")"),["new",n].concat(as)}.call(this)},function(){return function(){return this._applyWithArgs("token","["),es=this._applyWithArgs("listOf","expr",","),this._applyWithArgs("token","]"),["arr"].concat(es)}.call(this)},function(){return this._apply("json")},function(){return this._apply("re")})},json:function(){var bs;return this.input.idx,function(){return this._applyWithArgs("token","{"),bs=this._applyWithArgs("listOf","jsonBinding",","),this._applyWithArgs("token","}"),["json"].concat(bs)}.call(this)},jsonBinding:function(){var n,v;return this.input.idx,function(){return n=this._apply("jsonPropName"),this._applyWithArgs("token",":"),v=this._apply("expr"),["binding",n,v]}.call(this)},jsonPropName:function(){return this.input.idx,this._or(function(){return this._applyWithArgs("token","name")},function(){return this._applyWithArgs("token","number")},function(){return this._applyWithArgs("token","string")})},re:function(){var x;return this.input.idx,function(){return this._apply("spaces"),x=this._consumedBy(function(){return function(){return this._applyWithArgs("exactly","/"),this._apply("reBody"),this._applyWithArgs("exactly","/"),this._many(function(){return this._apply("reFlag")})}.call(this)}),["regExpr",x]}.call(this)},reBody:function(){return this.input.idx,function(){return this._apply("re1stChar"),this._many(function(){return this._apply("reChar")})}.call(this)},re1stChar:function(){return this.input.idx,this._or(function(){return function(){return this._not(function(){return function(){switch(this._apply("anything")){case"*":return"*";case"\\":return"\\";case"/":return"/";case"[":return"[";default:throw fail}}.call(this)}),this._apply("reNonTerm")}.call(this)},function(){return this._apply("escapeChar")},function(){return this._apply("reClass")})},reChar:function(){return this.input.idx,this._or(function(){return this._apply("re1stChar")},function(){return function(){switch(this._apply("anything")){case"*":return"*";default:throw fail}}.call(this)})},reNonTerm:function(){return this.input.idx,function(){return this._not(function(){return function(){switch(this._apply("anything")){case"\n":return"\n";case"\r":return"\r";default:throw fail}}.call(this)}),this._apply("char")}.call(this)},reClass:function(){return this.input.idx,function(){return this._applyWithArgs("exactly","["),this._many(function(){return this._apply("reClassChar")}),this._applyWithArgs("exactly","]")}.call(this)},reClassChar:function(){return this.input.idx,function(){return this._not(function(){return function(){switch(this._apply("anything")){case"[":return"[";case"]":return"]";default:throw fail}}.call(this)}),this._apply("reChar")}.call(this)},reFlag:function(){return this.input.idx,this._apply("nameFirst")},formal:function(){return this.input.idx,function(){return this._apply("spaces"),this._applyWithArgs("token","name")}.call(this)},funcRest:function(){var fs,body;return this.input.idx,function(){return this._applyWithArgs("token","("),fs=this._applyWithArgs("listOf","formal",","),this._applyWithArgs("token",")"),this._applyWithArgs("token","{"),body=this._apply("srcElems"),this._applyWithArgs("token","}"),["func",fs,body]}.call(this)},sc:function(){return this.input.idx,this._or(function(){return function(){return this._apply("spacesNoNl"),this._or(function(){return function(){switch(this._apply("anything")){case"\n":return"\n";default:throw fail}}.call(this)},function(){return this._lookahead(function(){return this._applyWithArgs("exactly","}")})},function(){return this._apply("end")})}.call(this)},function(){return this._applyWithArgs("token",";")})},binding:function(){var n,v;return this.input.idx,function(){return n=this._applyWithArgs("token","name"),v=this._or(function(){return function(){return this._applyWithArgs("token","="),this._apply("expr")}.call(this)},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),["var",n,v]}.call(this)},block:function(){var ss;return this.input.idx,function(){return this._applyWithArgs("token","{"),ss=this._apply("srcElems"),this._applyWithArgs("token","}"),ss}.call(this)},stmt:function(){var bs,c,t,f,s,i,u,n,v,e,cs,x;return this.input.idx,this._or(function(){return this._apply("block")},function(){return function(){return this._applyWithArgs("token","var"),bs=this._applyWithArgs("listOf","binding",","),this._apply("sc"),["begin"].concat(bs)}.call(this)},function(){return function(){return this._applyWithArgs("token","if"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),t=this._apply("stmt"),f=this._or(function(){return function(){return this._applyWithArgs("token","else"),this._apply("stmt")}.call(this)},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),["if",c,t,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","while"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),["while",c,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","do"),s=this._apply("stmt"),this._applyWithArgs("token","while"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),this._apply("sc"),["doWhile",s,c]}.call(this)},function(){return function(){return this._applyWithArgs("token","for"),this._applyWithArgs("token","("),i=this._or(function(){return function(){return this._applyWithArgs("token","var"),this._apply("binding")}.call(this)},function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),this._applyWithArgs("token",";"),c=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","true"]}.call(this)}),this._applyWithArgs("token",";"),u=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),this._applyWithArgs("token",")"),s=this._apply("stmt"),["for",i,c,u,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","for"),this._applyWithArgs("token","("),v=this._or(function(){return function(){return this._applyWithArgs("token","var"),n=this._applyWithArgs("token","name"),["var",n,["get","undefined"]]}.call(this)},function(){return this._apply("expr")}),this._applyWithArgs("token","in"),e=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),["forIn",v,e,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","switch"),this._applyWithArgs("token","("),e=this._apply("expr"),this._applyWithArgs("token",")"),this._applyWithArgs("token","{"),cs=this._many(function(){return this._or(function(){return function(){return this._applyWithArgs("token","case"),c=this._apply("expr"),this._applyWithArgs("token",":"),cs=this._apply("srcElems"),["case",c,cs]}.call(this)},function(){return function(){return this._applyWithArgs("token","default"),this._applyWithArgs("token",":"),cs=this._apply("srcElems"),["default",cs]}.call(this)})}),this._applyWithArgs("token","}"),["switch",e].concat(cs)}.call(this)},function(){return function(){return this._applyWithArgs("token","break"),this._apply("sc"),["break"]}.call(this)},function(){return function(){return this._applyWithArgs("token","continue"),this._apply("sc"),["continue"]}.call(this)},function(){return function(){return this._applyWithArgs("token","throw"),this._apply("spacesNoNl"),e=this._apply("expr"),this._apply("sc"),["throw",e]}.call(this)},function(){return function(){return this._applyWithArgs("token","try"),t=this._apply("block"),this._applyWithArgs("token","catch"),this._applyWithArgs("token","("),e=this._applyWithArgs("token","name"),this._applyWithArgs("token",")"),c=this._apply("block"),f=this._or(function(){return function(){return this._applyWithArgs("token","finally"),this._apply("block")}.call(this)},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),["try",t,e,c,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","return"),e=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),this._apply("sc"),["return",e]}.call(this)},function(){return function(){return this._applyWithArgs("token","with"),this._applyWithArgs("token","("),x=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),["with",x,s]}.call(this)},function(){return function(){return e=this._apply("expr"),this._apply("sc"),e}.call(this)},function(){return function(){return this._applyWithArgs("token",";"),["get","undefined"]}.call(this)})},srcElem:function(){var n,f;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token","function"),n=this._applyWithArgs("token","name"),f=this._apply("funcRest"),["var",n,f]}.call(this)},function(){return this._apply("stmt")})},srcElems:function(){var ss;return this.input.idx,function(){return ss=this._many(function(){return this._apply("srcElem")}),["begin"].concat(ss)}.call(this)},topLevel:function(){var r;return this.input.idx,function(){return r=this._apply("srcElems"),this._apply("spaces"),this._apply("end"),r}.call(this)}}),BSJSParser.hexDigits="0123456789abcdef",BSJSParser.keywords={},keywords=["break","case","catch","continue","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with","ometa"];for(var idx=0;idx<keywords.length;idx++)BSJSParser.keywords[keywords[idx]]=!0;BSJSParser._isKeyword=function(k){return this.keywords.hasOwnProperty(k)},BSSemActionParser=objectThatDelegatesTo(BSJSParser,{curlySemAction:function(){var r,s,ss;return this.input.idx,this._or(function(){return function(){return this._applyWithArgs("token","{"),r=this._apply("expr"),this._apply("sc"),this._applyWithArgs("token","}"),this._apply("spaces"),r}.call(this)},function(){return function(){return this._applyWithArgs("token","{"),ss=this._many(function(){return function(){return s=this._apply("srcElem"),this._lookahead(function(){return this._apply("srcElem")}),s}.call(this)}),s=this._or(function(){return function(){return r=this._apply("expr"),this._apply("sc"),["return",r]}.call(this)},function(){return this._apply("srcElem")}),ss.push(s),this._applyWithArgs("token","}"),this._apply("spaces"),["send","call",["func",[],["begin"].concat(ss)],["this"]]}.call(this)})},semAction:function(){var r;return this.input.idx,this._or(function(){return this._apply("curlySemAction")},function(){return function(){return r=this._apply("primExpr"),this._apply("spaces"),r}.call(this)})}}),BSJSTranslator=objectThatDelegatesTo(OMeta,{trans:function(){var t,ans;return this.input.idx,function(){return this._form(function(){return function(){return t=this._apply("anything"),ans=this._applyWithArgs("apply",t)}.call(this)}),ans}.call(this)},curlyTrans:function(){var r,rs;return this.input.idx,this._or(function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","begin"),r=this._apply("curlyTrans")}.call(this)}),r}.call(this)},function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","begin"),rs=this._many(function(){return this._apply("trans")})}.call(this)}),"{"+rs.join(";")+"}"}.call(this)},function(){return function(){return r=this._apply("trans"),"{"+r+"}"}.call(this)})},"this":function(){return this.input.idx,"this"},"break":function(){return this.input.idx,"break"},"continue":function(){return this.input.idx,"continue"},number:function(){var n;return this.input.idx,function(){return n=this._apply("anything"),"("+n+")"}.call(this)},string:function(){var s;return this.input.idx,function(){return s=this._apply("anything"),s.toProgramString()}.call(this)},regExpr:function(){var x;return this.input.idx,function(){return x=this._apply("anything")}.call(this)},arr:function(){var xs;return this.input.idx,function(){return xs=this._many(function(){return this._apply("trans")}),"["+xs.join(",")+"]"}.call(this)},unop:function(){var op,x;return this.input.idx,function(){return op=this._apply("anything"),x=this._apply("trans"),"("+op+" "+x+")"}.call(this)},getp:function(){var fd,x;return this.input.idx,function(){return fd=this._apply("trans"),x=this._apply("trans"),x+"["+fd+"]"}.call(this)},get:function(){var x;return this.input.idx,function(){return x=this._apply("anything")}.call(this)},set:function(){var lhs,rhs;return this.input.idx,function(){return lhs=this._apply("trans"),rhs=this._apply("trans"),"("+lhs+"="+rhs+")"}.call(this)},mset:function(){var lhs,op,rhs;return this.input.idx,function(){return lhs=this._apply("trans"),op=this._apply("anything"),rhs=this._apply("trans"),"("+lhs+op+"="+rhs+")"}.call(this)},binop:function(){var op,x,y;return this.input.idx,function(){return op=this._apply("anything"),x=this._apply("trans"),y=this._apply("trans"),"("+x+" "+op+" "+y+")"}.call(this)},preop:function(){var op,x;return this.input.idx,function(){return op=this._apply("anything"),x=this._apply("trans"),op+x}.call(this)},postop:function(){var op,x;return this.input.idx,function(){return op=this._apply("anything"),x=this._apply("trans"),x+op}.call(this)},"return":function(){var x;return this.input.idx,function(){return x=this._apply("trans"),"return "+x}.call(this)},"with":function(){var x,s;return this.input.idx,function(){return x=this._apply("trans"),s=this._apply("curlyTrans"),"with("+x+")"+s}.call(this)},"if":function(){var cond,t,e;return this.input.idx,function(){return cond=this._apply("trans"),t=this._apply("curlyTrans"),e=this._apply("curlyTrans"),"if("+cond+")"+t+"else"+e}.call(this)},condExpr:function(){var cond,t,e;return this.input.idx,function(){return cond=this._apply("trans"),t=this._apply("trans"),e=this._apply("trans"),"("+cond+"?"+t+":"+e+")"}.call(this)},"while":function(){var cond,body;return this.input.idx,function(){return cond=this._apply("trans"),body=this._apply("curlyTrans"),"while("+cond+")"+body}.call(this)},doWhile:function(){var body,cond;return this.input.idx,function(){return body=this._apply("curlyTrans"),cond=this._apply("trans"),"do"+body+"while("+cond+")"}.call(this)},"for":function(){var init,cond,upd,body;return this.input.idx,function(){return init=this._apply("trans"),cond=this._apply("trans"),upd=this._apply("trans"),body=this._apply("curlyTrans"),"for("+init+";"+cond+";"+upd+")"+body}.call(this)},forIn:function(){var x,arr,body;return this.input.idx,function(){return x=this._apply("trans"),arr=this._apply("trans"),body=this._apply("curlyTrans"),"for("+x+" in "+arr+")"+body}.call(this)},begin:function(){var x,xs;return this.input.idx,this._or(function(){return function(){return x=this._apply("trans"),this._apply("end"),x}.call(this)},function(){return function(){return xs=this._many(function(){return function(){return x=this._apply("trans"),this._or(function(){return function(){return this._or(function(){return this._pred("}"==x[x.length-1])},function(){return this._apply("end")}),x}.call(this)},function(){return function(){return this._apply("empty"),x+";"}.call(this)})}.call(this)}),"{"+xs.join("")+"}"}.call(this)})},func:function(){var args,body;return this.input.idx,function(){return args=this._apply("anything"),body=this._apply("curlyTrans"),"(function ("+args.join(",")+")"+body+")"}.call(this)},call:function(){var fn,args;return this.input.idx,function(){return fn=this._apply("trans"),args=this._many(function(){return this._apply("trans")}),fn+"("+args.join(",")+")"}.call(this)},send:function(){var msg,recv,args;return this.input.idx,function(){return msg=this._apply("anything"),recv=this._apply("trans"),args=this._many(function(){return this._apply("trans")}),recv+"."+msg+"("+args.join(",")+")"}.call(this)},"new":function(){var cls,args;return this.input.idx,function(){return cls=this._apply("anything"),args=this._many(function(){return this._apply("trans")}),"new "+cls+"("+args.join(",")+")"}.call(this)},"var":function(){var name,val;return this.input.idx,function(){return name=this._apply("anything"),val=this._apply("trans"),"var "+name+"="+val}.call(this)},"throw":function(){var x;return this.input.idx,function(){return x=this._apply("trans"),"throw "+x}.call(this)},"try":function(){var x,name,c,f;return this.input.idx,function(){return x=this._apply("curlyTrans"),name=this._apply("anything"),c=this._apply("curlyTrans"),f=this._apply("curlyTrans"),"try "+x+"catch("+name+")"+c+"finally"+f}.call(this)},json:function(){var props;return this.input.idx,function(){return props=this._many(function(){return this._apply("trans")}),"({"+props.join(",")+"})"}.call(this)},binding:function(){var name,val;return this.input.idx,function(){return name=this._apply("anything"),val=this._apply("trans"),name.toProgramString()+": "+val}.call(this)},"switch":function(){var x,cases;return this.input.idx,function(){return x=this._apply("trans"),cases=this._many(function(){return this._apply("trans")}),"switch("+x+"){"+cases.join(";")+"}"}.call(this)},"case":function(){var x,y;return this.input.idx,function(){return x=this._apply("trans"),y=this._apply("trans"),"case "+x+": "+y}.call(this)},"default":function(){var y;return this.input.idx,function(){return y=this._apply("trans"),"default: "+y}.call(this)}}),BSOMetaJSParser=objectThatDelegatesTo(BSJSParser,{srcElem:function(){var r;return this.input.idx,this._or(function(){return function(){return this._apply("spaces"),r=this._applyWithArgs("foreign",BSOMetaParser,"grammar"),this._apply("sc"),r}.call(this)},function(){return BSJSParser._superApplyWithArgs(this,"srcElem")})}}),BSOMetaJSTranslator=objectThatDelegatesTo(BSJSTranslator,{Grammar:function(){return this.input.idx,this._applyWithArgs("foreign",BSOMetaTranslator,"Grammar")}}),BSNullOptimization=objectThatDelegatesTo(OMeta,{setHelped:function(){return this.input.idx,this._didSomething=!0},helped:function(){return this.input.idx,this._pred(this._didSomething)},trans:function(){var t,ans;return this.input.idx,function(){return this._form(function(){return function(){return t=this._apply("anything"),this._pred(void 0!=this[t]),ans=this._applyWithArgs("apply",t)}.call(this)}),ans}.call(this)},optimize:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),this._apply("helped"),x}.call(this)},App:function(){var rule,args;return this.input.idx,function(){return rule=this._apply("anything"),args=this._many(function(){return this._apply("anything")}),["App",rule].concat(args)}.call(this)},Act:function(){var expr;return this.input.idx,function(){return expr=this._apply("anything"),["Act",expr]}.call(this)},Pred:function(){var expr;return this.input.idx,function(){return expr=this._apply("anything"),["Pred",expr]}.call(this)},Or:function(){var xs;return this.input.idx,function(){return xs=this._many(function(){return this._apply("trans")}),["Or"].concat(xs)}.call(this)},XOr:function(){var xs;return this.input.idx,function(){return xs=this._many(function(){return this._apply("trans")}),["XOr"].concat(xs)}.call(this)},And:function(){var xs;return this.input.idx,function(){return xs=this._many(function(){return this._apply("trans")}),["And"].concat(xs)}.call(this)},Opt:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["Opt",x]}.call(this)},Many:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["Many",x]}.call(this)},Many1:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["Many1",x]}.call(this)},Set:function(){var n,v;return this.input.idx,function(){return n=this._apply("anything"),v=this._apply("trans"),["Set",n,v]}.call(this)},Not:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["Not",x]}.call(this)},Lookahead:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["Lookahead",x]}.call(this)},Form:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["Form",x]}.call(this)},ConsBy:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["ConsBy",x]}.call(this)},IdxConsBy:function(){var x;return this.input.idx,function(){return x=this._apply("trans"),["IdxConsBy",x]}.call(this)},JumpTable:function(){var c,e,ces;return this.input.idx,function(){return ces=this._many(function(){return function(){return this._form(function(){return function(){return c=this._apply("anything"),e=this._apply("trans")}.call(this)}),[c,e]}.call(this)}),["JumpTable"].concat(ces)}.call(this)},Interleave:function(){var m,p,xs;return this.input.idx,function(){return xs=this._many(function(){return function(){return this._form(function(){return function(){return m=this._apply("anything"),p=this._apply("trans")
}.call(this)}),[m,p]}.call(this)}),["Interleave"].concat(xs)}.call(this)},Rule:function(){var name,ls,body;return this.input.idx,function(){return name=this._apply("anything"),ls=this._apply("anything"),body=this._apply("trans"),["Rule",name,ls,body]}.call(this)}}),BSNullOptimization.initialize=function(){this._didSomething=!1},BSAssociativeOptimization=objectThatDelegatesTo(BSNullOptimization,{And:function(){var x,xs;return this.input.idx,this._or(function(){return function(){return x=this._apply("trans"),this._apply("end"),this._apply("setHelped"),x}.call(this)},function(){return function(){return xs=this._applyWithArgs("transInside","And"),["And"].concat(xs)}.call(this)})},Or:function(){var x,xs;return this.input.idx,this._or(function(){return function(){return x=this._apply("trans"),this._apply("end"),this._apply("setHelped"),x}.call(this)},function(){return function(){return xs=this._applyWithArgs("transInside","Or"),["Or"].concat(xs)}.call(this)})},XOr:function(){var x,xs;return this.input.idx,this._or(function(){return function(){return x=this._apply("trans"),this._apply("end"),this._apply("setHelped"),x}.call(this)},function(){return function(){return xs=this._applyWithArgs("transInside","XOr"),["XOr"].concat(xs)}.call(this)})},transInside:function(){var t,xs,ys,x;return this.input.idx,function(){return t=this._apply("anything"),this._or(function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly",t),xs=this._applyWithArgs("transInside",t)}.call(this)}),ys=this._applyWithArgs("transInside",t),this._apply("setHelped"),xs.concat(ys)}.call(this)},function(){return function(){return x=this._apply("trans"),xs=this._applyWithArgs("transInside",t),[x].concat(xs)}.call(this)},function(){return[]})}.call(this)}}),BSSeqInliner=objectThatDelegatesTo(BSNullOptimization,{App:function(){var s,cs,rule,args;return this.input.idx,this._or(function(){return function(){switch(this._apply("anything")){case"seq":return function(){return s=this._apply("anything"),this._apply("end"),cs=this._applyWithArgs("seqString",s),this._apply("setHelped"),["And"].concat(cs).concat([["Act",s]])}.call(this);default:throw fail}}.call(this)},function(){return function(){return rule=this._apply("anything"),args=this._many(function(){return this._apply("anything")}),["App",rule].concat(args)}.call(this)})},inlineChar:function(){var c;return this.input.idx,function(){return c=this._applyWithArgs("foreign",BSOMetaParser,"eChar"),this._not(function(){return this._apply("end")}),["App","exactly",c.toProgramString()]}.call(this)},seqString:function(){var s,cs;return this.input.idx,function(){return this._lookahead(function(){return function(){return s=this._apply("anything"),this._pred("string"==typeof s)}.call(this)}),this._or(function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly",'"'),cs=this._many(function(){return this._apply("inlineChar")}),this._applyWithArgs("exactly",'"')}.call(this)}),cs}.call(this)},function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","'"),cs=this._many(function(){return this._apply("inlineChar")}),this._applyWithArgs("exactly","'")}.call(this)}),cs}.call(this)})}.call(this)}}),JumpTable=function(choiceOp,choice){this.choiceOp=choiceOp,this.choices={},this.add(choice)},JumpTable.prototype.add=function(choice){var c=choice[0],t=choice[1];this.choices[c]?this.choices[c][0]==this.choiceOp?this.choices[c].push(t):this.choices[c]=[this.choiceOp,this.choices[c],t]:this.choices[c]=t},JumpTable.prototype.toTree=function(){for(var r=["JumpTable"],choiceKeys=ownPropertyNames(this.choices),i=0;i<choiceKeys.length;i+=1)r.push([choiceKeys[i],this.choices[choiceKeys[i]]]);return r},BSJumpTableOptimization=objectThatDelegatesTo(BSNullOptimization,{Or:function(){var cs;return this.input.idx,function(){return cs=this._many(function(){return this._or(function(){return this._applyWithArgs("jtChoices","Or")},function(){return this._apply("trans")})}),["Or"].concat(cs)}.call(this)},XOr:function(){var cs;return this.input.idx,function(){return cs=this._many(function(){return this._or(function(){return this._applyWithArgs("jtChoices","XOr")},function(){return this._apply("trans")})}),["XOr"].concat(cs)}.call(this)},quotedString:function(){var c,cs;return this.input.idx,function(){return this._lookahead(function(){return this._apply("string")}),this._form(function(){return function(){switch(this._apply("anything")){case'"':return function(){return cs=this._many(function(){return function(){return c=this._applyWithArgs("foreign",BSOMetaParser,"eChar"),this._not(function(){return this._apply("end")}),c}.call(this)}),this._applyWithArgs("exactly",'"')}.call(this);case"'":return function(){return cs=this._many(function(){return function(){return c=this._applyWithArgs("foreign",BSOMetaParser,"eChar"),this._not(function(){return this._apply("end")}),c}.call(this)}),this._applyWithArgs("exactly","'")}.call(this);default:throw fail}}.call(this)}),cs.join("")}.call(this)},jtChoice:function(){var x,rest;return this.input.idx,this._or(function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","And"),this._form(function(){return function(){return this._applyWithArgs("exactly","App"),this._applyWithArgs("exactly","exactly"),x=this._apply("quotedString")}.call(this)}),rest=this._many(function(){return this._apply("anything")})}.call(this)}),[x,["And"].concat(rest)]}.call(this)},function(){return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","App"),this._applyWithArgs("exactly","exactly"),x=this._apply("quotedString")}.call(this)}),[x,["Act",x.toProgramString()]]}.call(this)})},jtChoices:function(){var op,c,jt;return this.input.idx,function(){return op=this._apply("anything"),c=this._apply("jtChoice"),jt=new JumpTable(op,c),this._many(function(){return function(){return c=this._apply("jtChoice"),jt.add(c)}.call(this)}),this._apply("setHelped"),jt.toTree()}.call(this)}}),BSOMetaOptimizer=objectThatDelegatesTo(OMeta,{optimizeGrammar:function(){var n,sn,rs;return this.input.idx,function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","Grammar"),n=this._apply("anything"),sn=this._apply("anything"),rs=this._many(function(){return this._apply("optimizeRule")})}.call(this)}),["Grammar",n,sn].concat(rs)}.call(this)},optimizeRule:function(){var r;return this.input.idx,function(){return r=this._apply("anything"),this._or(function(){return r=this._applyWithArgs("foreign",BSSeqInliner,"optimize",r)},function(){return this._apply("empty")}),this._many(function(){return this._or(function(){return r=this._applyWithArgs("foreign",BSAssociativeOptimization,"optimize",r)},function(){return r=this._applyWithArgs("foreign",BSJumpTableOptimization,"optimize",r)})}),r}.call(this)}}),LKJSParser=objectThatDelegatesTo(BSJSParser,{regexp:function(){var cs,fs,flag;return function(){return this._applyWithArgs("exactly","/"),cs=this._many(function(){return this._or(function(){return this._apply("escapeChar")},function(){return function(){return this._not(function(){return this._applyWithArgs("exactly","/")}),this._not(function(){return this._applyWithArgs("exactly","\n")}),this._apply("char")}.call(this)})}),this._applyWithArgs("exactly","/"),flag=this._or(function(){return function(){return fs=this._many1(function(){return function(){switch(this._apply("anything")){case"m":return"m";case"g":return"g";case"i":return"i";case"y":return"y";default:throw fail}}.call(this)}),fs.join("")}.call(this)},function(){return function(){return this._apply("empty"),""}.call(this)}),["regexp","/"+cs.join("")+"/"+flag]}.call(this)},tok:function(){return function(){return this._apply("spaces"),this._or(function(){return this._apply("name")},function(){return this._apply("keyword")},function(){return this._apply("number")},function(){return this._apply("str")},function(){return this._apply("regexp")},function(){return this._apply("special")})}.call(this)},relExpr:function(){var x,y,y,y,y,y,y;return this._or(function(){return function(){return x=this._apply("relExpr"),this._or(function(){return function(){return this._applyWithArgs("token",">"),y=this._apply("addExpr"),["binop",">",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token",">="),y=this._apply("addExpr"),["binop",">=",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","<"),y=this._apply("addExpr"),["binop","<",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","<="),y=this._apply("addExpr"),["binop","<=",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","instanceof"),y=this._apply("addExpr"),["binop","instanceof",x,y]}.call(this)},function(){return function(){return this._applyWithArgs("token","in"),y=this._apply("addExpr"),["binop","in",x,y]}.call(this)})}.call(this)},function(){return this._apply("addExpr")})},primExprHd:function(){var e,n,n,s,r,n,f,n,name,as,newExpr,as,es;return this._or(function(){return function(){return this._applyWithArgs("token","("),e=this._apply("expr"),this._applyWithArgs("token",")"),e}.call(this)},function(){return function(){return this._applyWithArgs("token","this"),["this"]}.call(this)},function(){return function(){return n=this._applyWithArgs("token","name"),["get",n]}.call(this)},function(){return function(){return n=this._applyWithArgs("token","number"),["number",n]}.call(this)},function(){return function(){return s=this._applyWithArgs("token","string"),["string",s]}.call(this)},function(){return function(){return r=this._applyWithArgs("token","regexp"),["regexp",r]}.call(this)},function(){return function(){return this._applyWithArgs("token","function"),this._apply("funcRest")}.call(this)},function(){return function(){return this._applyWithArgs("token","function"),n=this._applyWithArgs("token","name"),f=this._apply("funcRest"),["var",n,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","new"),name=this._many(function(){return function(){return n=this._applyWithArgs("token","name"),this._or(function(){return function(){switch(this._apply("anything")){case".":return".";default:throw fail}}.call(this)},function(){return this._apply("empty")}),n}.call(this)}),this._applyWithArgs("token","("),as=this._applyWithArgs("listOf","expr",","),this._applyWithArgs("token",")"),["new",name.join(".")].concat(as)}.call(this)},function(){return function(){return this._applyWithArgs("token","new"),this._applyWithArgs("token","("),newExpr=this._apply("expr"),this._applyWithArgs("token",")"),this._applyWithArgs("token","("),as=this._applyWithArgs("listOf","expr",","),this._applyWithArgs("token",")"),["newExpr",newExpr].concat(as)}.call(this)},function(){return function(){return this._applyWithArgs("token","["),es=this._applyWithArgs("listOf","expr",","),this._or(function(){return function(){switch(this._apply("anything")){case",":return",";default:throw fail}}.call(this)},function(){return this._apply("empty")}),this._applyWithArgs("token","]"),["arr"].concat(es)}.call(this)},function(){return this._apply("json")})},json:function(){var bs;return function(){return this._applyWithArgs("token","{"),bs=this._applyWithArgs("listOf","jsonBinding",","),this._or(function(){return function(){switch(this._apply("anything")){case",":return",";default:throw fail}}.call(this)},function(){return this._apply("empty")}),this._applyWithArgs("token","}"),["json"].concat(bs)}.call(this)},varBinding:function(){var n,v;return function(){return n=this._applyWithArgs("token","name"),v=this._or(function(){return function(){return this._applyWithArgs("token","="),this._apply("expr")}.call(this)},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),["var",n,v]}.call(this)},stmt:function(){var bs,c,t,f,c,s,s,c,vars,i,c,u,s,n,v,e,s,e,c,cs,cs,cs,e,t,e,c,ca,f,e,x,s,e;return this._or(function(){return this._apply("block")},function(){return function(){return this._applyWithArgs("token","var"),bs=this._applyWithArgs("listOf","varBinding",","),this._apply("sc"),["begin"].concat(bs)}.call(this)},function(){return function(){return this._applyWithArgs("token","if"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),t=this._apply("stmt"),f=this._or(function(){return function(){return this._applyWithArgs("token","else"),this._apply("stmt")}.call(this)},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),["if",c,t,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","while"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),["while",c,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","do"),s=this._apply("stmt"),this._applyWithArgs("token","while"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),this._apply("sc"),["doWhile",s,c]}.call(this)},function(){return function(){return this._applyWithArgs("token","for"),this._applyWithArgs("token","("),i=this._or(function(){return function(){return this._applyWithArgs("token","var"),vars=this._applyWithArgs("listOf","varBinding",","),["multiVar",vars]}.call(this)},function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),this._applyWithArgs("token",";"),c=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","true"]}.call(this)}),this._applyWithArgs("token",";"),u=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),this._applyWithArgs("token",")"),s=this._apply("stmt"),["for",i,c,u,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","for"),this._applyWithArgs("token","("),v=this._or(function(){return function(){return this._applyWithArgs("token","var"),n=this._applyWithArgs("token","name"),["var",n,["get","undefined"]]}.call(this)},function(){return this._apply("expr")}),this._applyWithArgs("token","in"),e=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),["forIn",v,e,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","switch"),this._applyWithArgs("token","("),e=this._apply("expr"),this._applyWithArgs("token",")"),this._applyWithArgs("token","{"),cs=this._many(function(){return this._or(function(){return function(){return this._applyWithArgs("token","case"),c=this._apply("expr"),this._applyWithArgs("token",":"),cs=this._apply("srcElems"),["case",c,cs]}.call(this)},function(){return function(){return this._applyWithArgs("token","default"),this._applyWithArgs("token",":"),cs=this._apply("srcElems"),["default",cs]}.call(this)})}),this._applyWithArgs("token","}"),["switch",e].concat(cs)}.call(this)},function(){return function(){return this._applyWithArgs("token","break"),this._apply("sc"),["break"]}.call(this)},function(){return function(){return this._applyWithArgs("token","continue"),this._apply("sc"),["continue"]}.call(this)},function(){return function(){return this._applyWithArgs("token","throw"),this._apply("spacesNoNl"),e=this._apply("expr"),this._apply("sc"),["throw",e]}.call(this)},function(){return function(){return this._applyWithArgs("token","try"),t=this._apply("block"),ca=this._or(function(){return function(){return this._applyWithArgs("token","catch"),this._applyWithArgs("token","("),e=this._applyWithArgs("token","name"),this._applyWithArgs("token",")"),c=this._apply("block"),[e,c]}.call(this)},function(){return function(){return this._apply("empty"),["",["get","undefined"]]}.call(this)}),f=this._or(function(){return function(){return this._applyWithArgs("token","finally"),this._apply("block")}.call(this)},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),["try",t].concat(ca).concat([f])}.call(this)},function(){return function(){return this._applyWithArgs("token","return"),e=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),["get","undefined"]}.call(this)}),this._apply("sc"),["return",e]}.call(this)},function(){return function(){return this._applyWithArgs("token","with"),this._applyWithArgs("token","("),x=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),["with",x,s]}.call(this)},function(){return function(){return e=this._apply("expr"),this._apply("sc"),e}.call(this)},function(){return function(){return this._applyWithArgs("token",";"),["get","undefined"]}.call(this)})}}),LKJSTranslator=objectThatDelegatesTo(BSJSTranslator,{regexp:function(){var re;return function(){return re=this._apply("anything")}.call(this)},preopSpace:function(){var op,x;return function(){return op=this._apply("anything"),x=this._apply("trans"),op+" "+x}.call(this)},newExpr:function(){var newExpr,args;return function(){return newExpr=this._apply("trans"),args=this._many(function(){return this._apply("trans")}),"new ("+newExpr+")("+args.join(",")+")"}.call(this)},singleVar:function(){var name,val;return function(){return this._form(function(){return function(){return this._applyWithArgs("exactly","var"),name=this._apply("anything"),val=this._apply("trans")}.call(this)}),name+"="+val}.call(this)},multiVar:function(){var xs;return function(){return this._form(function(){return xs=this._many(function(){return this._apply("singleVar")})}),"var "+xs.join(",")}.call(this)},"try":function(){var x,name,c,f;return function(){return x=this._apply("curlyTrans"),name=this._apply("anything"),c=this._apply("curlyTrans"),f=this._apply("curlyTrans"),"try "+x+(name?"catch("+name+")"+c:"")+"finally"+f}.call(this)}}),LKOMetaParser=objectThatDelegatesTo(BSOMetaParser,{hostExpr:function(){var r;return function(){return r=this._applyWithArgs("foreign",LKJSParser,"expr"),this._applyWithArgs("foreign",BSJSTranslator,"trans",r)}.call(this)},atomicHostExpr:function(){var r;return function(){return r=this._applyWithArgs("foreign",LKJSParser,"semAction"),this._applyWithArgs("foreign",BSJSTranslator,"trans",r)}.call(this)},curlyHostExpr:function(){var r;return function(){return r=this._applyWithArgs("foreign",LKJSParser,"curlySemAction"),this._applyWithArgs("foreign",BSJSTranslator,"trans",r)}.call(this)}}),LKOMetaJSParser=objectThatDelegatesTo(LKJSParser,{srcElem:function(){var r;return this._or(function(){return function(){return this._apply("spaces"),r=this._applyWithArgs("foreign",LKOMetaParser,"grammar"),this._apply("sc"),r}.call(this)},function(){return LKJSParser._superApplyWithArgs(this,"srcElem")})}}),LKOMetaJSTranslator=objectThatDelegatesTo(LKJSTranslator,{Grammar:function(){return this._applyWithArgs("foreign",BSOMetaTranslator,"Grammar")}}),module("lively.Ometa").requires("lively.Network","ometa.lively").toRun(function(){Object.subclass("OMetaSupport"),Object.extend(OMetaSupport,{ometaGrammarDir:URL.codeBase,fromFile:function(fileName){var src=OMetaSupport.fileContent(fileName),grammar=OMetaSupport.ometaEval(src);return grammar},translateAndWrite:function(sourceFileName,destFileName,additionalRequirements){var requirementsString=additionalRequirements?",'"+additionalRequirements.join("','")+"'":"",str=Strings.format("module('%s').requires('ometa.lively'%s).toRun(function() {\n%s\n});",destFileName.replace(/\.js$/,"").replace(/\//g,"."),requirementsString,OMetaSupport.translateToJs(OMetaSupport.fileContent(sourceFileName)));OMetaSupport.writeGrammar(destFileName,str),lively.morphic.World.current().setStatusMessage(Strings.format("Successfully compiled OMeta grammar %s to %s",sourceFileName,destFileName),Color.green,3)},translate:function(source,additionalRequirements,destFileName){destFileName=destFileName||"anonymousOMetaModule";var requirementsString=additionalRequirements?",'"+additionalRequirements.join("','")+"'":"",str=Strings.format("module('%s').requires('ometa.lively'%s).toRun(function() {\n%s\n});",destFileName.replace(/\.js$/,"").replace(/\//g,"."),requirementsString,OMetaSupport.translateToJs(source));return lively.morphic.World.current().setStatusMessage(Strings.format("Successfully compiled OMeta grammar %s",source.truncate(300)),Color.green,3),str},ometaEval:function(src){var jsSrc=OMetaSupport.translateToJs(src);return eval(jsSrc)},translateToJs:function(src){var ometaSrc=OMetaSupport.matchAllWithGrammar(BSOMetaJSParser,"topLevel",src);if(!ometaSrc)throw new Error("Problem in translateToJs: Cannot create OMeta Ast from source");var jsSrc=OMetaSupport.matchWithGrammar(BSOMetaJSTranslator,"trans",ometaSrc);return jsSrc},matchAllWithGrammar:function(grammar,rule,src,errorHandling){var errorFunc;return errorFunc=errorHandling?errorHandling instanceof Function?errorHandling:OMetaSupport.handleErrorDebug:OMetaSupport.handleErrorDebug,grammar.matchAll(src,rule,null,errorFunc.curry(src,rule))},matchWithGrammar:function(grammar,rule,src,errorHandling){var errorFunc;return errorFunc=errorHandling?errorHandling instanceof Function?errorHandling:OMetaSupport.handleErrorDebug:OMetaSupport.handleErrorDebug,grammar.match(src,rule,null,errorFunc.curry(src,rule))},handleErrorDebug:function(src,rule,grammarInstance,errorIndex){var charsBefore=500,charsAfter=250,msg="OMeta Error -- "+rule+"\n",startIndex=Math.max(0,errorIndex-charsBefore),stopIndex=Math.min(src.length,errorIndex+charsAfter);return msg+=src.constructor===Array?"src = ["+src.toString()+"]":src.substring(startIndex,errorIndex)+"<--Error-->"+src.substring(errorIndex,stopIndex),console.log(msg),msg},handleError:function(){},fileContent:function(fileName){var url=URL.root.withFilename(fileName);return new WebResource(url).get().content},writeGrammar:function(fileName,src){var url=URL.root.withFilename(fileName);return new WebResource(url).put(src)}})}),module("users.timfelgentreff.jsinterpreter.generated.Nodes").requires().toRun(function(){Object.subclass("users.timfelgentreff.jsinterpreter.Node"),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Sequence","testing",{isSequence:!0},"initializing",{initialize:function($super,pos,children){this.pos=pos,this.children=children,children.forEach(function(node){node.setParent(this)},this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.children)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.children.join(","))}},"conversion",{asJS:function(depth){var indent=this.indent(depth||0);return depth=depth||-1,this.children.invoke("asJS",depth+1).join(";\n"+indent)}},"insertion",{insertBefore:function(newNode,existingNode){for(var i=0;i<this.children.length&&!(this.children[i].nodesMatching(function(node){return node===existingNode}).length>0);i++);if(!this.children[i])throw dbgOn(new Error("insertBefore: "+existingNode+" not in "+this));return this.insertAt(newNode,i)},insertAt:function(newNode,idx){return this.children.pushAt(newNode,idx),newNode.setParent(this),newNode}},"accessing",{parentSequence:function(){return this}},"stepping",{firstStatement:function(){return this.children.length>0?this.children[0].firstStatement():this},nextStatement:function($super,node){var idx=this.children.indexOf(node);return idx>=0&&idx<this.children.length-1?this.children[idx+1]:$super(this)},isComposite:function(){return!0}},"visiting",{accept:function(visitor){return visitor.visitSequence(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Number","testing",{isNumber:!0},"initializing",{initialize:function($super,pos,value){this.pos=pos,this.value=value}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.pos,this.value)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.value)}},"conversion",{asJS:function(){return this.value}},"visiting",{accept:function(visitor){return visitor.visitNumber(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.String","testing",{isString:!0},"initializing",{initialize:function($super,pos,value){this.pos=pos,this.value=value}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.value+'"')},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.value)}},"conversion",{asJS:function(){return'"'+this.value+'"'}},"visiting",{accept:function(visitor){return visitor.visitString(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Cond","testing",{isCond:!0},"initializing",{initialize:function($super,pos,condExpr,trueExpr,falseExpr){this.pos=pos,this.condExpr=condExpr,this.trueExpr=trueExpr,this.falseExpr=falseExpr,condExpr.setParent(this),trueExpr.setParent(this),falseExpr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.trueExpr,this.falseExpr)},toString:function(){return Strings.format("%s(%s?%s:%s)",this.constructor.name,this.condExpr,this.trueExpr,this.falseExpr)}},"conversion",{asJS:function(depth){return Strings.format("(%s) ? (%s) : (%s)",this.condExpr.asJS(depth),this.trueExpr.asJS(depth),this.falseExpr.asJS(depth))}},"visiting",{accept:function(visitor){return visitor.visitCond(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.If","testing",{isIf:!0},"initializing",{initialize:function($super,pos,condExpr,trueExpr,falseExpr){this.pos=pos,this.condExpr=condExpr,this.trueExpr=trueExpr.isSequence||this.isUndefined(trueExpr)?trueExpr:new users.timfelgentreff.jsinterpreter.Sequence(trueExpr.pos,[trueExpr]),this.falseExpr=falseExpr.isSequence||this.isUndefined(falseExpr)?falseExpr:new users.timfelgentreff.jsinterpreter.Sequence(trueExpr.pos,[falseExpr]),condExpr.setParent(this),this.trueExpr.setParent(this),this.falseExpr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.trueExpr,this.falseExpr)},toString:function(){return Strings.format("%s(%s?%s:%s)",this.constructor.name,this.condExpr,this.trueExpr,this.falseExpr)}},"conversion",{asJS:function(depth){var str=Strings.format("if (%s) {%s}",this.condExpr.asJS(depth),this.trueExpr.asJS(depth));return this.isUndefined(this.falseExpr)||(str+=" else {"+this.falseExpr.asJS(depth)+"}"),str}},"stepping",{firstStatement:function(){return this.condExpr.firstStatement()},nextStatement:function($super,node){return node===this.condExpr?this.trueExpr:$super(this)},isComposite:function(){return!0}},"visiting",{accept:function(visitor){return visitor.visitIf(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.While","testing",{isWhile:!0},"initializing",{initialize:function($super,pos,condExpr,body){this.pos=pos,this.condExpr=condExpr,this.body=body,condExpr.setParent(this),body.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.body)},toString:function(){return Strings.format("%s(%s?%s)",this.constructor.name,this.condExpr,this.body)}},"conversion",{asJS:function(depth){return Strings.format("while (%s) {%s}",this.condExpr.asJS(depth),this.body.asJS(depth))}},"stepping",{firstStatement:function(){return this.condExpr.firstStatement()},nextStatement:function($super,node){return node===this.condExpr?this.body:node===this.body?this.condExpr:$super(this)},isComposite:function(){return!0}},"visiting",{accept:function(visitor){return visitor.visitWhile(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.DoWhile","testing",{isDoWhile:!0},"initializing",{initialize:function($super,pos,body,condExpr){this.pos=pos,this.body=body,this.condExpr=condExpr,body.setParent(this),condExpr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.body,this.condExpr)},toString:function(){return Strings.format("%s(%s while%s)",this.constructor.name,this.body,this.condExpr)}},"conversion",{asJS:function(depth){return Strings.format("do {%s} while (%s);",this.body.asJS(depth),this.condExpr.asJS(depth))}},"stepping",{firstStatement:function(){return this.body.firstStatement()},nextStatement:function($super,node){return node===this.condExpr?this.body:node===this.body?this.condExpr:$super(this)},isComposite:function(){return!0}},"visiting",{accept:function(visitor){return visitor.visitDoWhile(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.For","testing",{isFor:!0},"initializing",{initialize:function($super,pos,init,condExpr,body,upd){this.pos=pos,this.init=init,this.condExpr=condExpr,this.body=body,this.upd=upd,init.setParent(this),condExpr.setParent(this),body.setParent(this),upd.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.init,this.condExpr,this.body,this.upd)},toString:function(){return Strings.format("%s(%s;%s;%s do %s)",this.constructor.name,this.init,this.condExpr,this.upd,this.body)}},"conversion",{asJS:function(depth){return Strings.format("for (%s; %s; %s) {%s}",this.init.asJS(depth),this.condExpr.asJS(depth),this.upd.asJS(depth),this.body.asJS(depth))}},"stepping",{firstStatement:function(){return this.init.firstStatement()},nextStatement:function($super,node){return node===this.init||node===this.upd?this.condExpr:node===this.condExpr?this.body:node===this.body?this.upd:$super(this)},isComposite:function(){return!0}},"visiting",{accept:function(visitor){return visitor.visitFor(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.ForIn","testing",{isForIn:!0},"initializing",{initialize:function($super,pos,name,obj,body){this.pos=pos,this.name=name,this.obj=obj,this.body=body,name.setParent(this),obj.setParent(this),body.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.name,this.obj,this.body)},toString:function(){return Strings.format("%s(%s in %s do %s)",this.constructor.name,this.name,this.obj,this.body)}},"conversion",{asJS:function(depth){return Strings.format("for (%s in %s) {%s}",this.name.asJS(depth),this.obj.asJS(depth),this.body.asJS(depth))}},"visiting",{accept:function(visitor){return visitor.visitForIn(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Set","testing",{isSet:!0},"initializing",{initialize:function($super,pos,left,right){this.pos=pos,this.left=left,this.right=right,left.setParent(this),right.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.left,this.right)},toString:function(){return Strings.format("%s(%s = %s)",this.constructor.name,this.left,this.right)}},"conversion",{asJS:function(depth){return this.left.asJS(depth)+" = "+this.right.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitSet(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.ModifyingSet","testing",{isModifyingSet:!0},"initializing",{initialize:function($super,pos,left,name,right){this.pos=pos,this.left=left,this.name=name,this.right=right,left.setParent(this),right.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.left,'"'+this.name+'"',this.right)},toString:function(){return Strings.format("%s(%s %s %s)",this.constructor.name,this.left,this.name,this.right)}},"conversion",{asJS:function(depth){return this.left.asJS(depth)+" "+this.name+"= "+this.right.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitModifyingSet(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.BinaryOp","testing",{isBinaryOp:!0},"initializing",{initialize:function($super,pos,name,left,right){this.pos=pos,this.name=name,this.left=left,this.right=right,left.setParent(this),right.setParent(this)
}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.left,this.right)},toString:function(){return Strings.format("%s(%s %s %s)",this.constructor.name,this.left,this.name,this.right)}},"conversion",{asJS:function(depth){return"("+this.left.asJS(depth)+") "+this.name+" ("+this.right.asJS(depth)+")"}},"visiting",{accept:function(visitor){return visitor.visitBinaryOp(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.UnaryOp","testing",{isUnaryOp:!0},"initializing",{initialize:function($super,pos,name,expr){this.pos=pos,this.name=name,this.expr=expr,expr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s%s)",this.constructor.name,this.name,this.expr)}},"conversion",{asJS:function(depth){return"("+this.name+this.expr.asJS(depth)+")"}},"visiting",{accept:function(visitor){return visitor.visitUnaryOp(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.PreOp","testing",{isPreOp:!0},"initializing",{initialize:function($super,pos,name,expr){this.pos=pos,this.name=name,this.expr=expr,expr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s%s)",this.constructor.name,this.name,this.expr)}},"conversion",{asJS:function(depth){return"("+this.name+this.expr.asJS(depth)+")"}},"visiting",{accept:function(visitor){return visitor.visitPreOp(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.PostOp","testing",{isPostOp:!0},"initializing",{initialize:function($super,pos,name,expr){this.pos=pos,this.name=name,this.expr=expr,expr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s%s)",this.constructor.name,this.expr,this.name)}},"conversion",{asJS:function(depth){return"("+this.expr.asJS(depth)+this.name+")"}},"visiting",{accept:function(visitor){return visitor.visitPostOp(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.This","testing",{isThis:!0},"initializing",{initialize:function($super,pos){this.pos=pos}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos)},toString:function(){return this.constructor.name}},"conversion",{asJS:function(){return"this"}},"visiting",{accept:function(visitor){return visitor.visitThis(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Variable","testing",{isVariable:!0},"initializing",{initialize:function($super,pos,name){this.pos=pos,this.name=name}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"')},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.name)}},"conversion",{asJS:function(){return this.name}},"visiting",{accept:function(visitor){return visitor.visitVariable(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.GetSlot","testing",{isGetSlot:!0},"initializing",{initialize:function($super,pos,slotName,obj){this.pos=pos,this.slotName=slotName,this.obj=obj,slotName.setParent(this),obj.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.slotName,this.obj)},toString:function(){return Strings.format("%s(%s[%s])",this.constructor.name,this.obj,this.slotName)}},"conversion",{asJS:function(depth){var objJS=this.obj.asJS(depth);return this.obj.isFunction&&(objJS="("+objJS+")"),objJS+"["+this.slotName.asJS(depth)+"]"}},"visiting",{accept:function(visitor){return visitor.visitGetSlot(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Break","testing",{isBreak:!0},"initializing",{initialize:function($super,pos,label){this.pos=pos,this.label=label||new users.timfelgentreff.jsinterpreter.Label([pos[1],pos[1]],""),this.label.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.label)}},"conversion",{asJS:function(){return"break"+this.label.asJS()}},"visiting",{accept:function(visitor){return visitor.visitBreak(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Debugger","testing",{isDebugger:!0},"initializing",{initialize:function($super,pos){this.pos=pos}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos)}},"conversion",{asJS:function(){return"debugger"}},"visiting",{accept:function(visitor){return visitor.visitDebugger(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Continue","testing",{isContinue:!0},"initializing",{initialize:function($super,pos,label){this.pos=pos,this.label=label||new users.timfelgentreff.jsinterpreter.Label([pos[1],pos[1]],""),this.label.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.label)}},"conversion",{asJS:function(){return"continue"+this.label.asJS()}},"visiting",{accept:function(visitor){return visitor.visitContinue(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.ArrayLiteral","testing",{isArrayLiteral:!0},"initializing",{initialize:function($super,pos,elements){this.pos=pos,this.elements=elements,elements.forEach(function(node){node.setParent(this)},this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.elements)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.elements.join(","))}},"conversion",{asJS:function(){return"["+this.elements.invoke("asJS").join(",")+"]"}},"visiting",{accept:function(visitor){return visitor.visitArrayLiteral(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Return","testing",{isReturn:!0},"initializing",{initialize:function($super,pos,expr){this.pos=pos,this.expr=expr,expr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.expr)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.expr)}},"conversion",{asJS:function(depth){return"return "+this.expr.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitReturn(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.With","testing",{isWith:!0},"initializing",{initialize:function($super,pos,obj,body){this.pos=pos,this.obj=obj,this.body=body,obj.setParent(this),body.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.obj,this.body)},toString:function(){return Strings.format("%s(%s %s)",this.constructor.name,this.obj,this.body)}},"conversion",{asJS:function(depth){return"with ("+this.obj.asJS(depth)+") {"+this.body.asJS(depth)+"}"}},"visiting",{accept:function(visitor){return visitor.visitWith(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Send","testing",{isSend:!0},"initializing",{initialize:function($super,pos,property,recv,args){this.pos=pos,this.property=property,this.recv=recv,this.args=args,args.forEach(function(node){node.setParent(this)},this),property.setParent(this),recv.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.property,this.recv,this.args)},toString:function(){return Strings.format("%s(%s[%s](%s))",this.constructor.name,this.recv,this.property,this.args.join(","))}},"conversion",{asJS:function(depth){var recvJS=this.recv.asJS(depth);return this.recv.isFunction&&(recvJS="("+recvJS+")"),Strings.format("%s[%s](%s)",recvJS,this.property.asJS(depth),this.args.invoke("asJS").join(","))}},"accessing",{getName:function(){return this.property}},"visiting",{accept:function(visitor){return visitor.visitSend(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Call","testing",{isCall:!0},"initializing",{initialize:function($super,pos,fn,args){this.pos=pos,this.fn=fn,this.args=args,args.forEach(function(node){node.setParent(this)},this),fn.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.fn,this.args)},toString:function(){return Strings.format("%s(%s(%s))",this.constructor.name,this.fn,this.args.join(","))}},"conversion",{asJS:function(depth){return Strings.format("%s(%s)",this.fn.asJS(depth),this.args.invoke("asJS").join(","))}},"accessing",{getName:function(){return this.fn.name}},"visiting",{accept:function(visitor){return visitor.visitCall(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.New","testing",{isNew:!0},"initializing",{initialize:function($super,pos,clsExpr){this.pos=pos,this.clsExpr=clsExpr,clsExpr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.clsExpr)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.clsExpr)}},"conversion",{asJS:function(depth){return"new "+this.clsExpr.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitNew(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.VarDeclaration","testing",{isVarDeclaration:!0},"initializing",{initialize:function($super,pos,name,val){this.pos=pos,this.name=name,this.val=val,val.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.val)},toString:function(){return Strings.format("%s(%s = %s)",this.constructor.name,this.name,this.val)}},"conversion",{asJS:function(depth){return Strings.format("var %s = %s",this.name,this.val.asJS(depth))}},"visiting",{accept:function(visitor){return visitor.visitVarDeclaration(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Throw","testing",{isThrow:!0},"initializing",{initialize:function($super,pos,expr){this.pos=pos,this.expr=expr,expr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.expr)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.expr)}},"conversion",{asJS:function(depth){return"throw "+this.expr.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitThrow(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.TryCatchFinally","testing",{isTryCatchFinally:!0},"initializing",{initialize:function($super,pos,trySeq,err,catchSeq,finallySeq){this.pos=pos,this.trySeq=trySeq,this.err=err,this.catchSeq=catchSeq,this.finallySeq=finallySeq,trySeq.setParent(this),err.setParent(this),catchSeq.setParent(this),finallySeq.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.trySeq,'"'+this.err.name+'"',this.catchSeq,this.finallySeq)},toString:function(){return Strings.format("%s(%s %s %s)",this.constructor.name,this.trySeq,this.catchSeq,this.finallySeq)}},"conversion",{asJS:function(depth){var baseIndent=this.indent(depth-1),indent=this.indent(depth),str="try {\n"+indent+this.trySeq.asJS(depth)+"\n"+baseIndent+"}";return this.isUndefined(this.catchSeq)||(str+=" catch("+this.err.name+") {\n"+indent+this.catchSeq.asJS(depth)+"\n"+baseIndent+"}"),this.isUndefined(this.finallySeq)||(str+=" finally {\n"+indent+this.finallySeq.asJS(depth)+"\n"+baseIndent+"}"),str}},"visiting",{accept:function(visitor){return visitor.visitTryCatchFinally(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Function","testing",{isFunction:!0},"initializing",{initialize:function($super,pos,body,args){this.pos=pos,this.body=body,this.args=args,args.forEach(function(node){node.setParent(this)},this),body.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.body,this.args.collect(function(ea){return'"'+ea.name+'"'}))},toString:function(){return Strings.format("%s(function %s(%s) %s)",this.constructor.name,this.name(),this.argNames().join(","),this.body)}},"conversion",{asJS:function(depth){return Strings.format("function%s(%s) {\n%s\n}",this.name()?" "+this.name():"",this.argNames().join(","),this.indent(depth+1)+this.body.asJS(depth+1))}},"accessing",{name:function(){return this._parent&&this._parent.isVarDeclaration?this._parent.name:void 0},parentFunction:function(){return this},argNames:function(){return this.args.collect(function(a){return a.name})},statements:function(){return this.body.children}},"stepping",{firstStatement:function(){return this.body.firstStatement()},nextStatement:function(){return null},isComposite:function(){return!0}},"evaluation",{eval:function(){return new Function(this.argNames().join(","),this.body.asJS())}},"visiting",{accept:function(visitor){return visitor.visitFunction(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.ObjectLiteral","testing",{isObjectLiteral:!0},"initializing",{initialize:function($super,pos,properties){this.pos=pos,this.properties=properties,properties.forEach(function(node){node.setParent(this)},this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.properties)},toString:function(){return Strings.format("%s({%s})",this.constructor.name,this.properties.join(","))}},"conversion",{asJS:function(){return"{"+this.properties.invoke("asJS").join(",")+"}"}},"visiting",{accept:function(visitor){return visitor.visitObjectLiteral(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.ObjProperty","testing",{isObjProperty:!0},"initializing",{initialize:function($super,pos,name,property){this.pos=pos,this.name=name,this.property=property,property.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.property)},toString:function(){return Strings.format("%s(%s: %s)",this.constructor.name,this.name,this.property)}},"conversion",{asJS:function(depth){return Strings.format('"%s": %s',this.name,this.property.asJS(depth))}},"visiting",{accept:function(visitor){return visitor.visitObjProperty(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.ObjPropertyGet","testing",{isObjPropertyGet:!0},"initializing",{initialize:function($super,pos,name,body){this.pos=pos,this.name=name,this.body=body,body.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.body)},toString:function(){return Strings.format("%s(%s() { %s })",this.constructor.name,this.name,this.body)}},"conversion",{asJS:function(depth){return Strings.format('get "%s"() { %s }',this.name,this.body.asJS(depth))}},"visiting",{accept:function(visitor){return visitor.visitObjPropertyGet(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.ObjPropertySet","testing",{isObjPropertySet:!0},"initializing",{initialize:function($super,pos,name,body,arg){this.pos=pos,this.name=name,this.body=body,this.arg=arg,body.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.body,this.arg)},toString:function(){return Strings.format("%s(%s(%s) { %s })",this.constructor.name,this.name,this.arg,this.body)}},"conversion",{asJS:function(depth){return Strings.format('set "%s"(%s) { %s }',this.name,this.arg,this.body.asJS(depth))}},"visiting",{accept:function(visitor){return visitor.visitObjPropertySet(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Switch","testing",{isSwitch:!0},"initializing",{initialize:function($super,pos,expr,cases){this.pos=pos,this.expr=expr,this.cases=cases,cases.forEach(function(node){node.setParent(this)},this),expr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.expr,this.cases)},toString:function(){return Strings.format("%s(%s %s)",this.constructor.name,this.expr,this.cases.join("\n"))}},"conversion",{asJS:function(depth){return Strings.format("switch (%s) {%s}",this.expr.asJS(depth),this.cases.invoke("asJS").join("\n"))}},"visiting",{accept:function(visitor){return visitor.visitSwitch(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Case","testing",{isCase:!0},"initializing",{initialize:function($super,pos,condExpr,thenExpr){this.pos=pos,this.condExpr=condExpr,this.thenExpr=thenExpr,condExpr.setParent(this),thenExpr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.thenExpr)},toString:function(){return Strings.format("%s(%s: %s)",this.constructor.name,this.condExpr,this.thenExpr)}},"conversion",{asJS:function(depth){return"case "+this.condExpr.asJS(depth)+": "+this.thenExpr.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitCase(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Default","testing",{isDefault:!0},"initializing",{initialize:function($super,pos,defaultExpr){this.pos=pos,this.defaultExpr=defaultExpr,defaultExpr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.defaultExpr)},toString:function(){return Strings.format("%s(default: %s)",this.constructor.name,this.defaultExpr)}},"conversion",{asJS:function(depth){return"default: "+this.defaultExpr.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitDefault(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Regex","testing",{isRegex:!0},"initializing",{initialize:function($super,pos,exprString,flags){this.pos=pos,this.exprString=exprString,this.flags=flags}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,this.exprString,this.flags)},toString:function(){return Strings.format("(/%s/%s)",this.exprString,this.flags)}},"conversion",{asJS:function(){return"/"+this.exprString+"/"+this.flags}},"visiting",{accept:function(visitor){return visitor.visitRegex(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.Label","testing",{isLabel:!0},"initializing",{initialize:function($super,pos,name){this.pos=pos,this.name=name}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"')},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.name)}},"conversion",{asJS:function(){return this.name}},"visiting",{accept:function(visitor){return visitor.visitLabel(this)}}),users.timfelgentreff.jsinterpreter.Node.subclass("users.timfelgentreff.jsinterpreter.LabelDeclaration","testing",{isLabelDeclaration:!0},"initializing",{initialize:function($super,pos,name,expr){this.pos=pos,this.name=name,this.expr=expr,expr.setParent(this)}},"debugging",{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s is %s)",this.constructor.name,this.name,this.expr)}},"conversion",{asJS:function(depth){return this.name+": "+this.expr.asJS(depth)}},"visiting",{accept:function(visitor){return visitor.visitLabelDeclaration(this)}}),Object.subclass("users.timfelgentreff.jsinterpreter.Visitor","visiting",{visit:function(node){return node.accept(this)},visitSequence:function(){},visitNumber:function(){},visitString:function(){},visitCond:function(){},visitIf:function(){},visitWhile:function(){},visitDoWhile:function(){},visitFor:function(){},visitForIn:function(){},visitSet:function(){},visitModifyingSet:function(){},visitBinaryOp:function(){},visitUnaryOp:function(){},visitPreOp:function(){},visitPostOp:function(){},visitThis:function(){},visitVariable:function(){},visitGetSlot:function(){},visitBreak:function(){},visitDebugger:function(){},visitContinue:function(){},visitArrayLiteral:function(){},visitReturn:function(){},visitWith:function(){},visitSend:function(){},visitCall:function(){},visitNew:function(){},visitVarDeclaration:function(){},visitThrow:function(){},visitTryCatchFinally:function(){},visitFunction:function(){},visitObjectLiteral:function(){},visitObjProperty:function(){},visitObjPropertyGet:function(){},visitObjPropertySet:function(){},visitSwitch:function(){},visitCase:function(){},visitDefault:function(){},visitRegex:function(){},visitLabel:function(){},visitLabelDeclaration:function(){}})}),module("users.timfelgentreff.jsinterpreter.generated.Translator").requires("ometa.lively").toRun(function(){JSTranslator=objectThatDelegatesTo(Parser,{trans:function(){var t,ans;return function(){return this._form(function(){return function(){return t=this._apply("anything"),ans=this._applyWithArgs("apply",t)}.call(this)}),ans}.call(this)},begin:function(){var pos,children;return function(){return pos=this._apply("anything"),children=this._many(function(){return this._apply("trans")}),this._apply("end"),new users.timfelgentreff.jsinterpreter.Sequence(pos,children)}.call(this)},number:function(){var pos,value;return function(){return pos=this._apply("anything"),value=this._apply("anything"),new users.timfelgentreff.jsinterpreter.Number(pos,value)}.call(this)},string:function(){var pos,value;return function(){return pos=this._apply("anything"),value=this._apply("anything"),new users.timfelgentreff.jsinterpreter.String(pos,value)}.call(this)},condExpr:function(){var pos,condExpr,trueExpr,falseExpr;return function(){return pos=this._apply("anything"),condExpr=this._apply("trans"),trueExpr=this._apply("trans"),falseExpr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.Cond(pos,condExpr,trueExpr,falseExpr)}.call(this)},"if":function(){var pos,condExpr,trueExpr,falseExpr;return function(){return pos=this._apply("anything"),condExpr=this._apply("trans"),trueExpr=this._apply("trans"),falseExpr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.If(pos,condExpr,trueExpr,falseExpr)}.call(this)},"while":function(){var pos,condExpr,body;return function(){return pos=this._apply("anything"),condExpr=this._apply("trans"),body=this._apply("trans"),new users.timfelgentreff.jsinterpreter.While(pos,condExpr,body)}.call(this)},doWhile:function(){var pos,body,condExpr;return function(){return pos=this._apply("anything"),body=this._apply("trans"),condExpr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.DoWhile(pos,body,condExpr)}.call(this)},"for":function(){var pos,init,condExpr,body,upd;return function(){return pos=this._apply("anything"),init=this._apply("trans"),condExpr=this._apply("trans"),body=this._apply("trans"),upd=this._apply("trans"),new users.timfelgentreff.jsinterpreter.For(pos,init,condExpr,body,upd)}.call(this)},forIn:function(){var pos,name,obj,body;return function(){return pos=this._apply("anything"),name=this._apply("trans"),obj=this._apply("trans"),body=this._apply("trans"),new users.timfelgentreff.jsinterpreter.ForIn(pos,name,obj,body)}.call(this)},set:function(){var pos,left,right;return function(){return pos=this._apply("anything"),left=this._apply("trans"),right=this._apply("trans"),new users.timfelgentreff.jsinterpreter.Set(pos,left,right)}.call(this)},mset:function(){var pos,left,name,right;return function(){return pos=this._apply("anything"),left=this._apply("trans"),name=this._apply("anything"),right=this._apply("trans"),new users.timfelgentreff.jsinterpreter.ModifyingSet(pos,left,name,right)}.call(this)},binop:function(){var pos,name,left,right;return function(){return pos=this._apply("anything"),name=this._apply("anything"),left=this._apply("trans"),right=this._apply("trans"),new users.timfelgentreff.jsinterpreter.BinaryOp(pos,name,left,right)}.call(this)},unop:function(){var pos,name,expr;return function(){return pos=this._apply("anything"),name=this._apply("anything"),expr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.UnaryOp(pos,name,expr)}.call(this)},preop:function(){var pos,name,expr;return function(){return pos=this._apply("anything"),name=this._apply("anything"),expr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.PreOp(pos,name,expr)}.call(this)},postop:function(){var pos,name,expr;return function(){return pos=this._apply("anything"),name=this._apply("anything"),expr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.PostOp(pos,name,expr)}.call(this)},"this":function(){var pos;return function(){return pos=this._apply("anything"),new users.timfelgentreff.jsinterpreter.This(pos)}.call(this)},get:function(){var pos,name;return function(){return pos=this._apply("anything"),name=this._apply("anything"),new users.timfelgentreff.jsinterpreter.Variable(pos,name)}.call(this)},getp:function(){var pos,slotName,obj;return function(){return pos=this._apply("anything"),slotName=this._apply("trans"),obj=this._apply("trans"),new users.timfelgentreff.jsinterpreter.GetSlot(pos,slotName,obj)}.call(this)},"break":function(){var pos;return function(){return pos=this._apply("anything"),new users.timfelgentreff.jsinterpreter.Break(pos)}.call(this)},"debugger":function(){var pos;return function(){return pos=this._apply("anything"),new users.timfelgentreff.jsinterpreter.Debugger(pos)}.call(this)},"continue":function(){var pos;return function(){return pos=this._apply("anything"),new users.timfelgentreff.jsinterpreter.Continue(pos)}.call(this)},arr:function(){var pos,elements;return function(){return pos=this._apply("anything"),elements=this._many(function(){return this._apply("trans")}),new users.timfelgentreff.jsinterpreter.ArrayLiteral(pos,elements)}.call(this)},"return":function(){var pos,expr;return function(){return pos=this._apply("anything"),expr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.Return(pos,expr)}.call(this)},"with":function(){var pos,obj,body;return function(){return pos=this._apply("anything"),obj=this._apply("trans"),body=this._apply("trans"),new users.timfelgentreff.jsinterpreter.With(pos,obj,body)}.call(this)},send:function(){var pos,property,recv,args;return function(){return pos=this._apply("anything"),property=this._apply("trans"),recv=this._apply("trans"),args=this._many(function(){return this._apply("trans")}),new users.timfelgentreff.jsinterpreter.Send(pos,property,recv,args)}.call(this)},call:function(){var pos,fn,args;return function(){return pos=this._apply("anything"),fn=this._apply("trans"),args=this._many(function(){return this._apply("trans")}),new users.timfelgentreff.jsinterpreter.Call(pos,fn,args)}.call(this)},"new":function(){var pos,clsExpr;return function(){return pos=this._apply("anything"),clsExpr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.New(pos,clsExpr)}.call(this)},"var":function(){var pos,name,val;return function(){return pos=this._apply("anything"),name=this._apply("anything"),val=this._apply("trans"),new users.timfelgentreff.jsinterpreter.VarDeclaration(pos,name,val)}.call(this)},"throw":function(){var pos,expr;return function(){return pos=this._apply("anything"),expr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.Throw(pos,expr)}.call(this)},"try":function(){var pos,trySeq,err,catchSeq,finallySeq;return function(){return pos=this._apply("anything"),trySeq=this._apply("trans"),err=this._apply("trans"),catchSeq=this._apply("trans"),finallySeq=this._apply("trans"),new users.timfelgentreff.jsinterpreter.TryCatchFinally(pos,trySeq,err,catchSeq,finallySeq)}.call(this)},func:function(){var pos,body,args;return function(){return pos=this._apply("anything"),body=this._apply("trans"),args=this._many(function(){return this._apply("trans")}),new users.timfelgentreff.jsinterpreter.Function(pos,body,args)}.call(this)},json:function(){var pos,properties;return function(){return pos=this._apply("anything"),properties=this._many(function(){return this._apply("trans")}),new users.timfelgentreff.jsinterpreter.ObjectLiteral(pos,properties)}.call(this)},binding:function(){var pos,name,property;return function(){return pos=this._apply("anything"),name=this._apply("anything"),property=this._apply("trans"),new users.timfelgentreff.jsinterpreter.ObjProperty(pos,name,property)}.call(this)},jsonGetter:function(){var pos,name,body;return function(){return pos=this._apply("anything"),name=this._apply("anything"),body=this._apply("trans"),new users.timfelgentreff.jsinterpreter.ObjPropertyGet(pos,name,body)}.call(this)},jsonSetter:function(){var pos,name,body,arg;return function(){return pos=this._apply("anything"),name=this._apply("anything"),body=this._apply("trans"),arg=this._apply("anything"),new users.timfelgentreff.jsinterpreter.ObjPropertySet(pos,name,body,arg)}.call(this)},"switch":function(){var pos,expr,cases;return function(){return pos=this._apply("anything"),expr=this._apply("trans"),cases=this._many(function(){return this._apply("trans")}),new users.timfelgentreff.jsinterpreter.Switch(pos,expr,cases)}.call(this)},"case":function(){var pos,condExpr,thenExpr;return function(){return pos=this._apply("anything"),condExpr=this._apply("trans"),thenExpr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.Case(pos,condExpr,thenExpr)}.call(this)},"default":function(){var pos,defaultExpr;return function(){return pos=this._apply("anything"),defaultExpr=this._apply("trans"),new users.timfelgentreff.jsinterpreter.Default(pos,defaultExpr)}.call(this)},regex:function(){var pos,exprString,flags;return function(){return pos=this._apply("anything"),exprString=this._apply("anything"),flags=this._apply("anything"),new users.timfelgentreff.jsinterpreter.Regex(pos,exprString,flags)}.call(this)}})}),module("users.timfelgentreff.jsinterpreter.LivelyJSParser").requires("ometa.lively").toRun(function(){LivelyJSParser=objectThatDelegatesTo(Parser,{whereAreYou:function(){return function(){var charsBefore=120,charsAfter=120,src=this._originalInput.arr,startIndex=Math.max(0,this.pos()-charsBefore),stopIndex=Math.min(src.length,this.pos()+charsAfter),msg=src.substring(startIndex,this.pos())+"<--I am here-->"+src.substring(this.pos(),stopIndex);return msg+="\nRules: "+this._ruleStack,msg+="\nStack: "+this.stack,alert(msg),!0}.call(this)},fromTo:function(){var x,y;return function(){return x=this._apply("anything"),y=this._apply("anything"),this._applyWithArgs("seq",x),this._many(function(){return function(){return this._not(function(){return this._applyWithArgs("seq",y)}),this._apply("char")}.call(this)}),this._applyWithArgs("seq",y)}.call(this)},fromToWithout:function(){var x,y;return function(){return x=this._apply("anything"),y=this._apply("anything"),this._applyWithArgs("seq",x),this._many(function(){return function(){return this._not(function(){return this._applyWithArgs("seq",y)}),this._apply("char")}.call(this)})}.call(this)},space:function(){return this._or(function(){return Parser._superApplyWithArgs(this,"space")},function(){return this._applyWithArgs("fromToWithout","//","\n")},function(){return this._applyWithArgs("fromTo","//","end")},function(){return this._applyWithArgs("fromTo","/*","*/")})},nameFirst:function(){return this._or(function(){return this._apply("letter")},function(){return function(){switch(this._apply("anything")){case"$":return"$";case"_":return"_";default:throw fail}}.call(this)})},nameRest:function(){return this._or(function(){return this._apply("nameFirst")},function(){return this._apply("digit")})},iName:function(){var r;return function(){return r=this._applyWithArgs("firstAndRest","nameFirst","nameRest"),r.join("")}.call(this)},isKeyword:function(){var x;return function(){return x=this._apply("anything"),this._pred(LivelyJSParser._isKeyword(x))
}.call(this)},name:function(){var p1,n,p2;return function(){return p1=this._apply("pos"),n=this._apply("iName"),this._not(function(){return this._applyWithArgs("isKeyword",n)}),p2=this._apply("pos"),["name",[p1,p2],n]}.call(this)},keyword:function(){var p1,k,p2;return function(){return p1=this._apply("pos"),k=this._apply("iName"),this._applyWithArgs("isKeyword",k),p2=this._apply("pos"),[k,[p1,p2],k]}.call(this)},hexDigit:function(){var x,v;return function(){return x=this._apply("char"),v=this.hexDigits.indexOf(x.toLowerCase()),this._pred(v>=0),v}.call(this)},hexLit:function(){var n,d;return this._or(function(){return function(){return n=this._apply("hexLit"),d=this._apply("hexDigit"),16*n+d}.call(this)},function(){return this._apply("hexDigit")})},number:function(){var p1,n,p2,fs,p2,ws,fs,sig,exp,p2;return function(){return p1=this._apply("pos"),this._or(function(){return function(){switch(this._apply("anything")){case"0":return function(){return this._applyWithArgs("exactly","x"),n=this._apply("hexLit"),p2=this._apply("pos"),["number",[p1,p2],n]}.call(this);case".":return function(){return fs=this._many1(function(){return this._apply("digit")}),p2=this._apply("pos"),["number",[p1,p2],parseFloat("."+fs.join(""))]}.call(this);default:throw fail}}.call(this)},function(){return function(){return ws=this._many1(function(){return this._apply("digit")}),fs=this._or(function(){return function(){switch(this._apply("anything")){case".":return this._many1(function(){return this._apply("digit")});default:throw fail}}.call(this)},function(){return function(){return this._apply("empty"),[]}.call(this)}),exp=this._or(function(){return function(){switch(this._apply("anything")){case"e":return function(){return sig=this._or(function(){return function(){switch(this._apply("anything")){case"+":return"+";case"-":return"-";default:throw fail}}.call(this)},function(){return function(){return this._apply("empty"),""}.call(this)}),this._many1(function(){return this._apply("digit")})}.call(this);default:throw fail}}.call(this)},function(){return function(){return this._apply("empty"),[]}.call(this)}),p2=this._apply("pos"),["number",[p1,p2],parseFloat(ws.join("")+"."+fs.join("")+"e"+sig+exp.join(""))]}.call(this)})}.call(this)},escapeChar:function(){var c;return function(){return this._applyWithArgs("exactly","\\"),c=this._apply("char"),ometaUnescape("\\"+c)}.call(this)},str:function(){var p1,cs,p2,cs,p2,cs,p2,n,p2;return function(){return p1=this._apply("pos"),this._or(function(){return function(){switch(this._apply("anything")){case'"':return this._or(function(){return function(){switch(this._apply("anything")){case'"':return function(){return this._applyWithArgs("exactly",'"'),cs=this._many(function(){return this._or(function(){return this._apply("escapeChar")},function(){return function(){return this._not(function(){return function(){return this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),'"""'}.call(this)}),this._apply("char")}.call(this)})}),this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),this._applyWithArgs("exactly",'"'),p2=this._apply("pos"),["string",[p1,p2],cs.join("")]}.call(this);default:throw fail}}.call(this)},function(){return function(){return cs=this._many(function(){return this._or(function(){return this._apply("escapeChar")},function(){return function(){return this._not(function(){return this._applyWithArgs("exactly",'"')}),this._apply("char")}.call(this)})}),this._applyWithArgs("exactly",'"'),p2=this._apply("pos"),["string",[p1,p2],cs.join("")]}.call(this)});case"'":return function(){return cs=this._many(function(){return this._or(function(){return this._apply("escapeChar")},function(){return function(){return this._not(function(){return this._applyWithArgs("exactly","'")}),this._apply("char")}.call(this)})}),this._applyWithArgs("exactly","'"),p2=this._apply("pos"),["string",[p1,p2],cs.join("")]}.call(this);default:throw fail}}.call(this)},function(){return function(){return function(){switch(this._apply("anything")){case"#":return"#";case"`":return"`";default:throw fail}}.call(this),n=this._apply("iName"),p2=this._apply("pos"),["string",[p1,p2],n]}.call(this)})}.call(this)},special:function(){var p1,s,p2;return function(){return p1=this._apply("pos"),s=function(){switch(this._apply("anything")){case"(":return"(";case")":return")";case"{":return"{";case"}":return"}";case"[":return"[";case"]":return"]";case",":return",";case";":return";";case"?":return"?";case":":return":";case"!":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"!==";default:throw fail}}.call(this)},function(){return"!="});default:throw fail}}.call(this)},function(){return"!"});case"=":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"===";default:throw fail}}.call(this)},function(){return"=="});default:throw fail}}.call(this)},function(){return"="});case">":return this._or(function(){return function(){switch(this._apply("anything")){case">":return this._or(function(){return function(){switch(this._apply("anything")){case">":return">>>";case"=":return">>=";default:throw fail}}.call(this)},function(){return">>"});case"=":return">=";default:throw fail}}.call(this)},function(){return">"});case"<":return this._or(function(){return function(){switch(this._apply("anything")){case"<":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"<<=";default:throw fail}}.call(this)},function(){return"<<"});case"=":return"<=";default:throw fail}}.call(this)},function(){return"<"});case"+":return this._or(function(){return function(){switch(this._apply("anything")){case"+":return"++";case"=":return"+=";default:throw fail}}.call(this)},function(){return"+"});case"-":return this._or(function(){return function(){switch(this._apply("anything")){case"-":return"--";case"=":return"-=";default:throw fail}}.call(this)},function(){return"-"});case"*":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"*=";default:throw fail}}.call(this)},function(){return"*"});case"~":return"~";case"/":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"/=";default:throw fail}}.call(this)},function(){return"/"});case"%":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"%=";default:throw fail}}.call(this)},function(){return"%"});case"&":return this._or(function(){return function(){switch(this._apply("anything")){case"&":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"&&=";default:throw fail}}.call(this)},function(){return"&&"});default:throw fail}}.call(this)},function(){return"&"});case"|":return this._or(function(){return function(){switch(this._apply("anything")){case"|":return this._or(function(){return function(){switch(this._apply("anything")){case"=":return"||=";default:throw fail}}.call(this)},function(){return"||"});default:throw fail}}.call(this)},function(){return"|"});case".":return".";case"^":return"^";default:throw fail}}.call(this),p2=this._apply("pos"),[s,[p1,p2],s]}.call(this)},tok:function(){return function(){return this._apply("spaces"),this._or(function(){return this._apply("name")},function(){return this._apply("keyword")},function(){return this._apply("number")},function(){return this._apply("str")},function(){return this._apply("special")})}.call(this)},toks:function(){var ts;return function(){return ts=this._many(function(){return this._apply("token")}),this._apply("spaces"),this._apply("end"),ts}.call(this)},token:function(){var tt,t;return function(){return tt=this._apply("anything"),t=this._apply("tok"),this._pred(t[0]==tt),t[2]}.call(this)},spacesNoNl:function(){return this._many(function(){return function(){return this._not(function(){return this._applyWithArgs("exactly","\n")}),this._apply("space")}.call(this)})},expr:function(){var p1,f,s,p2;return this._or(function(){return function(){return p1=this._apply("pos"),f=this._apply("exprPart"),this._applyWithArgs("token",","),s=this._apply("expr"),p2=this._apply("pos"),["begin",[p1,p2],f,s]}.call(this)},function(){return this._apply("exprPart")})},exprPart:function(){var p1,e,t,f,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2,rhs,p2;return function(){return p1=this._apply("pos"),e=this._apply("ternaryExpr"),this._or(function(){return function(){return this._applyWithArgs("token","?"),t=this._apply("exprPart"),this._applyWithArgs("token",":"),f=this._apply("exprPart"),p2=this._apply("pos"),["condExpr",[p1,p2],e,t,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["set",[p1,p2],e,rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","+="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"+",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","-="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"-",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","*="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"*",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","/="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"/",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","%="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"%",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","&="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"&",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","&&="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"&&",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","|="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"|",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","||="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"||",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","^="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"^",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token",">>="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,">>",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token","<<="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,"<<",rhs]}.call(this)},function(){return function(){return this._applyWithArgs("token",">>>="),rhs=this._apply("exprPart"),p2=this._apply("pos"),["mset",[p1,p2],e,">>>",rhs]}.call(this)},function(){return function(){return this._apply("empty"),e}.call(this)})}.call(this)},ternaryExpr:function(){var p1,e,t,f,p2;return function(){return p1=this._apply("pos"),e=this._apply("orExpr"),this._or(function(){return function(){return this._applyWithArgs("token","?"),t=this._apply("orExpr"),this._applyWithArgs("token",":"),f=this._apply("orExpr"),p2=this._apply("pos"),["condExpr",[p1,p2],e,t,f]}.call(this)},function(){return function(){return this._apply("empty"),e}.call(this)})}.call(this)},orExpr:function(){var p1,x,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("orExpr"),this._applyWithArgs("token","||"),y=this._apply("andExpr"),p2=this._apply("pos"),["binop",[p1,p2],"||",x,y]}.call(this)},function(){return this._apply("andExpr")})},andExpr:function(){var p1,x,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("andExpr"),this._applyWithArgs("token","&&"),y=this._apply("bitOrExpr"),p2=this._apply("pos"),["binop",[p1,p2],"&&",x,y]}.call(this)},function(){return this._apply("bitOrExpr")})},bitOrExpr:function(){var p1,x,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("bitXorExpr"),this._applyWithArgs("token","|"),y=this._apply("bitOrExpr"),p2=this._apply("pos"),["binop",[p1,p2],"|",x,y]}.call(this)},function(){return this._apply("bitXorExpr")})},bitXorExpr:function(){var p1,x,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("bitAndExpr"),this._applyWithArgs("token","^"),y=this._apply("bitXorExpr"),p2=this._apply("pos"),["binop",[p1,p2],"^",x,y]}.call(this)},function(){return this._apply("bitAndExpr")})},bitAndExpr:function(){var p1,x,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("eqExpr"),this._applyWithArgs("token","&"),y=this._apply("bitAndExpr"),p2=this._apply("pos"),["binop",[p1,p2],"&",x,y]}.call(this)},function(){return this._apply("eqExpr")})},eqExpr:function(){var p1,x,op,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("eqExpr"),op=this._or(function(){return this._applyWithArgs("token","==")},function(){return this._applyWithArgs("token","!=")},function(){return this._applyWithArgs("token","===")},function(){return this._applyWithArgs("token","!==")}),y=this._apply("relExpr"),p2=this._apply("pos"),["binop",[p1,p2],op,x,y]}.call(this)},function(){return this._apply("relExpr")})},relExpr:function(){var p1,x,op,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("relExpr"),op=this._or(function(){return this._applyWithArgs("token",">")},function(){return this._applyWithArgs("token",">=")},function(){return this._applyWithArgs("token","<")},function(){return this._applyWithArgs("token","<=")},function(){return this._applyWithArgs("token","instanceof")},function(){return this._applyWithArgs("token","in")}),y=this._apply("shiftExpr"),p2=this._apply("pos"),["binop",[p1,p2],op,x,y]}.call(this)},function(){return this._apply("shiftExpr")})},shiftExpr:function(){var p1,x,op,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("shiftExpr"),op=this._or(function(){return this._applyWithArgs("token",">>")},function(){return this._applyWithArgs("token","<<")},function(){return this._applyWithArgs("token",">>>")}),y=this._apply("addExpr"),p2=this._apply("pos"),["binop",[p1,p2],op,x,y]}.call(this)},function(){return this._apply("addExpr")})},addExpr:function(){var p1,x,op,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("addExpr"),op=this._or(function(){return this._applyWithArgs("token","+")},function(){return this._applyWithArgs("token","-")}),y=this._apply("mulExpr"),p2=this._apply("pos"),["binop",[p1,p2],op,x,y]}.call(this)},function(){return this._apply("mulExpr")})},mulExpr:function(){var p1,x,op,y,p2;return this._or(function(){return function(){return p1=this._apply("pos"),x=this._apply("mulExpr"),op=this._or(function(){return this._applyWithArgs("token","*")},function(){return this._applyWithArgs("token","/")},function(){return this._applyWithArgs("token","%")}),y=this._apply("unary"),p2=this._apply("pos"),["binop",[p1,p2],op,x,y]}.call(this)},function(){return this._apply("unary")})},unary:function(){var p1,p,p2,p,p2,p,p2,p,p2,p,p2,p,p2,p,p2,p,p2,p,p2;return this._or(function(){return function(){return p1=this._apply("pos"),this._or(function(){return function(){return this._applyWithArgs("token","-"),p=this._apply("postfix"),p2=this._apply("pos"),["unop",[p1,p2],"-",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","+"),p=this._apply("postfix"),p2=this._apply("pos"),["unop",[p1,p2],"+",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","++"),p=this._apply("postfix"),p2=this._apply("pos"),["preop",[p1,p2],"++",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","--"),p=this._apply("postfix"),p2=this._apply("pos"),["preop",[p1,p2],"--",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","!"),p=this._apply("unary"),p2=this._apply("pos"),["unop",[p1,p2],"!",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","~"),p=this._apply("unary"),p2=this._apply("pos"),["unop",[p1,p2],"~",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","void"),p=this._apply("unary"),p2=this._apply("pos"),["unop",[p1,p2],"void",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","delete"),p=this._apply("unary"),p2=this._apply("pos"),["unop",[p1,p2],"delete",p]}.call(this)},function(){return function(){return this._applyWithArgs("token","typeof"),p=this._apply("unary"),p2=this._apply("pos"),["unop",[p1,p2],"typeof",p]}.call(this)})}.call(this)},function(){return this._apply("postfix")})},postfix:function(){var p1,p,p2,p2;return function(){return p1=this._apply("pos"),p=this._apply("callExpr"),this._or(function(){return function(){return this._apply("spacesNoNl"),this._applyWithArgs("token","++"),p2=this._apply("pos"),["postop",[p1,p2],"++",p]}.call(this)},function(){return function(){return this._apply("spacesNoNl"),this._applyWithArgs("token","--"),p2=this._apply("pos"),["postop",[p1,p2],"--",p]}.call(this)},function(){return function(){return this._apply("empty"),p}.call(this)})}.call(this)},args:function(){var as;return function(){return this._applyWithArgs("token","("),as=this._applyWithArgs("listOf","exprPart",","),this._applyWithArgs("token",")"),as}.call(this)},callExpr:function(){var p1,p,as,p2,p3,m,p4,as,p2,i,as,p2,i,p2,p3,f,p2;return this._or(function(){return function(){return p1=this._apply("pos"),p=this._apply("callExpr"),this._or(function(){return function(){return as=this._apply("args"),p2=this._apply("pos"),["call",[p1,p2],p].concat(as)}.call(this)},function(){return function(){return this._applyWithArgs("token","."),p3=this._apply("pos"),m=this._applyWithArgs("token","name"),p4=this._apply("pos"),as=this._apply("args"),p2=this._apply("pos"),["send",[p1,p2],["string",[p3,p4],m],p].concat(as)}.call(this)},function(){return function(){return this._applyWithArgs("token","["),i=this._apply("expr"),this._applyWithArgs("token","]"),as=this._apply("args"),p2=this._apply("pos"),["send",[p1,p2],i,p].concat(as)}.call(this)},function(){return function(){return this._applyWithArgs("token","["),i=this._apply("expr"),this._applyWithArgs("token","]"),p2=this._apply("pos"),["getp",[p1,p2],i,p]}.call(this)},function(){return function(){return this._applyWithArgs("token","."),p3=this._apply("pos"),f=this._applyWithArgs("token","name"),p2=this._apply("pos"),["getp",[p1,p2],["string",[p3,p2],f],p]}.call(this)})}.call(this)},function(){return this._apply("primExpr")})},memberExpr:function(){var p1,p,i,p2,p3,f,p2;return this._or(function(){return function(){return p1=this._apply("pos"),p=this._apply("memberExpr"),this._or(function(){return function(){return this._applyWithArgs("token","["),i=this._apply("expr"),this._applyWithArgs("token","]"),p2=this._apply("pos"),["getp",[p1,p2],i,p]}.call(this)},function(){return function(){return this._applyWithArgs("token","."),p3=this._apply("pos"),f=this._applyWithArgs("token","name"),p2=this._apply("pos"),["getp",[p1,p2],["string",[p3,p2],f],p]}.call(this)})}.call(this)},function(){return this._apply("primExpr")})},primExpr:function(){var e,p1,p2,p3,e,as,p2,n,p2,n,p2,s,p2,es,p2,e,f,p2;return this._or(function(){return function(){return this._applyWithArgs("token","("),e=this._apply("expr"),this._applyWithArgs("token",")"),e}.call(this)},function(){return function(){return this._apply("spaces"),p1=this._apply("pos"),this._or(function(){return function(){return this._applyWithArgs("token","this"),p2=this._apply("pos"),["this",[p1,p2]]}.call(this)},function(){return function(){return this._applyWithArgs("token","new"),p3=this._apply("pos"),e=this._apply("memberExpr"),as=this._or(function(){return this._apply("args")},function(){return function(){return this._apply("empty"),[]}.call(this)}),p2=this._apply("pos"),["new",[p1,p2],["call",[p3,p2],e].concat(as)]}.call(this)},function(){return function(){return n=this._applyWithArgs("token","name"),p2=this._apply("pos"),["get",[p1,p2],n]}.call(this)},function(){return function(){return n=this._applyWithArgs("token","number"),p2=this._apply("pos"),["number",[p1,p2],n]}.call(this)},function(){return function(){return s=this._applyWithArgs("token","string"),p2=this._apply("pos"),["string",[p1,p2],s]}.call(this)},function(){return function(){return this._applyWithArgs("token","function"),this._or(function(){return this._applyWithArgs("token","name")},function(){return this._apply("empty")}),this._apply("funcRest")}.call(this)},function(){return function(){return this._applyWithArgs("token","["),es=this._applyWithArgs("listOf","exprPart",","),this._or(function(){return this._applyWithArgs("token",",")},function(){return this._apply("empty")}),this._applyWithArgs("token","]"),p2=this._apply("pos"),["arr",[p1,p2]].concat(es)}.call(this)},function(){return function(){return this._applyWithArgs("token","/"),e=this._many(function(){return this._or(function(){return this._apply("escapeChar")},function(){return function(){return this._not(function(){return this._applyWithArgs("exactly","/")}),this._apply("char")}.call(this)})}),this._applyWithArgs("token","/"),f=this._many(function(){return this._apply("letter")}),p2=this._apply("pos"),["regex",[p1,p2],e.join(""),f.join("")]}.call(this)})}.call(this)},function(){return this._apply("json")})},json:function(){var p1,bs,p2;return function(){return p1=this._apply("pos"),this._applyWithArgs("token","{"),bs=this._applyWithArgs("listOf","jsonBinding",","),this._or(function(){return this._applyWithArgs("token",",")},function(){return this._apply("empty")}),this._applyWithArgs("token","}"),p2=this._apply("pos"),["json",[p1,p2]].concat(bs)}.call(this)},jsonBinding:function(){var p1,n,v,p2;return this._or(function(){return this._apply("jsonGetter")},function(){return this._apply("jsonSetter")},function(){return function(){return p1=this._apply("pos"),n=this._apply("jsonPropName"),this._applyWithArgs("token",":"),v=this._apply("exprPart"),p2=this._apply("pos"),["binding",[p1,p2],n,v]}.call(this)})},jsonGetter:function(){var p1,n,body,p2;return function(){return this._apply("spaces"),p1=this._apply("pos"),this._applyWithArgs("exactly","g"),this._applyWithArgs("exactly","e"),this._applyWithArgs("exactly","t"),n=this._apply("jsonPropName"),this._applyWithArgs("token","("),this._applyWithArgs("token",")"),this._applyWithArgs("token","{"),body=this._apply("srcElems"),this._applyWithArgs("token","}"),p2=this._apply("pos"),["jsonGetter",[p1,p2],n,body]}.call(this)},jsonSetter:function(){var p1,n,arg,body,p2;return function(){return this._apply("spaces"),p1=this._apply("pos"),this._applyWithArgs("exactly","s"),this._applyWithArgs("exactly","e"),this._applyWithArgs("exactly","t"),n=this._apply("jsonPropName"),this._applyWithArgs("token","("),arg=this._applyWithArgs("token","name"),this._applyWithArgs("token",")"),this._applyWithArgs("token","{"),body=this._apply("srcElems"),this._applyWithArgs("token","}"),p2=this._apply("pos"),["jsonSetter",[p1,p2],n,body,arg]}.call(this)},jsonPropName:function(){return this._or(function(){return this._applyWithArgs("token","name")},function(){return this._applyWithArgs("token","number")},function(){return this._applyWithArgs("token","string")})},memberFragment:function(){var jb;return function(){return this._apply("spaces"),jb=this._apply("jsonBinding"),this._or(function(){return function(){switch(this._apply("anything")){case",":return",";default:throw fail}}.call(this)},function(){return this._apply("empty")}),this._apply("spaces"),this._apply("end"),jb}.call(this)},categoryFragment:function(){var p1,es,p2;return function(){return this._apply("spaces"),p1=this._apply("pos"),es=this._applyWithArgs("listOf","exprPart",","),p2=this._apply("pos"),this._or(function(){return this._applyWithArgs("token",",")},function(){return this._apply("empty")}),this._apply("spaces"),this._apply("end"),["arr",[p1,p2]].concat(es)}.call(this)},traitFragment:function(){var p1,es,p2;return function(){return this._apply("spaces"),p1=this._apply("pos"),this._applyWithArgs("token","name"),this._applyWithArgs("token","("),this._apply("spaces"),es=this._applyWithArgs("listOf","exprPart",","),this._apply("spaces"),this._applyWithArgs("token",")"),this._apply("spaces"),this._apply("sc"),p2=this._apply("pos"),this._apply("spaces"),this._apply("end"),["arr",[p1,p2]].concat(es)}.call(this)},formal:function(){var p1,n,p2;return function(){return this._apply("spaces"),p1=this._apply("pos"),n=this._applyWithArgs("token","name"),p2=this._apply("pos"),["get",[p1,p2],n]}.call(this)},funcRest:function(){var p1,args,body,p2;return function(){return p1=this._apply("pos"),this._applyWithArgs("token","("),args=this._applyWithArgs("listOf","formal",","),this._applyWithArgs("token",")"),this._applyWithArgs("token","{"),body=this._apply("srcElems"),this._applyWithArgs("token","}"),p2=this._apply("pos"),["func",[p1,p2],body].concat(args)}.call(this)},sc:function(){return this._or(function(){return function(){return this._apply("spacesNoNl"),this._or(function(){return function(){switch(this._apply("anything")){case"\n":return"\n";default:throw fail}}.call(this)},function(){return this._lookahead(function(){return this._applyWithArgs("exactly","}")})},function(){return this._apply("end")})}.call(this)},function(){return this._applyWithArgs("token",";")})},binding:function(){var p1,n,p,v,p2;return function(){return p1=this._apply("pos"),n=this._applyWithArgs("token","name"),v=this._or(function(){return function(){return this._applyWithArgs("token","="),this._apply("exprPart")}.call(this)},function(){return function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"undefined"]}.call(this)}),p2=this._apply("pos"),["var",[p1,p2],n,v]}.call(this)},bindingList:function(){var p1,bs,p2;return function(){return p1=this._apply("pos"),bs=this._applyWithArgs("listOf","binding",","),p2=this._apply("pos"),["begin",[p1,p2]].concat(bs)}.call(this)},block:function(){var ss;return function(){return this._applyWithArgs("token","{"),ss=this._apply("srcElems"),this._applyWithArgs("token","}"),ss}.call(this)},stmt:function(){var p1,bs,p2,c,t,p,f,p2,c,s,p2,s,c,p2,p,i,p,c,p,u,s,p2,p3,n,p4,n,p4,v,e,s,p2,e,p3,c,cs,p4,p3,cs,p4,cs,p2,p2,p2,p2,e,p2,t,e,p,e,c,p,f,p2,p,e,p2,x,s,p2,e,p2;return this._or(function(){return this._apply("block")},function(){return function(){return this._apply("spaces"),p1=this._apply("pos"),this._or(function(){return function(){return this._applyWithArgs("token","var"),bs=this._apply("bindingList"),this._apply("sc"),p2=this._apply("pos"),bs}.call(this)},function(){return function(){return this._applyWithArgs("token","if"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),t=this._apply("stmt"),f=this._or(function(){return function(){return this._applyWithArgs("token","else"),this._apply("stmt")}.call(this)},function(){return function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"undefined"]}.call(this)}),this._or(function(){return this._apply("sc")},function(){return this._apply("empty")}),p2=this._apply("pos"),["if",[p1,p2],c,t,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","while"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),p2=this._apply("pos"),["while",[p1,p2],c,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","do"),s=this._apply("stmt"),this._applyWithArgs("token","while"),this._applyWithArgs("token","("),c=this._apply("expr"),this._applyWithArgs("token",")"),this._apply("sc"),p2=this._apply("pos"),["doWhile",[p1,p2],s,c]}.call(this)},function(){return function(){return this._applyWithArgs("token","for"),this._applyWithArgs("token","("),i=this._or(function(){return function(){return this._applyWithArgs("token","var"),this._apply("bindingList")}.call(this)},function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"undefined"]}.call(this)}),this._applyWithArgs("token",";"),c=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"true"]}.call(this)}),this._applyWithArgs("token",";"),u=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"undefined"]}.call(this)}),this._applyWithArgs("token",")"),s=this._apply("stmt"),p2=this._apply("pos"),["for",[p1,p2],i,c,s,u]}.call(this)},function(){return function(){return this._applyWithArgs("token","for"),this._applyWithArgs("token","("),v=this._or(function(){return function(){return p3=this._apply("pos"),this._applyWithArgs("token","var"),n=this._applyWithArgs("token","name"),p4=this._apply("pos"),["var",[p3,p4],n,["get",[p3,p3],"undefined"]]}.call(this)},function(){return function(){return n=this._applyWithArgs("token","name"),p4=this._apply("pos"),["get",[p3,p4],n]}.call(this)}),this._applyWithArgs("token","in"),e=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),p2=this._apply("pos"),["forIn",[p1,p2],v,e,s]}.call(this)},function(){return function(){return this._applyWithArgs("token","switch"),this._applyWithArgs("token","("),e=this._apply("expr"),this._applyWithArgs("token",")"),this._applyWithArgs("token","{"),cs=this._many(function(){return this._or(function(){return function(){return p3=this._apply("pos"),this._applyWithArgs("token","case"),c=this._apply("expr"),this._applyWithArgs("token",":"),cs=this._apply("srcElems"),p4=this._apply("pos"),["case",[p3,p4],c,cs]}.call(this)},function(){return function(){return p3=this._apply("pos"),this._applyWithArgs("token","default"),this._applyWithArgs("token",":"),cs=this._apply("srcElems"),p4=this._apply("pos"),["default",[p3,p4],cs]}.call(this)})}),this._applyWithArgs("token","}"),p2=this._apply("pos"),["switch",[p1,p2],e].concat(cs)}.call(this)},function(){return function(){return this._applyWithArgs("token","break"),this._apply("sc"),p2=this._apply("pos"),["break",[p1,p2]]}.call(this)},function(){return function(){return this._applyWithArgs("token","debugger"),this._apply("sc"),p2=this._apply("pos"),["debugger",[p1,p2]]}.call(this)},function(){return function(){return this._applyWithArgs("token","continue"),this._apply("sc"),p2=this._apply("pos"),["continue",[p1,p2]]}.call(this)},function(){return function(){return this._applyWithArgs("token","throw"),this._apply("spacesNoNl"),e=this._apply("expr"),this._apply("sc"),p2=this._apply("pos"),["throw",[p1,p2],e]}.call(this)},function(){return function(){return this._applyWithArgs("token","try"),t=this._apply("block"),c=this._or(function(){return function(){return this._applyWithArgs("token","catch"),this._applyWithArgs("token","("),e=this._apply("formal"),this._applyWithArgs("token",")"),this._apply("block")}.call(this)},function(){return e=function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"undefined"]}.call(this)}),f=this._or(function(){return function(){return this._applyWithArgs("token","finally"),this._apply("block")}.call(this)},function(){return function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"undefined"]}.call(this)}),p2=this._apply("pos"),["try",[p1,p2],t,e,c,f]}.call(this)},function(){return function(){return this._applyWithArgs("token","return"),e=this._or(function(){return this._apply("expr")},function(){return function(){return this._apply("empty"),p=this._apply("pos"),["get",[p,p],"undefined"]}.call(this)
}),this._apply("sc"),p2=this._apply("pos"),["return",[p1,p2],e]}.call(this)},function(){return function(){return this._applyWithArgs("token","with"),this._applyWithArgs("token","("),x=this._apply("expr"),this._applyWithArgs("token",")"),s=this._apply("stmt"),p2=this._apply("pos"),["with",[p1,p2],x,s]}.call(this)},function(){return function(){return e=this._apply("expr"),this._apply("sc"),e}.call(this)},function(){return function(){return this._applyWithArgs("token",";"),p2=this._apply("pos"),["get",[p1,p2],"undefined"]}.call(this)})}.call(this)})},functionDef:function(){var p1,n,f,p2;return function(){return p1=this._apply("pos"),this._applyWithArgs("token","function"),n=this._applyWithArgs("token","name"),f=this._apply("funcRest"),p2=this._apply("pos"),["var",[p1,p2],n,f]}.call(this)},functionDefFragment:function(){var f;return function(){return f=this._apply("functionDef"),this._apply("spaces"),this._apply("end"),f}.call(this)},functionDefsFragment:function(){var p1,fs,p2;return function(){return p1=this._apply("pos"),fs=this._many(function(){return this._apply("functionDef")}),p2=this._apply("pos"),this._apply("spaces"),this._apply("end"),["arr",[p1,p2]].concat(fs)}.call(this)},srcElem:function(){return this._or(function(){return this._apply("functionDef")},function(){return this._apply("stmt")})},srcElems:function(){var p1,ss,p2;return function(){return p1=this._apply("pos"),ss=this._many(function(){return this._apply("srcElem")}),p2=this._apply("pos"),["begin",[p1,p2]].concat(ss)}.call(this)},topLevel:function(){var r;return function(){return r=this._apply("srcElems"),this._apply("spaces"),this._apply("end"),r}.call(this)}})}),module("users.timfelgentreff.jsinterpreter.Parser").requires("lively.Ometa","users.timfelgentreff.jsinterpreter.generated.Translator","users.timfelgentreff.jsinterpreter.generated.Nodes","users.timfelgentreff.jsinterpreter.LivelyJSParser").toRun(function(){Object.extend(LivelyJSParser,{hexDigits:"0123456789abcdef",keywords:function(){for(var keywordWithIdx={},keywords=["break","case","catch","continue","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with","ometa","debugger"],idx=0;idx<keywords.length;idx++)keywordWithIdx[keywords[idx]]=!0;return keywordWithIdx}(),_isKeyword:function(k){return this.keywords[k]===!0}}),Object.extend(users.timfelgentreff.jsinterpreter.Parser,{jsParser:LivelyJSParser,astTranslator:JSTranslator,basicParse:function(source,rule){var errorHandler=function(){throw Array.from(arguments)},intermediate=OMetaSupport.matchAllWithGrammar(this.jsParser,rule,source,errorHandler);if(!intermediate||Object.isString(intermediate))throw[source,rule,"Could not parse JS source code",0,intermediate];var ast=OMetaSupport.matchWithGrammar(this.astTranslator,"trans",intermediate);if(!ast||Object.isString(ast))throw[source,rule,"Could not translate symbolic AST tree",0,intermediate,ast];return ast.source=source,ast},parse:function(src,optRule){return this.basicParse(src,optRule||"topLevel")}}),users.timfelgentreff.jsinterpreter.Node.addMethods("accessing",{setParent:function(parentNode){return this._parent=parentNode},getParent:function(){return this._parent},hasParent:function(){return void 0!=this._parent},parentSequence:function(){return this.hasParent()&&this.getParent().parentSequence()},parentFunction:function(){return this.hasParent()&&this.getParent().parentFunction()},astIndex:function(){var parentFunc=this.parentFunction();if(!parentFunc)throw new Error("astIndex: cannot get parent fucntion of "+this);return parentFunc.linearlyListNodesWithoutNestedFunctions().indexOf(this)},nodeForAstIndex:function(idx){return this.linearlyListNodesWithoutNestedFunctions()[idx]}},"testing",{isASTNode:!0,isUndefined:function(expr){return expr.isVariable&&"undefined"===expr.name}},"enumerating",{withAllChildNodesDo:function(func,parent,nameInParent,depth){var node=this,shouldContinue=func(node,parent,nameInParent,depth||0);shouldContinue&&this.doForAllChildNodes(function(childNode,nameInParent){childNode.withAllChildNodesDo(func,node,nameInParent,depth?depth+1:1)})},withAllChildNodesDoPostOrder:function(func,stopFunc,parent,nameInParent,depth){var node=this,shouldStop=stopFunc&&stopFunc(node,parent,nameInParent,depth||0);shouldStop||(this.doForAllChildNodes(function(childNode,nameInParent){childNode.withAllChildNodesDoPostOrder(func,stopFunc,node,nameInParent,depth?depth+1:1)}),func(node,parent,nameInParent,depth||0))},doForAllChildNodes:function(func){for(var name in this)if(this.hasOwnProperty(name)&&"_parent"!=name){var value=this[name];value.isASTNode?func(value,name,null):Object.isArray(value)&&value.forEach(function(item,i){item.isASTNode&&func(item,name,i)})}},nodesMatching:function(matchFunc){var result=[];return this.withAllChildNodesDo(function(node,parent,nameInParent,depth){return matchFunc(node,parent,nameInParent,depth)&&result.push(node),!0}),result},linearlyListNodes:function(){var nodes=[];return this.withAllChildNodesDoPostOrder(function(node){nodes.push(node)}),nodes},linearlyListNodesWithoutNestedFunctions:function(){var root=this,nodes=[];return this.withAllChildNodesDoPostOrder(function(node){nodes.push(node)},function(node){return node.isFunction&&node!==root}),nodes},isAfter:function(other){var that=this,first=null;return this.parentFunction().body.withAllChildNodesDo(function(node){return first||(node===that&&(first=that),node===other&&(first=other)),!first}),first===other}},"replacing",{replaceNodesMatching:function(testFunc,replacementNodeOrFunction){var nodes=this.nodesMatching(testFunc);return nodes.forEach(function(node){var parent=node.getParent();if(!parent)throw new Error("No parent for node in replaceNodesMatching "+node);var replacementNode="function"==typeof replacementNodeOrFunction?replacementNodeOrFunction(node):replacementNodeOrFunction;parent.replaceChildNode(node,replacementNode)}),this},replaceWith:function(otherNode){if(!this.hasParent())throw new Error("Need parent node for replaceWith but cannot find it "+this);return this.getParent().replaceChildNode(this,otherNode),otherNode},replaceChildNode:function(childNode,newNode){var slotName,idx;if(this.doForAllChildNodes(function(node,nameInParent,i){node===childNode&&(slotName=nameInParent,idx=i)}),void 0===slotName)throw new Error("Cannot find childNode in me! (#replaceChildNode)");void 0===idx||null===idx?this[slotName]=newNode:this[slotName][idx]=newNode,newNode.setParent(this)}},"evaluation",{eval:function(){var result,js;try{js=this.asJS();var src="("+js+")";result=eval(src)}catch(e){alert("Could not eval "+js+" because:\n"+e+"\n"+e.stack)}return result}},"debugging",{error:function(msg){throw new Error(msg)},indent:function(depth){return Strings.indent(""," ",depth)},toString:function(){return this.constructor.name},printTree:function(postOrder){var nodeStrings=[],idx=0,enumFunc=postOrder?"withAllChildNodesDoPostOrder":"withAllChildNodesDo";return this[enumFunc](function(node,parent,nameInParent,depth){return nodeStrings.push(idx.toString()+" "+Strings.indent(node.constructor.name+"("+nameInParent+")"," ",depth)),idx++,!0}),nodeStrings.join("\n")},printConstructorCall:function(){for(var call="new "+this.constructor.type+"(",argCalls=[],i=0;i<arguments.length;i++){var arg=arguments[i],argCall="";Object.isArray(arg)?(argCall+="[",argCall+=arg.collect(function(ea){return ea.isASTNode?ea.printConstruction():ea}).join(","),argCall+="]"):argCall+=arg.isASTNode?arg.printConstruction():arg,argCalls.push(argCall)}return call+=argCalls.join(","),call+=")"}},"stepping",{firstStatement:function(){return this},nextStatement:function(){var stmt=this.getParent().nextStatement(this);return stmt?stmt.firstStatement():null},isComposite:function(){return!1}},"matching",{match:function(patternAst){var matchedPlaceholder=!0;for(var key in patternAst){var result=this.matchVal(key,this[key],patternAst[key]);result!==!0&&(matchedPlaceholder=result)}return matchedPlaceholder},matchVal:function(key,value,pattern){if(pattern===users.timfelgentreff.jsinterpreter.Node.placeholder)return value;if(value==pattern)return!0;if(Object.isString(pattern)){if(value.toString()==pattern)return!0;if(value.value==pattern)return!0;if(value.name==pattern)return!0}if(Object.isArray(pattern)&&Object.isArray(value)){for(var matchedPlaceholder=!0,i=0;i<pattern.length;i++){for(var success=!1,lastError=null,j=0;j<value.length;j++)try{var res=this.matchVal(key,value[j],pattern[i]);res!==!0&&(matchedPlaceholder=res),success=!0}catch(e){lastError=e}if(!success)throw lastError}if(value.length!==pattern.length)throw{key:key,err:"count",expected:pattern.length,actual:value.length};return matchedPlaceholder}if(Object.isObject(pattern)&&value.isASTNode)return value.match(pattern);throw{key:key,err:"missmatch",expected:String(pattern),actual:String(value)}}}),Object.subclass("users.timfelgentreff.jsinterpreter.SourceGenerator","documentation",{usage:"gen = new users.timfelgentreff.jsinterpreter.SourceGenerator();\ngen.writeAndEvalTranslator();\ngen.evalAndWriteClasses();\nusers.timfelgentreff.jsinterpreter.Parser.astTranslator = JSTranslator;\nusers.timfelgentreff.jsinterpreter.Parser.jsParser = LivelyJSParser;",showUsage:function(){$world.addTextWindow({content:this.usage,title:"users.timfelgentreff.jsinterpreter.SourceGenerator usage"})}},"settings",{customRules:function(){return["trans = [:t apply(t):ans] -> ans,"]},customClasses:function(){return["Object.subclass('"+this.rootNodeClassName+"')"]},translatorRules:function(){var names=this.constructor.categories["translator rules"],result={};return names.forEach(function(name){result[name]=this[name]},this),result},modulePath:"users.timfelgentreff.jsinterpreter.",rootNodeClassName:"users.timfelgentreff.jsinterpreter.Node",visitorClassName:"users.timfelgentreff.jsinterpreter.Visitor"},"translator rules",{begin:{className:"Sequence",rules:[":pos","trans*:children","end"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.children)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.children.join(","))}},conversion:{asJS:function(depth){var indent=this.indent(depth||0);return depth=depth||-1,this.children.invoke("asJS",depth+1).join(";\n"+indent)}},insertion:{insertBefore:function(newNode,existingNode){for(var i=0;i<this.children.length&&!(this.children[i].nodesMatching(function(node){return node===existingNode}).length>0);i++);if(!this.children[i])throw dbgOn(new Error("insertBefore: "+existingNode+" not in "+this));return this.insertAt(newNode,i)},insertAt:function(newNode,idx){return this.children.pushAt(newNode,idx),newNode.setParent(this),newNode}},accessing:{parentSequence:function(){return this}},stepping:{firstStatement:function(){return this.children.length>0?this.children[0].firstStatement():this},nextStatement:function($super,node){var idx=this.children.indexOf(node);return idx>=0&&idx<this.children.length-1?this.children[idx+1]:$super(this)},isComposite:function(){return!0}}},number:{className:"Number",rules:[":pos",":value"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.pos,this.value)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.value)}},conversion:{asJS:function(){return this.value}}},string:{className:"String",rules:[":pos",":value"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.value+'"')},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.value)}},conversion:{asJS:function(){return'"'+this.value+'"'}}},condExpr:{className:"Cond",rules:[":pos","trans:condExpr","trans:trueExpr","trans:falseExpr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.trueExpr,this.falseExpr)},toString:function(){return Strings.format("%s(%s?%s:%s)",this.constructor.name,this.condExpr,this.trueExpr,this.falseExpr)}},conversion:{asJS:function(depth){return Strings.format("(%s) ? (%s) : (%s)",this.condExpr.asJS(depth),this.trueExpr.asJS(depth),this.falseExpr.asJS(depth))}}},"if":{className:"If",rules:[":pos","trans:condExpr","trans:trueExpr","trans:falseExpr"],initializing:{initialize:function($super,pos,condExpr,trueExpr,falseExpr){this.pos=pos,this.condExpr=condExpr,this.trueExpr=trueExpr.isSequence||this.isUndefined(trueExpr)?trueExpr:new users.timfelgentreff.jsinterpreter.Sequence(trueExpr.pos,[trueExpr]),this.falseExpr=falseExpr.isSequence||this.isUndefined(falseExpr)?falseExpr:new users.timfelgentreff.jsinterpreter.Sequence(trueExpr.pos,[falseExpr]),condExpr.setParent(this),this.trueExpr.setParent(this),this.falseExpr.setParent(this)}},debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.trueExpr,this.falseExpr)},toString:function(){return Strings.format("%s(%s?%s:%s)",this.constructor.name,this.condExpr,this.trueExpr,this.falseExpr)}},conversion:{asJS:function(depth){var str=Strings.format("if (%s) {%s}",this.condExpr.asJS(depth),this.trueExpr.asJS(depth));return this.isUndefined(this.falseExpr)||(str+=" else {"+this.falseExpr.asJS(depth)+"}"),str}},stepping:{firstStatement:function(){return this.condExpr.firstStatement()},nextStatement:function($super,node){return node===this.condExpr?this.trueExpr:$super(this)},isComposite:function(){return!0}}},"while":{className:"While",rules:[":pos","trans:condExpr","trans:body"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.body)},toString:function(){return Strings.format("%s(%s?%s)",this.constructor.name,this.condExpr,this.body)}},conversion:{asJS:function(depth){return Strings.format("while (%s) {%s}",this.condExpr.asJS(depth),this.body.asJS(depth))}},stepping:{firstStatement:function(){return this.condExpr.firstStatement()},nextStatement:function($super,node){return node===this.condExpr?this.body:node===this.body?this.condExpr:$super(this)},isComposite:function(){return!0}}},doWhile:{className:"DoWhile",rules:[":pos","trans:body","trans:condExpr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.body,this.condExpr)},toString:function(){return Strings.format("%s(%s while%s)",this.constructor.name,this.body,this.condExpr)}},conversion:{asJS:function(depth){return Strings.format("do {%s} while (%s);",this.body.asJS(depth),this.condExpr.asJS(depth))}},stepping:{firstStatement:function(){return this.body.firstStatement()},nextStatement:function($super,node){return node===this.condExpr?this.body:node===this.body?this.condExpr:$super(this)},isComposite:function(){return!0}}},"for":{className:"For",rules:[":pos","trans:init","trans:condExpr","trans:body","trans:upd"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.init,this.condExpr,this.body,this.upd)},toString:function(){return Strings.format("%s(%s;%s;%s do %s)",this.constructor.name,this.init,this.condExpr,this.upd,this.body)}},conversion:{asJS:function(depth){return Strings.format("for (%s; %s; %s) {%s}",this.init.asJS(depth),this.condExpr.asJS(depth),this.upd.asJS(depth),this.body.asJS(depth))}},stepping:{firstStatement:function(){return this.init.firstStatement()},nextStatement:function($super,node){return node===this.init||node===this.upd?this.condExpr:node===this.condExpr?this.body:node===this.body?this.upd:$super(this)},isComposite:function(){return!0}}},forIn:{className:"ForIn",rules:[":pos","trans:name","trans:obj","trans:body"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.name,this.obj,this.body)},toString:function(){return Strings.format("%s(%s in %s do %s)",this.constructor.name,this.name,this.obj,this.body)}},conversion:{asJS:function(depth){return Strings.format("for (%s in %s) {%s}",this.name.asJS(depth),this.obj.asJS(depth),this.body.asJS(depth))}}},set:{className:"Set",rules:[":pos","trans:left","trans:right"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.left,this.right)},toString:function(){return Strings.format("%s(%s = %s)",this.constructor.name,this.left,this.right)}},conversion:{asJS:function(depth){return this.left.asJS(depth)+" = "+this.right.asJS(depth)}}},mset:{className:"ModifyingSet",rules:[":pos","trans:left",":name","trans:right"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.left,'"'+this.name+'"',this.right)},toString:function(){return Strings.format("%s(%s %s %s)",this.constructor.name,this.left,this.name,this.right)}},conversion:{asJS:function(depth){return this.left.asJS(depth)+" "+this.name+"= "+this.right.asJS(depth)}}},binop:{className:"BinaryOp",rules:[":pos",":name","trans:left","trans:right"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.left,this.right)},toString:function(){return Strings.format("%s(%s %s %s)",this.constructor.name,this.left,this.name,this.right)}},conversion:{asJS:function(depth){return"("+this.left.asJS(depth)+") "+this.name+" ("+this.right.asJS(depth)+")"}}},unop:{className:"UnaryOp",rules:[":pos",":name","trans:expr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s%s)",this.constructor.name,this.name,this.expr)}},conversion:{asJS:function(depth){return"("+this.name+this.expr.asJS(depth)+")"}}},preop:{className:"PreOp",rules:[":pos",":name","trans:expr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s%s)",this.constructor.name,this.name,this.expr)}},conversion:{asJS:function(depth){return"("+this.name+this.expr.asJS(depth)+")"}}},postop:{className:"PostOp",rules:[":pos",":name","trans:expr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s%s)",this.constructor.name,this.expr,this.name)}},conversion:{asJS:function(depth){return"("+this.expr.asJS(depth)+this.name+")"}}},"this":{className:"This",rules:[":pos"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos)},toString:function(){return this.constructor.name}},conversion:{asJS:function(){return"this"}}},get:{className:"Variable",rules:[":pos",":name"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"')},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.name)}},conversion:{asJS:function(){return this.name}}},getp:{className:"GetSlot",rules:[":pos","trans:slotName","trans:obj"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.slotName,this.obj)},toString:function(){return Strings.format("%s(%s[%s])",this.constructor.name,this.obj,this.slotName)}},conversion:{asJS:function(depth){var objJS=this.obj.asJS(depth);return this.obj.isFunction&&(objJS="("+objJS+")"),objJS+"["+this.slotName.asJS(depth)+"]"}}},"break":{className:"Break",rules:[":pos","trans:label"],initializing:{initialize:function($super,pos,label){this.pos=pos,this.label=label||new users.timfelgentreff.jsinterpreter.Label([pos[1],pos[1]],""),this.label.setParent(this)}},debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.label)}},conversion:{asJS:function(){return"break"+this.label.asJS()}}},"debugger":{className:"Debugger",rules:[":pos"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos)}},conversion:{asJS:function(){return"debugger"}}},"continue":{className:"Continue",rules:[":pos","trans:label"],initializing:{initialize:function($super,pos,label){this.pos=pos,this.label=label||new users.timfelgentreff.jsinterpreter.Label([pos[1],pos[1]],""),this.label.setParent(this)}},debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.label)}},conversion:{asJS:function(){return"continue"+this.label.asJS()}}},arr:{className:"ArrayLiteral",rules:[":pos","trans*:elements"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.elements)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.elements.join(","))}},conversion:{asJS:function(){return"["+this.elements.invoke("asJS").join(",")+"]"}}},"return":{className:"Return",rules:[":pos","trans:expr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.expr)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.expr)}},conversion:{asJS:function(depth){return"return "+this.expr.asJS(depth)}}},"with":{className:"With",rules:[":pos","trans:obj","trans:body"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.obj,this.body)},toString:function(){return Strings.format("%s(%s %s)",this.constructor.name,this.obj,this.body)}},conversion:{asJS:function(depth){return"with ("+this.obj.asJS(depth)+") {"+this.body.asJS(depth)+"}"}}},send:{className:"Send",rules:[":pos","trans:property","trans:recv","trans*:args"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.property,this.recv,this.args)},toString:function(){return Strings.format("%s(%s[%s](%s))",this.constructor.name,this.recv,this.property,this.args.join(","))}},conversion:{asJS:function(depth){var recvJS=this.recv.asJS(depth);return this.recv.isFunction&&(recvJS="("+recvJS+")"),Strings.format("%s[%s](%s)",recvJS,this.property.asJS(depth),this.args.invoke("asJS").join(","))}},accessing:{getName:function(){return this.property}}},call:{className:"Call",rules:[":pos","trans:fn","trans*:args"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.fn,this.args)},toString:function(){return Strings.format("%s(%s(%s))",this.constructor.name,this.fn,this.args.join(","))}},conversion:{asJS:function(depth){return Strings.format("%s(%s)",this.fn.asJS(depth),this.args.invoke("asJS").join(","))}},accessing:{getName:function(){return this.fn.name}}},"new":{className:"New",rules:[":pos","trans:clsExpr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.clsExpr)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.clsExpr)}},conversion:{asJS:function(depth){return"new "+this.clsExpr.asJS(depth)}}},"var":{className:"VarDeclaration",rules:[":pos",":name","trans:val"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.val)},toString:function(){return Strings.format("%s(%s = %s)",this.constructor.name,this.name,this.val)}},conversion:{asJS:function(depth){return Strings.format("var %s = %s",this.name,this.val.asJS(depth))}}},"throw":{className:"Throw",rules:[":pos","trans:expr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.expr)},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.expr)}},conversion:{asJS:function(depth){return"throw "+this.expr.asJS(depth)}}},"try":{className:"TryCatchFinally",rules:[":pos","trans:trySeq","trans:err","trans:catchSeq","trans:finallySeq"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.trySeq,'"'+this.err.name+'"',this.catchSeq,this.finallySeq)},toString:function(){return Strings.format("%s(%s %s %s)",this.constructor.name,this.trySeq,this.catchSeq,this.finallySeq)}},conversion:{asJS:function(depth){var baseIndent=this.indent(depth-1),indent=this.indent(depth),str="try {\n"+indent+this.trySeq.asJS(depth)+"\n"+baseIndent+"}";return this.isUndefined(this.catchSeq)||(str+=" catch("+this.err.name+") {\n"+indent+this.catchSeq.asJS(depth)+"\n"+baseIndent+"}"),this.isUndefined(this.finallySeq)||(str+=" finally {\n"+indent+this.finallySeq.asJS(depth)+"\n"+baseIndent+"}"),str}}},func:{className:"Function",rules:[":pos","trans:body","trans*:args"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.body,this.args.collect(function(ea){return'"'+ea.name+'"'}))},toString:function(){return Strings.format("%s(function %s(%s) %s)",this.constructor.name,this.name(),this.argNames().join(","),this.body)}},conversion:{asJS:function(depth){return Strings.format("function%s(%s) {\n%s\n}",this.name()?" "+this.name():"",this.argNames().join(","),this.indent(depth+1)+this.body.asJS(depth+1))}},accessing:{name:function(){return this._parent&&this._parent.isVarDeclaration?this._parent.name:void 0},parentFunction:function(){return this},argNames:function(){return this.args.collect(function(a){return a.name})},statements:function(){return this.body.children}},stepping:{firstStatement:function(){return this.body.firstStatement()},nextStatement:function(){return null},isComposite:function(){return!0}},evaluation:{eval:function(){return new Function(this.argNames().join(","),this.body.asJS())}}},json:{className:"ObjectLiteral",rules:[":pos","trans*:properties"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.properties)},toString:function(){return Strings.format("%s({%s})",this.constructor.name,this.properties.join(","))}},conversion:{asJS:function(){return"{"+this.properties.invoke("asJS").join(",")+"}"}}},binding:{className:"ObjProperty",rules:[":pos",":name","trans:property"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.property)},toString:function(){return Strings.format("%s(%s: %s)",this.constructor.name,this.name,this.property)}},conversion:{asJS:function(depth){return Strings.format('"%s": %s',this.name,this.property.asJS(depth))}}},jsonGetter:{className:"ObjPropertyGet",rules:[":pos",":name","trans:body"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.body)},toString:function(){return Strings.format("%s(%s() { %s })",this.constructor.name,this.name,this.body)}},conversion:{asJS:function(depth){return Strings.format('get "%s"() { %s }',this.name,this.body.asJS(depth))}}},jsonSetter:{className:"ObjPropertySet",rules:[":pos",":name","trans:body",":arg"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.body,this.arg)},toString:function(){return Strings.format("%s(%s(%s) { %s })",this.constructor.name,this.name,this.arg,this.body)}},conversion:{asJS:function(depth){return Strings.format('set "%s"(%s) { %s }',this.name,this.arg,this.body.asJS(depth))}}},"switch":{className:"Switch",rules:[":pos","trans:expr","trans*:cases"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.expr,this.cases)},toString:function(){return Strings.format("%s(%s %s)",this.constructor.name,this.expr,this.cases.join("\n"))}},conversion:{asJS:function(depth){return Strings.format("switch (%s) {%s}",this.expr.asJS(depth),this.cases.invoke("asJS").join("\n"))}}},"case":{className:"Case",rules:[":pos","trans:condExpr","trans:thenExpr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.condExpr,this.thenExpr)},toString:function(){return Strings.format("%s(%s: %s)",this.constructor.name,this.condExpr,this.thenExpr)}},conversion:{asJS:function(depth){return"case "+this.condExpr.asJS(depth)+": "+this.thenExpr.asJS(depth)}}},"default":{className:"Default",rules:[":pos","trans:defaultExpr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.defaultExpr)},toString:function(){return Strings.format("%s(default: %s)",this.constructor.name,this.defaultExpr)}},conversion:{asJS:function(depth){return"default: "+this.defaultExpr.asJS(depth)}}},regex:{className:"Regex",rules:[":pos",":exprString",":flags"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,this.exprString,this.flags)},toString:function(){return Strings.format("(/%s/%s)",this.exprString,this.flags)}},conversion:{asJS:function(){return"/"+this.exprString+"/"+this.flags}}},label:{className:"Label",rules:[":pos",":name"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"')},toString:function(){return Strings.format("%s(%s)",this.constructor.name,this.name)}},conversion:{asJS:function(){return this.name}}},labelDcl:{className:"LabelDeclaration",rules:[":pos",":name","trans:expr"],debugging:{printConstruction:function(){return this.printConstructorCall(this.pos,'"'+this.name+'"',this.expr)},toString:function(){return Strings.format("%s(%s is %s)",this.constructor.name,this.name,this.expr)}},conversion:{asJS:function(depth){return this.name+": "+this.expr.asJS(depth)}}}},"rule helper",{rulesReturningSomething:function(ruleSpec){return ruleSpec.rules?ruleSpec.rules.reject(function(ea){return ea.startsWith(":")||!ea.include(":")}):[]},forCollectionRulesDo:function(ruleSpec,func){var rules=this.rulesReturningSomething(ruleSpec),collectionRules=rules.select(function(ea){return ea.include("*:")});return collectionRules.forEach(function(rule){var ruleParts=rule.split("*:");func.apply(this,ruleParts)},this),collectionRules},forSimpleRulesDo:function(ruleSpec,func){var rules=this.rulesReturningSomething(ruleSpec),collectionRules=rules.select(function(ea){return ea.include("*:")}),simpleRules=rules.without.apply(rules,collectionRules);return simpleRules.forEach(function(rule){var ruleParts=rule.split(":");func.apply(this,ruleParts)},this),simpleRules}},"file handling",{writeToFile:function(fileName,content){var baseURL=URL.codeBase.withFilename(this.modulePath.replace(/\./g,"/")),url=baseURL.withFilename("generated/"+fileName);new WebResource(url).put(content)}},"rule creation",{createRule:function(name,spec){var ownRules=spec.rules||[],argNames=this.argsFromRules(ownRules),className=this.modulePath+spec.className,ruleAppString=ownRules.length>0?"	"+ownRules.join(" ")+"\n":"",ruleStart=name+" =\n",ruleReturn=Strings.format("	-> { new %s(%s) },",className,argNames.join(", "));return ruleStart+ruleAppString+ruleReturn},argsFromRules:function(rules){return rules?rules.select(function(ea){return ea.include(":")}).collect(function(ea){return ea.split(":").last()}):[]},createJSTranslatorSource:function(){var rules=this.customRules();Properties.forEachOwn(this.translatorRules(),function(name,ruleSpec){rules.push(this.createRule(name,ruleSpec))},this);var head="ometa JSTranslator <: Parser {\n",body=rules.join("\n"),end="\n}";return body=body.substring(0,body.length-1),head+body+end},writeAndEvalTranslator:function(){var source=this.createJSTranslatorSource(),translated=OMetaSupport.translateToJs(source);eval(translated);var content=Strings.format("module('users.timfelgentreff.jsinterpreter.generated.Translator').requires('ometa.lively').toRun(function() {\n%s\n});",translated);this.writeToFile("Translator.ometa",source),this.writeToFile("Translator.js",content)}},"class creation",{assignmentsFromArgs:function(argNames){return argNames.collect(function(ea){return Strings.format("		this.%s = %s;",ea,ea)}).join("\n")},parentCallsFromRules:function(ruleSpec){var parentCalls=[];return this.forCollectionRulesDo(ruleSpec,function(rule,ruleVarName){var str=Strings.format("		%s.forEach(function(node) { node.setParent(this) }, this);",ruleVarName);parentCalls.push(str)}),this.forSimpleRulesDo(ruleSpec,function(rule,ruleVarName){var str=Strings.format("		%s.setParent(this);",ruleVarName);parentCalls.push(str)}),parentCalls.join("\n")},createASTClass:function(ruleSpec){var className=this.modulePath+ruleSpec.className,superclassName=this.rootNodeClassName,args=this.argsFromRules(ruleSpec.rules),setParentCalls=this.parentCallsFromRules(ruleSpec),assignments=this.assignmentsFromArgs(args),categories=[];categories.push(Strings.format("\n'testing', {\n	%s: true,\n}",this.genTypeProperty(ruleSpec.className))),args.length>0&&!Properties.own(ruleSpec).include("initializing")&&categories.push(Strings.format("\n'initializing', {\n	initialize: function($super, %s) {\n%s\n%s\n	},\n}",args.join(", "),assignments,setParentCalls)),Properties.own(ruleSpec).without("className","rules").forEach(function(catName){var src="\n'"+catName+"', {\n",category=ruleSpec[catName],functionNames=Functions.own(category);
functionNames.forEach(function(name){src+=Strings.format("	%s: %s,\n",name,category[name])}),src+="}",categories.push(src)}),categories.push(this.visitingCategoryForNode(ruleSpec));var body=categories.join(","),def=Strings.format("%s.subclass('%s',%s)",superclassName,className,body);return def},genTypeProperty:function(className){return"is"+className},createASTClassSourcesFromRules:function(){var classDefs=this.customClasses();return Properties.forEachOwn(this.translatorRules(),function(name,ruleSpec){classDefs.push(this.createASTClass(ruleSpec))},this),classDefs.join(";\n\n")},evalAndWriteClasses:function(){var src=this.createASTClassSourcesFromRules();src+=";\n\n",src+=this.abstractVisitorClassSource(),eval(src);var baseName="Nodes",moduleName=this.modulePath+"generated."+baseName,fileName=baseName+".js",content=Strings.format("module('%s').requires().toRun(function() {\n%s\n});",moduleName,src);this.writeToFile(fileName,content)}},"visitor creation",{abstractVisitorClassSource:function(){var categories=[this.visitingCategoryForAbstractVisitor()];return Strings.format("Object.subclass('%s',%s)",this.visitorClassName,categories.join(",\n"))},visitingCategoryForAbstractVisitor:function(){var src="\n'visiting', {\n";return src+="	visit: function(node) { return node.accept(this) },\n",Properties.forEachOwn(this.translatorRules(),function(name,ruleSpec){src+=Strings.format("	visit%s: function(node) {},\n",ruleSpec.className)}),src+="\n}"},doubleDispatchCategoryForVisitor:function(){var createVisitAndAcceptCalls=function(ruleSpec){var calls=[];return calls.push("		his.visit(node);"),this.forCollectionRulesDo(ruleSpec,function(rule,ruleVarName){var str=Strings.format("		node.%s.forEach(function(ea) { this.visit(ea) }, this);",ruleVarName);calls.push(str)}),this.forSimpleRulesDo(ruleSpec,function(rule,ruleVarName){var str=Strings.format("		this.visit(node.%s);",ruleVarName);calls.push(str)}),calls.join("\n")}.bind(this),src="\n'double dispatch', {\n";return Properties.forEachOwn(this.translatorRules(),function(name,ruleSpec){src+=Strings.format("	accept%s: function(node) {\n%s\n	},\n",ruleSpec.className,createVisitAndAcceptCalls(ruleSpec))}),src+="\n}"},visitingCategoryForNode:function(ruleSpec){return"\n'visiting', {\n    accept: function(visitor) {\n        return visitor.visit"+ruleSpec.className+"(this);\n    }\n }"}}),Object.extend(users.timfelgentreff.jsinterpreter.Node,{placeholder:{}})}),module("users.timfelgentreff.jsinterpreter.Meta").requires("users.timfelgentreff.jsinterpreter.Parser").toRun(function(){Function.addMethods("meta programming interface",{toSource:function(){if(!this.source){var name=this.methodName||this.name||"anonymous";this.source=this.toString().replace(/^function[^\(]*/,"function "+name)}return this.source},browse:function(){throw this.sourceModule&&this.methodName&&this.declaredClass&&require("lively.ide.SystemCodeBrowser").toRun(function(){return lively.ide.browse(this.declaredClass,this.methodName,this.sourceModule.name())}.bind(this)),new Error("Cannot browse anonymous function "+this)},updateSource:function(source){var ast=users.timfelgentreff.jsinterpreter.Parser.parse(source,"functionDef"),newFun=ast.val.eval();newFun.declaredClass=this.declaredClass,newFun.methodName=this.methodName,newFun.sourceModule=this.sourceModule,newFun.source=source,newFun.locallyChanged=!0,this.getClass().prototype[this.methodName]=newFun,lively.bindings.signal(this,"localSource",newFun),users.timfelgentreff.jsinterpreter.Meta.ChangeSet.getCurrent().addChange(newFun)},getClass:function(){return lively.Class.forName(this.declaredClass)}}),Object.subclass("users.timfelgentreff.jsinterpreter.Meta.ChangeSet","initializing",{initialize:function(){this.changes=[]}},"managing",{addChange:function(fun){this.changes.push(fun),lively.bindings.signal(this.constructor,"current",this)}},"persistence",{commit:function(){throw new Error("not implemented yet")}},"merging",{mergeWithCurrent:function(){throw new Error("not implemented yet")}}),Object.extend(users.timfelgentreff.jsinterpreter.Meta.ChangeSet,{current:null,getCurrent:function(){return this.current||(this.current=new this),this.current}})}),module("users.timfelgentreff.jsinterpreter.Rewriting").requires("users.timfelgentreff.jsinterpreter.Parser").toRun(function(){Object.extend(users.timfelgentreff.jsinterpreter,{oldEval:eval}),Object.extend(users.timfelgentreff.jsinterpreter.Rewriting,{table:[]}),users.timfelgentreff.jsinterpreter.Visitor.subclass("users.timfelgentreff.jsinterpreter.Rewriting.Transformation","helping",{visitNodes:function(nodes){for(var result=[],i=0;i<nodes.length;i++){var res=this.visit(nodes[i]);res&&result.push(res)}return result}},"visiting",{visitSequence:function(node){return new users.timfelgentreff.jsinterpreter.Sequence(node.pos,this.visitNodes(node.children))},visitNumber:function(node){return new users.timfelgentreff.jsinterpreter.Number(node.pos,node.value)},visitString:function(node){return new users.timfelgentreff.jsinterpreter.String(node.pos,node.value)},visitCond:function(node){return new users.timfelgentreff.jsinterpreter.Cond(node.pos,this.visit(node.condExpr),this.visit(node.trueExpr),this.visit(node.falseExpr))},visitIf:function(node){return new users.timfelgentreff.jsinterpreter.If(node.pos,this.visit(node.condExpr),this.visit(node.trueExpr),this.visit(node.falseExpr))},visitWhile:function(node){return new users.timfelgentreff.jsinterpreter.While(node.pos,this.visit(node.condExpr),this.visit(node.body))},visitDoWhile:function(node){return new users.timfelgentreff.jsinterpreter.DoWhile(node.pos,this.visit(node.body),this.visit(node.condExpr))},visitFor:function(node){return new users.timfelgentreff.jsinterpreter.For(node.pos,this.visit(node.init),this.visit(node.condExpr),this.visit(node.body),this.visit(node.upd))},visitForIn:function(node){return new users.timfelgentreff.jsinterpreter.ForIn(node.pos,this.visit(node.name),this.visit(node.obj),this.visit(node.body))},visitSet:function(node){return new users.timfelgentreff.jsinterpreter.Set(node.pos,this.visit(node.left),this.visit(node.right))},visitModifyingSet:function(node){return new users.timfelgentreff.jsinterpreter.ModifyingSet(node.pos,this.visit(node.left),node.name,this.visit(node.right))},visitBinaryOp:function(node){return new users.timfelgentreff.jsinterpreter.BinaryOp(node.pos,node.name,this.visit(node.left),this.visit(node.right))},visitUnaryOp:function(node){return new users.timfelgentreff.jsinterpreter.UnaryOp(node.pos,node.name,this.visit(node.expr))},visitPreOp:function(node){return new users.timfelgentreff.jsinterpreter.PreOp(node.pos,node.name,this.visit(node.expr))},visitPostOp:function(node){return new users.timfelgentreff.jsinterpreter.PostOp(node.pos,node.name,this.visit(node.expr))},visitThis:function(node){return new users.timfelgentreff.jsinterpreter.This(node.pos)},visitVariable:function(node){return new users.timfelgentreff.jsinterpreter.Variable(node.pos,node.name)},visitGetSlot:function(node){return new users.timfelgentreff.jsinterpreter.GetSlot(node.pos,this.visit(node.slotName),this.visit(node.obj))},visitBreak:function(node){return new users.timfelgentreff.jsinterpreter.Break(node.pos)},visitDebugger:function(node){return new users.timfelgentreff.jsinterpreter.Debugger(node.pos)},visitContinue:function(node){return new users.timfelgentreff.jsinterpreter.Continue(node.pos)},visitArrayLiteral:function(node){return new users.timfelgentreff.jsinterpreter.ArrayLiteral(node.pos,this.visitNodes(node.elements))},visitReturn:function(node){return new users.timfelgentreff.jsinterpreter.Return(node.pos,this.visit(node.expr))},visitWith:function(){throw new Error("with statement not supported")},visitSend:function(node){return new users.timfelgentreff.jsinterpreter.Send(node.pos,this.visit(node.property),this.visit(node.recv),this.visitNodes(node.args))},visitCall:function(node){return new users.timfelgentreff.jsinterpreter.Call(node.pos,this.visit(node.fn),this.visitNodes(node.args))},visitNew:function(node){return new users.timfelgentreff.jsinterpreter.New(node.pos,this.visit(node.clsExpr))},visitVarDeclaration:function(node){return new users.timfelgentreff.jsinterpreter.VarDeclaration(node.pos,node.name,this.visit(node.val))},visitThrow:function(node){return new users.timfelgentreff.jsinterpreter.Throw(node.pos,this.visit(node.expr))},visitTryCatchFinally:function(node){return new users.timfelgentreff.jsinterpreter.TryCatchFinally(node.pos,this.visit(node.trySeq),node.err,this.visit(node.catchSeq),this.visit(node.finallySeq))},visitFunction:function(node){return new users.timfelgentreff.jsinterpreter.Function(node.pos,this.visit(node.body),this.visitNodes(node.args))},visitObjectLiteral:function(node){return new users.timfelgentreff.jsinterpreter.ObjectLiteral(node.pos,this.visitNodes(node.properties))},visitObjProperty:function(node){return new users.timfelgentreff.jsinterpreter.ObjProperty(node.pos,node.name,this.visit(node.property))},visitSwitch:function(node){return new users.timfelgentreff.jsinterpreter.Switch(node.pos,this.visit(node.expr),this.visitNodes(node.cases))},visitCase:function(node){return new users.timfelgentreff.jsinterpreter.Case(node.pos,this.visit(node.condExpr),this.visit(node.thenExpr))},visitDefault:function(node){return new users.timfelgentreff.jsinterpreter.Case(node.pos,this.visit(node.defaultExpr))},visitRegex:function(node){return new users.timfelgentreff.jsinterpreter.Regex(node.pos,node.exprString,node.flags)},visitObjPropertyGet:function(node){return new users.timfelgentreff.jsinterpreter.ObjPropertyGet(node.pos,node.name,this.visit(node.body))},visitObjPropertySet:function(node){return new users.timfelgentreff.jsinterpreter.ObjPropertySet(node.pos,node.name,this.visit(node.body),node.arg)}}),users.timfelgentreff.jsinterpreter.Rewriting.Transformation.subclass("users.timfelgentreff.jsinterpreter.Rewriting.RemoveDebugger","visiting",{visitDebugger:function(){return void 0}}),users.timfelgentreff.jsinterpreter.Rewriting.Transformation.subclass("users.timfelgentreff.jsinterpreter.Rewriting.Rewriter","initializing",{initialize:function($super){$super(),this.scopes=[]}},"scoping",{enterScope:function(){this.scopes.push([])},registerVar:function(name){0!=this.scopes.length&&this.scopes.last().push(name)},referenceVar:function(name){for(var i=this.scopes.length-1;i>=0;i--)if(this.scopes[i].include(name))return i;return void 0},exitScope:function(){this.scopes.pop()}},"helping",{computationFrame:function(){return new users.timfelgentreff.jsinterpreter.Variable([0,0],"_")},localFrame:function(i){return new users.timfelgentreff.jsinterpreter.Variable([0,0],"_"+i)},frame:function(i){return 0>i?new users.timfelgentreff.jsinterpreter.Variable([0,0],"Global"):new users.timfelgentreff.jsinterpreter.Variable([0,0],"__"+i)},storeComputationResult:function(node){if(0==this.scopes.length)return node;var name=new users.timfelgentreff.jsinterpreter.String(node.pos,node.position()),target=new users.timfelgentreff.jsinterpreter.GetSlot(node.pos,name,this.computationFrame());return new users.timfelgentreff.jsinterpreter.Set(node.pos,target,node)},registerArguments:function(func){for(var args=[],i=0;i<func.args.length;i++){var arg=func.args[i];this.registerVar(arg.name),args.push(new users.timfelgentreff.jsinterpreter.Variable(arg.pos,arg.name))}return args},registerLocals:function(func){var that=this;func.body.withAllChildNodesDo(function(node){return node.isFunction?!1:(node.isVarDeclaration&&that.registerVar(node.name),!0)})}},"rewriting",{wrapVar:function(pos,name){var scope=this.referenceVar(name);return void 0===scope?new users.timfelgentreff.jsinterpreter.Variable(pos,name):new users.timfelgentreff.jsinterpreter.GetSlot(pos,new users.timfelgentreff.jsinterpreter.String(pos,name),this.localFrame(scope))},rewriteVarDeclaration:function(pos,name,expr){return new users.timfelgentreff.jsinterpreter.Set(pos,this.wrapVar(pos,name),expr)},emptyObj:function(){return new users.timfelgentreff.jsinterpreter.ObjectLiteral([0,0],[])},argsInitObj:function(args){for(var properties=[],i=0;i<args.length;i++){var arg=args[i].name,argVal=new users.timfelgentreff.jsinterpreter.Variable([0,0],arg);properties.push(new users.timfelgentreff.jsinterpreter.ObjProperty([0,0],arg,argVal))}return new users.timfelgentreff.jsinterpreter.ObjectLiteral([0,0],properties)},addPreamble:function(astIdx,body,args){var p=body.pos,level=this.scopes.length,initComputationFrame=new users.timfelgentreff.jsinterpreter.VarDeclaration(p,"_",this.emptyObj()),initLocalFrame=new users.timfelgentreff.jsinterpreter.VarDeclaration(p,"_"+level,this.argsInitObj(args)),frame=new users.timfelgentreff.jsinterpreter.ArrayLiteral(p,[this.computationFrame(),this.localFrame(level),new users.timfelgentreff.jsinterpreter.Number(p,astIdx),this.frame(level-1)]),initFrame=new users.timfelgentreff.jsinterpreter.VarDeclaration(p,"__"+level,frame);return new users.timfelgentreff.jsinterpreter.Sequence(p,[initComputationFrame,initLocalFrame,initFrame,body])},catchExceptions:function(astIdx,body){var p=body.pos,level=this.scopes.length,throwStmt=new users.timfelgentreff.jsinterpreter.Throw(p,new users.timfelgentreff.jsinterpreter.Variable(p,"ex")),shiftStmt=new users.timfelgentreff.jsinterpreter.Send(p,new users.timfelgentreff.jsinterpreter.String(p,"shiftFrame"),new users.timfelgentreff.jsinterpreter.Variable(p,"ex"),[new users.timfelgentreff.jsinterpreter.This(p),new users.timfelgentreff.jsinterpreter.Variable(p,"__"+level)]),isUnwind=new users.timfelgentreff.jsinterpreter.GetSlot(p,new users.timfelgentreff.jsinterpreter.String(p,"isUnwindException"),new users.timfelgentreff.jsinterpreter.Variable(p,"e")),classExpr=new users.timfelgentreff.jsinterpreter.GetSlot(p,new users.timfelgentreff.jsinterpreter.String(p,"UnwindExecption"),new users.timfelgentreff.jsinterpreter.GetSlot(p,new users.timfelgentreff.jsinterpreter.String(p,"Rewriting"),new users.timfelgentreff.jsinterpreter.GetSlot(p,new users.timfelgentreff.jsinterpreter.String(p,"ast"),new users.timfelgentreff.jsinterpreter.Variable(p,"lively")))),newUnwind=new users.timfelgentreff.jsinterpreter.New(p,new users.timfelgentreff.jsinterpreter.Call(p,classExpr,[new users.timfelgentreff.jsinterpreter.Variable(p,"e")])),cond=new users.timfelgentreff.jsinterpreter.Cond(p,isUnwind,new users.timfelgentreff.jsinterpreter.Variable(p,"e"),newUnwind),catchSeq=new users.timfelgentreff.jsinterpreter.Sequence(p,[new users.timfelgentreff.jsinterpreter.VarDeclaration(p,"ex",cond),shiftStmt,throwStmt]),noop=new users.timfelgentreff.jsinterpreter.Variable(body.pos,"undefined"),error=new users.timfelgentreff.jsinterpreter.Variable(body.pos,"e");return new users.timfelgentreff.jsinterpreter.TryCatchFinally(body.pos,body,error,catchSeq,noop)},wrapFunctionBody:function(astIdx,body,args){return this.catchExceptions(astIdx,this.addPreamble(astIdx,body,args))},wrapClosure:function(idx,node){var fn=new users.timfelgentreff.jsinterpreter.Variable(node.pos,"__createClosure"),scope=this.frame(this.scopes.length-1),astIdx=new users.timfelgentreff.jsinterpreter.Number([0,0],idx);return new users.timfelgentreff.jsinterpreter.Call(node.pos,fn,[astIdx,scope,node])}},"visiting",{visitVarDeclaration:function(node){return this.registerVar(node.name.value),this.storeComputationResult(this.rewriteVarDeclaration(node.pos,node.name,this.visit(node.val)))},visitVariable:function(node){return this.wrapVar(node.pos,node.name)},visitDebugger:function(node){var ret=new users.timfelgentreff.jsinterpreter.Return(node.pos,new users.timfelgentreff.jsinterpreter.String(node.pos,"Debuggger")),returnDebugger=new users.timfelgentreff.jsinterpreter.Function(node.pos,new users.timfelgentreff.jsinterpreter.Sequence(node.pos,[ret]),[]),ast=this.storeComputationResult(returnDebugger),toString=new users.timfelgentreff.jsinterpreter.ObjProperty(node.pos,"toString",ast);return new users.timfelgentreff.jsinterpreter.Throw(node.pos,new users.timfelgentreff.jsinterpreter.ObjectLiteral(node.pos,[toString]))},visitSet:function($super,node){return this.storeComputationResult($super(node))},visitCall:function($super,node){return this.storeComputationResult($super(node))},visitSend:function($super,node){return this.storeComputationResult($super(node))},visitModifyingSet:function($super,node){return this.storeComputationResult($super(node))},visitPreOp:function($super,node){return this.storeComputationResult($super(node))},visitPostOp:function($super,node){return this.storeComputationResult($super(node))},visitNew:function(node){var clsExpr=this.visit(node.clsExpr);return clsExpr.isSet&&(clsExpr=clsExpr.right),this.storeComputationResult(new users.timfelgentreff.jsinterpreter.New(node.pos,clsExpr))},visitFunction:function($super,node){this.enterScope();var args=this.registerArguments(node);this.registerLocals(node);var rewritten=new users.timfelgentreff.jsinterpreter.Function(node.pos,this.visit(node.body),args);this.exitScope(),users.timfelgentreff.jsinterpreter.Rewriting.table.push(node);var idx=users.timfelgentreff.jsinterpreter.Rewriting.table.length-1;return rewritten.body=this.wrapFunctionBody(idx,rewritten.body,rewritten.args),this.storeComputationResult(this.wrapClosure(idx,rewritten))}}),Object.subclass("users.timfelgentreff.jsinterpreter.Rewriting.UnwindExecption","settings",{isUnwindException:!0},"initializing",{initialize:function(error){this.error=error}},"printing",{toString:function(){return this.error.toString()}},"frames",{shiftFrame:function(thiz,frame){var computationFrame=frame[0],localFrame=frame[1];localFrame["this"]=thiz;var astIndex=frame[2],scope=frame[3],stackFrame=[computationFrame,localFrame,astIndex,Global,scope];return this.top?(this.last[3]=stackFrame,this.last=stackFrame,void 0):(this.top=this.last=stackFrame,void 0)}}),Object.extend(Global,{__createClosure:function(idx,scope,f){return f._cachedAst=users.timfelgentreff.jsinterpreter.Rewriting.table[idx],f._cachedScope=scope,f},eval2:function(src){var ast=users.timfelgentreff.jsinterpreter.Parser.parse(src,"topLevel"),wrapped=new users.timfelgentreff.jsinterpreter.Function([0,0],ast,[]);wrapped.source=src;var rewriter=new users.timfelgentreff.jsinterpreter.Rewriting.Rewriter,rewrittenAst=rewriter.visit(wrapped);return users.timfelgentreff.jsinterpreter.oldEval(rewrittenAst.asJS())()}}),Object.extend(JSLoader,{loadJs2:function(url,onLoadCb,loadSync,okToUseCache,cacheQuery){var exactUrl=url;exactUrl.indexOf("!svn")<=0&&!okToUseCache&&(exactUrl=this.makeUncached(exactUrl,cacheQuery)),$.ajax(exactUrl,{success:users.timfelgentreff.jsinterpreter.Rewriting.loadJS.bind(users.timfelgentreff.jsinterpreter.Rewriting,onLoadCb)})}}),Object.extend(users.timfelgentreff.jsinterpreter.Rewriting,{loadJS:function(cb,src){src||(src=cb,cb=null),eval(src),cb&&cb()}})}),module("users.timfelgentreff.jsinterpreter.Interpreter").requires("users.timfelgentreff.jsinterpreter.Parser","users.timfelgentreff.jsinterpreter.Meta","users.timfelgentreff.jsinterpreter.Rewriting").toRun(function(){Object.subclass("users.timfelgentreff.jsinterpreter.Interpreter.Frame","initialization",{initialize:function(func,mapping){this.func=func,this.mapping=mapping||{},this.returnTriggered=!1,this.breakTriggered=!1,this.continueTriggered=!1,this.findSetterMode=!1,this.breakAtCalls=!1,this.pc=null,this.bp=null,this.values={}},newScope:function(mapping){var newFrame=new users.timfelgentreff.jsinterpreter.Interpreter.Frame(mapping);return newFrame.setContainingScope(this),newFrame},breakAtFirstStatement:function(){this.bp=this.func.ast().firstStatement()}},"accessing",{setContainingScope:function(frame){return this.containingScope=frame},getContainingScope:function(){return this.containingScope},getCaller:function(){return this.caller},setCaller:function(caller){caller&&(this.caller=caller,caller.callee=this,caller.breakAtCalls&&this.breakAtFirstStatement())},setThis:function(thisObj){return this.addToMapping("this",thisObj),thisObj},getThis:function(){return this.mapping["this"]?this.mapping["this"]:Global},setArguments:function(argValues){for(var argNames=this.func.ast().argNames(),i=0;i<argNames.length;i++)this.addToMapping(argNames[i],argValues[i]);return this.arguments=argValues},getArguments:function(){return this.arguments},getFuncName:function(){return this.func?this.func.getOriginal().qualifiedMethodName():"frame has no function!"},getFuncSource:function(){return this.func?this.func.getOriginal().toSource():"frame has no function!"},findFrame:function(name){if(this.mapping.hasOwnProperty(name))return{val:this.mapping[name],frame:this};if(this.mapping===Global)throw new ReferenceError(name+" is not defined");var mapping=this.func.getVarMapping();if(mapping&&mapping.hasOwnProperty(name))return{val:mapping[name],frame:this};var containingScope=this.getContainingScope();return containingScope?containingScope.findFrame(name):null},lookup:function(name){if("undefined"===name)return void 0;if("null"===name)return null;if("true"===name)return!0;if("false"===name)return!1;if("NaN"===name)return 0/0;if("arguments"===name)return this.getArguments();var frame=this.findFrame(name);return frame?frame.val:void 0},addToMapping:function(name,value){return this.mapping[name]=value},addAllToMapping:function(otherMapping){for(var name in otherMapping)otherMapping.hasOwnProperty(name)&&(this.mapping[name]=otherMapping[name])},triggerReturn:function(){this.returnTriggered=!0},triggerBreak:function(){this.breakTriggered=!0},stopBreak:function(){this.breakTriggered=!1},triggerContinue:function(){this.continueTriggered=!0},stopContinue:function(){this.continueTriggered=!1}},"accessing for UI",{listItemsForIntrospection:function(){var items=Properties.forEachOwn(this.mapping,function(name,value){return{isListItem:!0,string:name+": "+String(value).truncate(50),value:value}});return this.containingScope&&(items.push({isListItem:!0,string:"[[containing scope]]"}),items.pushAll(this.containingScope.listItemsForIntrospection())),items}},"program counter",{halt:function(){if(this.unbreak(),users.timfelgentreff.jsinterpreter.halt(this))throw{isUnwindException:!0,topFrame:this,toString:function(){return"Debugger"}}},haltAtNextStatement:function(){if(this.pc===this.func.ast()){var caller=this.getCaller();caller&&caller.isResuming()&&caller.haltAtNextStatement()}else{var nextStmt=this.pc.nextStatement();this.bp=nextStmt?nextStmt:this.func.ast()}},stepToNextStatement:function(breakAtCalls){return this.haltAtNextStatement(),this.resume(breakAtCalls)},hasNextStatement:function(){return null!=this.pc.nextStatement()},restart:function(){this.initialize(this.func,this.mapping),this.breakAtFirstStatement(),this.resume()}},"resuming",{isResuming:function(){return null!==this.pc||null!==this.bp},resumesNow:function(){this.pc=null},isBreakingAt:function(node){return null===this.bp?!1:this.bp===node?!0:this.bp==node.nextStatement()?!1:node.isAfter(this.bp)},findPC:function(){if(!Object.isEmpty(this.values)){var last=Object.keys(this.values).max(function(k){var fromTo=k.split("-");return+fromTo[1]<<23-+fromTo[0]}),node=this.func.ast().nodesMatching(function(node){return last==node.position()})[0];if(node.isDebugger)return this.pc=node;var pc=null,foundNode=!1;this.func.ast().withAllChildNodesDoPostOrder(function(n){if(foundNode){if(n.isCall||n.isSend||n.isSet||n.isModifyingSet||n.isPreOp||n.isPostOp)return pc=n,!1}else n===node&&(foundNode=!0);return!0}),this.pc=pc||this.func.ast()}},setPC:function(node){this.pc=node.isFunction?node:node.firstStatement(),this.isBreakingAt(node)&&this.halt()},getValue:function(node){var value=this.values[node.position()];return value?value:this.setPC(node)},putValue:function(node,value){return this.values[node.position()]={val:value}},removeValue:function(node){var that=this;node.withAllChildNodesDo(function(child){return delete that.values[child.position()],!0})},resume:function(breakAtCalls){this.breakAtCalls=breakAtCalls?!0:!1;var result=this.func.ast().resume(this);return this.getCaller()&&this.getCaller().isResuming()&&this.getCaller().putValue(this.getCaller().pc,result),this.setPC(this.func.ast()),this.getCaller()&&this.getCaller().isResuming()?this.getCaller().resume(breakAtCalls):result},unbreak:function(){this.bp=null,this.getCaller()&&this.getCaller().unbreak()}},"debugging",{toString:function(){var mappings=[];for(var name in this.mapping)this.mapping.hasOwnProperty(name)&&mappings.push(name+": "+this.mapping[name]);var mappingString="{"+mappings.join(",")+"}";return"Frame("+mappingString+")"}}),Object.extend(users.timfelgentreff.jsinterpreter.Interpreter.Frame,{create:function(func,mapping){return new users.timfelgentreff.jsinterpreter.Interpreter.Frame(func,mapping||{})},global:function(){return this.create(null,Global)},fromTraceNode:function(trace){var frame;return trace.frame?frame=trace.frame:(frame=users.timfelgentreff.jsinterpreter.Interpreter.Frame.create(trace.method),frame.setThis(trace.itsThis),frame.setArguments(trace.args)),trace.caller&&!trace.caller.isRoot&&frame.setCaller(users.timfelgentreff.jsinterpreter.Interpreter.Frame.fromTraceNode(trace.caller)),frame},fromScope:function(scope,callstack){if(scope===Global)return users.timfelgentreff.jsinterpreter.Interpreter.Frame.global();var ast=users.timfelgentreff.jsinterpreter.Rewriting.table[scope[2]],frame=new users.timfelgentreff.jsinterpreter.Interpreter.Frame(ast.asFunction(),scope[1]),parent=users.timfelgentreff.jsinterpreter.Interpreter.Frame.fromScope(scope[3],callstack);return callstack?(frame.values=scope[0],frame.findPC(),scope[3]!==Global&&frame.setCaller(parent),scope[4]!==Global&&frame.setContainingScope(users.timfelgentreff.jsinterpreter.Interpreter.Frame.fromScope(scope[4]))):frame.setContainingScope(parent),frame}}),users.timfelgentreff.jsinterpreter.Visitor.subclass("users.timfelgentreff.jsinterpreter.InterpreterVisitor","interface",{run:function(node,optMapping){return this.runWithFrame(node,users.timfelgentreff.jsinterpreter.Interpreter.Frame.create(null,optMapping))},runWithFrame:function(node,frame){return this.currentFrame=frame,this.visit(node)}},"invoking",{isNative:function(func){return this._nativeFuncRegex||(this._nativeFuncRegex=/\{\s+\[native\scode\]\s+\}$/),this._nativeFuncRegex.test(func.toString())},shouldInterpret:function(frame,func){return this.isNative(func)?!1:func.hasOwnProperty("forInterpretation")||frame.breakAtCalls||func.containsDebugger()},invoke:function(node,recv,func,argValues){var isNew=node._parent&&node._parent.isNew;if(this.currentFrame.setPC(node),recv&&Object.isFunction(recv)&&func===Function.prototype.apply&&(func=recv,recv=argValues.shift(),argValues=argValues[0]),this.shouldInterpret(this.currentFrame,func)&&(func=func.forInterpretation()),isNew){if(this.isNative(func))return new func;recv=this.newObject(func)}var result=func.apply(recv,argValues);return isNew?recv:result},newObject:function(func){function constructor(){}var proto=func.prototype;constructor.prototype=proto;var newObj=new constructor;return newObj.constructor=func,newObj}},"visiting",{visit:function(node){var value=this.currentFrame.getValue(node);return value||(value=this.currentFrame.putValue(node,node.accept(this))),value.val},visitSequence:function(node){for(var result,frame=this.currentFrame,i=0;i<node.children.length;i++)if(result=this.visit(node.children[i]),frame.returnTriggered||frame.breakTriggered||frame.continueTriggered)return result;return result},visitNumber:function(node){return node.value},visitString:function(node){return node.value},visitCond:function(node){var condVal=(this.currentFrame,this.visit(node.condExpr));return condVal?this.visit(node.trueExpr):this.visit(node.falseExpr)},visitIf:function(node){return this.visitCond(node)},visitWhile:function(node){for(var result,frame=this.currentFrame;this.visit(node.condExpr);){if(result=this.visit(node.body),frame.continueTriggered&&frame.stopContinue(),frame.breakTriggered){frame.stopBreak();break}if(frame.returnTriggered)return result;frame.removeValue(node.condExpr),frame.removeValue(node.body)}return result},visitDoWhile:function(node){var result,condResult,frame=this.currentFrame;do{if(frame.removeValue(node.condExpr),result=this.visit(node.body),frame.continueTriggered&&frame.stopContinue(),frame.breakTriggered){frame.stopBreak();break}if(frame.returnTriggered)return result;condResult=this.visit(node.condExpr),frame.removeValue(node.body)}while(condResult);return result},visitFor:function(node){var result,frame=this.currentFrame;for(this.visit(node.init);this.visit(node.condExpr);){if(result=this.visit(node.body),frame.continueTriggered&&frame.stopContinue(),frame.breakTriggered){frame.stopBreak();break}if(frame.returnTriggered)return result;this.visit(node.upd),frame.removeValue(node.condExpr),frame.removeValue(node.body),frame.removeValue(node.upd)}return result},visitForIn:function(node){var result,frame=this.currentFrame,varPart=node.name,obj=this.visit(node.obj);varPart.isVarDeclaration&&(varPart.val.name=varPart.name);for(var name in obj){if(frame.addToMapping(varPart.name,name),result=this.visit(node.body),frame.continueTriggered&&frame.stopContinue(),frame.breakTriggered){frame.stopBreak();break}if(frame.returnTriggered)return result;frame.removeValue(node.body)}return result},visitSet:function(node){var frame=this.currentFrame;return node.left.set(this.visit(node.right),frame,this)},visitModifyingSet:function(node){var newValue,frame=this.currentFrame,op=node.name+"=",oldValue=this.visit(node.left);switch(op){case"+=":newValue=oldValue+this.visit(node.right);break;case"-=":newValue=oldValue-this.visit(node.right);break;case"*=":newValue=oldValue*this.visit(node.right);break;case"/=":newValue=oldValue/this.visit(node.right);break;case">>=":newValue=oldValue>>=this.visit(node.right);break;case"<<=":newValue=oldValue<<=this.visit(node.right);break;case">>>=":newValue=oldValue>>>this.visit(node.right);break;case"&=":newValue=oldValue&this.visit(node.right);break;case"|=":newValue=oldValue|this.visit(node.right);break;case"&=":newValue=oldValue&this.visit(node.right);break;case"^=":newValue=oldValue^this.visit(node.right);break;case"||=":newValue=oldValue||this.visit(node.right);break;case"&&=":newValue=oldValue&&this.visit(node.right);break;default:throw new Error("Modifying set has unknown operation "+op)}return node.left.set(newValue,frame,this)},visitBinaryOp:function(node){var leftVal=(this.currentFrame,this.visit(node.left));switch(node.name){case"||":return leftVal||this.visit(node.right);case"&&":return leftVal&&this.visit(node.right)}var rightVal=this.visit(node.right);switch(node.name){case"+":return leftVal+rightVal;case"-":return leftVal-rightVal;case"*":return leftVal*rightVal;case"/":return leftVal/rightVal;case"%":return leftVal%rightVal;case"<":return rightVal>leftVal;case"<=":return rightVal>=leftVal;case">":return leftVal>rightVal;case">=":return leftVal>=rightVal;case"==":return leftVal==rightVal;case"===":return leftVal===rightVal;case"!=":return leftVal!=rightVal;case"!==":return leftVal!==rightVal;case"&":return leftVal&rightVal;case"|":return leftVal|rightVal;case"^":return leftVal^rightVal;case">>":return leftVal>>rightVal;case"<<":return leftVal<<rightVal;case">>>":return leftVal>>>rightVal;case"in":return leftVal in rightVal;case"instanceof":return leftVal instanceof rightVal;default:throw new Error("No semantics for binary op "+node.name)}},visitUnaryOp:function(node){var val=(this.currentFrame,this.visit(node.expr));switch(node.name){case"-":return-val;case"!":return!val;case"~":return~val;case"typeof":return typeof val;default:throw new Error("No semantics for unary op "+node.name)}},visitPreOp:function(node){var frame=this.currentFrame,setExpr=node.expr;if(!setExpr.isVariable&&!setExpr.isGetSlot)throw new Error("Invalid expr in pre op "+setExpr);var newValue,value=this.visit(setExpr);switch(node.name){case"++":newValue=value+1;break;case"--":newValue=value-1;break;default:throw new Error("No semantics for pre op "+node.name)}return setExpr.set(newValue,frame,this),newValue
},visitPostOp:function(node){var frame=this.currentFrame,setExpr=node.expr;if(!setExpr.isVariable&&!setExpr.isGetSlot)throw dbgOn(new Error("Invalid expr in post op "+setExpr));var newValue,value=this.visit(setExpr);switch(node.name){case"++":newValue=value+1;break;case"--":newValue=value-1;break;default:throw new Error("No semantics for post op "+node.name)}return setExpr.set(newValue,frame,this),value},visitThis:function(){return this.currentFrame.getThis()},visitVariable:function(node){return this.currentFrame.lookup(node.name)},visitGetSlot:function(node){var obj=this.visit(node.obj),name=this.visit(node.slotName),value=obj[name];return value},visitBreak:function(){this.currentFrame.triggerBreak()},visitContinue:function(){this.currentFrame.triggerContinue()},visitDebugger:function($super,node){this.currentFrame.putValue(node,1),this.currentFrame.halt(node,!0)},visitArrayLiteral:function(node){for(var result=new Array(node.elements.length),i=0;i<node.elements.length;i++)result[i]=this.visit(node.elements[i]);return result},visitReturn:function(node){var frame=this.currentFrame,val=this.visit(node.expr);return frame.triggerReturn(),val},visitWith:function(){throw new Error("with statement not yet supported")},visitSend:function(node){var recv=this.visit(node.recv),property=this.visit(node.property),argValues=node.args.collect(function(ea){return this.visit(ea)},this);return this.invoke(node,recv,recv[property],argValues)},visitCall:function(node){var func=this.visit(node.fn),argValues=node.args.collect(function(ea){return this.visit(ea)},this);return this.invoke(node,void 0,func,argValues)},visitNew:function(node){return this.visit(node.clsExpr)},visitVarDeclaration:function(node){var frame=this.currentFrame,val=this.visit(node.val);return frame.addToMapping(node.name,val),val},visitThrow:function(node){var exceptionObj=(this.currentFrame,this.visit(node.expr));throw exceptionObj},visitTryCatchFinally:function(node){var result,frame=this.currentFrame;try{result=this.visit(node.trySeq)}catch(e){frame.addToMapping(node.err.name,e),result=this.visit(node.catchSeq)}finally{node.finallySeq.isVariable&&"undefined"==node.finallySeq.name||(result=this.visit(node.finallySeq))}return result},visitFunction:function(node){var frame=this.currentFrame;return Object.isString(node.name)&&frame.addToMapping(node.name,node),node.prototype||(node.prototype={}),node.lexicalScope=frame,node.asFunction()},visitObjectLiteral:function(node){for(var obj=(this.currentFrame,{}),i=0;i<node.properties.length;i++){var name=node.properties[i].name,prop=this.visit(node.properties[i].property);obj[name]=prop}return obj},visitObjProperty:function(){throw new Error("?????")},visitSwitch:function(node){for(var result,frame=this.currentFrame,val=this.visit(node.expr),caseMatched=!1,i=0;i<node.cases.length;i++)if(node.cases[i].prevCaseMatched=caseMatched,node.cases[i].switchValue=val,result=this.visit(node.cases[i]),caseMatched=void 0!==result,frame.breakTriggered){frame.stopBreak();break}return result},visitCase:function(node){return node.prevCaseMatched||node.switchValue==this.visit(node.condExpr)?this.visit(node.thenExpr):void 0},visitDefault:function(node){return node.prevCaseMatched?void 0:this.visit(node.defaultExpr)},visitRegex:function(node){return new RegExp(node.exprString,node.flags)}}),users.timfelgentreff.jsinterpreter.Node.addMethods("interpretation",{position:function(){return this.pos[0]+"-"+this.pos[1]},startInterpretation:function(optMapping){var interpreter=new users.timfelgentreff.jsinterpreter.InterpreterVisitor;return interpreter.run(this,optMapping)},toSource:function(){return this.toString()},parentSource:function(){return this.source?this.source:this.hasParent()?this.getParent().parentSource():this.toSource()}}),users.timfelgentreff.jsinterpreter.Variable.addMethods("interpretation",{set:function(value,frame){var search=frame.findFrame(this.name),scope=search?search.frame:users.timfelgentreff.jsinterpreter.Interpreter.Frame.global();return scope.addToMapping(this.name,value)}}),users.timfelgentreff.jsinterpreter.GetSlot.addMethods("interpretation",{set:function(value,frame,interpreter){var obj=interpreter.visit(this.obj),name=interpreter.visit(this.slotName);return obj[name]=value}}),users.timfelgentreff.jsinterpreter.Function.addMethods("interpretation",{position:function(){return this.pos[0]+"-"+this.pos[1]},basicApply:function(frame){var interpreter=new users.timfelgentreff.jsinterpreter.InterpreterVisitor;try{return users.timfelgentreff.jsinterpreter.Interpreter.Frame.top=frame,interpreter.runWithFrame(this.body,frame)}finally{users.timfelgentreff.jsinterpreter.Interpreter.Frame.top=null}},apply:function(thisObj,argValues,startHalted){var calledFunction=this.asFunction(),mapping=Object.extend({},calledFunction.getVarMapping()),argNames=this.argNames();mapping.$super&&"$super"==argNames[0]&&argValues.unshift(mapping.$super);var scope=this.lexicalScope?this.lexicalScope:users.timfelgentreff.jsinterpreter.Interpreter.Frame.global(),newFrame=scope.newScope(calledFunction,mapping);return void 0!==thisObj&&newFrame.setThis(thisObj),newFrame.setArguments(argValues),newFrame.setCaller(users.timfelgentreff.jsinterpreter.Interpreter.Frame.top),startHalted&&newFrame.breakAtFirstStatement(),this.basicApply(newFrame)},asFunction:function(optFunc){function fn(){return that.apply(this,Array.from(arguments))}if(this._chachedFunction)return this._chachedFunction;var that=this;return fn.methodName=this.name(),fn.forInterpretation=function(){return fn},fn.ast=function(){return that},fn.startHalted=function(){return function(){return that.apply(this,Array.from(arguments),!0)}},fn.evaluatedSource=function(){return that.parentSource()},optFunc&&(fn.source=optFunc.toSource(),fn.varMapping=optFunc.getVarMapping(),fn.prototype=optFunc.prototype,optFunc.declaredClass&&(fn.declaredClass=optFunc.declaredClass),optFunc.methodName&&(fn.methodName=optFunc.methodName),optFunc.sourceModule&&(fn.sourceModule=optFunc.sourceModule),optFunc.declaredObject&&(fn.declaredObject=optFunc.declaredObject),optFunc.name&&(fn.methodName=optFunc.name)),this._chachedFunction=fn}},"continued interpretation",{resume:function(frame){return this.basicApply(frame)}}),Object.extend(users.timfelgentreff.jsinterpreter,{halt:function(){return!1},doWithHalt:function(func,halt){var oldHalt=users.timfelgentreff.jsinterpreter.halt;users.timfelgentreff.jsinterpreter.halt=halt||Functions.True;try{func()}finally{users.timfelgentreff.jsinterpreter.halt=oldHalt}}}),users.timfelgentreff.jsinterpreter.Visitor.subclass("users.timfelgentreff.jsinterpreter.ContainsDebuggerVisitor","visiting",{visitSequence:function(node){for(var i=0;i<node.children.length;i++)if(this.visit(node.children[i]))return!0;return!1},visitNumber:function(){return!1},visitString:function(){return!1},visitCond:function(node){return this.visit(node.condExpr)||this.visit(node.trueExpr)||this.visit(node.falseExpr)},visitIf:function(node){return this.visitCond(node)},visitWhile:function(node){return this.visit(node.condExpr)||this.visit(node.body)},visitDoWhile:function(node){return this.visit(node.body)||this.visit(node.condExpr)},visitFor:function(node){return this.visit(node.init)||this.visit(node.condExpr)||this.visit(node.body)||this.visit(node.upd)},visitForIn:function(node){return this.visit(node.obj)||this.visit(node.body)},visitSet:function(node){return this.visit(node.left)||this.visit(node.right)},visitModifyingSet:function(node){return this.visit(node.left)||this.visit(node.right)},visitBinaryOp:function(node){return this.visit(node.left)||this.visit(node.right)},visitUnaryOp:function(node){return this.visit(node.expr)},visitPreOp:function(node){return this.visit(node.expr)},visitPostOp:function(node){return this.visit(node.expr)},visitThis:function(){return!1},visitVariable:function(){return!1},visitGetSlot:function(){return!1},visitBreak:function(){return!1},visitDebugger:function(){return!0},visitContinue:function(){return!1},visitArrayLiteral:function(node){for(var i=0;i<node.elements.length;i++)if(this.visit(node.elements[i]))return!0;return!1},visitReturn:function(node){return this.visit(node.expr)},visitWith:function(){throw new Error("with statement not yet supported")},visitSend:function(node){if(this.visit(node.recv))return!0;for(var i=0;i<node.args.length;i++)if(this.visit(node.args[i]))return!0;return!1},visitCall:function(node){if(this.visit(node.fn))return!0;for(var i=0;i<node.args.length;i++)if(this.visit(node.args[i]))return!0;return!1},visitNew:function(node){return this.visit(node.clsExpr)},visitVarDeclaration:function(node){return this.visit(node.val)},visitThrow:function(node){return this.visit(node.expr)},visitTryCatchFinally:function(node){return this.visit(node.trySeq)||this.visit(node.catchSeq)||this.visit(node.finallySeq)},visitFunction:function(node){return this.visit(node.body)},visitObjectLiteral:function(node){for(var i=0;i<node.properties.length;i++)if(this.visit(node.properties[i].property))return!0;return!1},visitObjProperty:function(){return!1},visitSwitch:function(node){if(this.visit(node.expr))return!0;for(var i=0;i<node.cases.length;i++)if(this.visit(node.cases[i]))return!0;return!1},visitCase:function(node){return this.visit(node.condExpr)||this.visit(node.thenExpr)},visitDefault:function(node){return this.visit(node.defaultExpr)},visitRegex:function(){return!1}}),Function.addMethods("ast",{evaluatedSource:function(){return this.toSource()},ast:function(){if(this._cachedAst)return this._cachedAst;var parseResult=users.timfelgentreff.jsinterpreter.Parser.parse(this.toSource(),"topLevel");return!parseResult||Object.isString(parseResult)?parseResult:(parseResult=parseResult.children[0],this._cachedAst=parseResult.isVarDeclaration&&parseResult.val.isFunction?parseResult.val:parseResult)}},"debugging",{forInterpretation:function(){var funcAst=this.ast();return!funcAst.lexicalScope&&this._cachedScope&&(funcAst.lexicalScope=users.timfelgentreff.jsinterpreter.Interpreter.Frame.fromScope(this._cachedScope)),funcAst.asFunction(this)},containsDebugger:function(){return(new users.timfelgentreff.jsinterpreter.ContainsDebuggerVisitor).visit(this.ast())}})}),module("users.timfelgentreff.cassowary.Hashtable").requires().toRun(function(){function hashObject(obj){var hashCode;if("string"==typeof obj)return obj;if(typeof obj.hashCode==FUNCTION)return hashCode=obj.hashCode(),"string"==typeof hashCode?hashCode:hashObject(hashCode);if(typeof obj.toString==FUNCTION)return obj.toString();try{return String(obj)}catch(ex){return Object.prototype.toString.call(obj)}}function equals_fixedValueHasEquals(fixedValue,variableValue){return fixedValue.equals(variableValue)}function equals_fixedValueNoEquals(fixedValue,variableValue){return typeof variableValue.equals==FUNCTION?variableValue.equals(fixedValue):fixedValue===variableValue}function createKeyValCheck(kvStr){return function(kv){if(null===kv)throw new Error("null is not a valid "+kvStr);if("undefined"==typeof kv)throw new Error(kvStr+" must not be undefined")}}function searchBuckets(buckets,hash){for(var bucket,i=buckets.length;i--;)if(bucket=buckets[i],hash===bucket[0])return i;return null}function getBucketForHash(bucketsByHash,hash){var bucket=bucketsByHash[hash];return bucket&&bucket instanceof Bucket?bucket:null}var FUNCTION="function",arrayRemoveAt=typeof Array.prototype.splice==FUNCTION?function(arr,idx){arr.splice(idx,1)}:function(arr,idx){var itemsAfterDeleted,i,len;if(idx===arr.length-1)arr.length=idx;else for(itemsAfterDeleted=arr.slice(idx+1),arr.length=idx,i=0,len=itemsAfterDeleted.length;len>i;++i)arr[idx+i]=itemsAfterDeleted[i]},checkKey=createKeyValCheck("key"),checkValue=createKeyValCheck("value"),EXISTENCE=0,ENTRY=1,ENTRY_INDEX_AND_VALUE=2;Object.subclass("Bucket","default category",{initialize:function(hash,firstKey,firstValue,equalityFunction){this[0]=hash,this.entries=[],this.addEntry(firstKey,firstValue),null!==equalityFunction&&(this.getEqualityFunction=function(){return equalityFunction})},createBucketSearcher:function(mode){var that=this;return function(key){for(var entry,i=that.entries.length,equals=that.getEqualityFunction(key);i--;)if(entry=that.entries[i],equals(key,entry[0]))switch(mode){case EXISTENCE:return!0;case ENTRY:return entry;case ENTRY_INDEX_AND_VALUE:return[i,entry[1]]}return!1}},createBucketLister:function(entryProperty){var that=this;return function(aggregatedArr){for(var startIndex=aggregatedArr.length,i=0,len=that.entries.length;len>i;++i)aggregatedArr[startIndex+i]=that.entries[i][entryProperty]}},getEqualityFunction:function(searchValue){return typeof searchValue.equals==FUNCTION?equals_fixedValueHasEquals:equals_fixedValueNoEquals},getEntryForKey:function(key){return this.createBucketSearcher(ENTRY)(key)},getEntryAndIndexForKey:function(key){return this.createBucketSearcher(ENTRY_INDEX_AND_VALUE)(key)},removeEntryForKey:function(key){var result=this.getEntryAndIndexForKey(key);return result?(arrayRemoveAt(this.entries,result[0]),result[1]):null},addEntry:function(key,value){this.entries[this.entries.length]=[key,value]},keys:function(aggregatedArr){return this.createBucketLister(0)(aggregatedArr)},values:function(aggregatedArr){return this.createBucketLister(1)(aggregatedArr)},getEntries:function(entries){for(var startIndex=entries.length,i=0,len=this.entries.length;len>i;++i)entries[startIndex+i]=this.entries[i].slice(0)},containsKey:function(key){return this.createBucketSearcher(EXISTENCE)(key)},containsValue:function(value){for(var i=this.entries.length;i--;)if(value===this.entries[i][1])return!0;return!1}}),Object.subclass("Hashtable","default category",{initialize:function(hashingFunctionParam,equalityFunctionParam){this.hashingFunctionParam=hashingFunctionParam,this.equalityFunctionParam=equalityFunctionParam,this.hasCustomEqualityFunction=typeof equalityFunctionParam==FUNCTION,this.buckets=[],this.bucketsByHash={}},hashingFunction:function(key){return(typeof this.hashingFunctionParam==FUNCTION?this.hashingFunctionParam:hashObject)(key)},equalityFunction:function(arg1,arg2){return(this.hasCustomEqualityFunction?equalityFunctionParam:function(a,b){return a==b})(arg1,arg2)},put:function(key,value){checkKey(key),checkValue(value);var bucket,bucketEntry,hash=this.hashingFunction(key),oldValue=null;return bucket=getBucketForHash(this.bucketsByHash,hash),bucket?(bucketEntry=bucket.getEntryForKey(key),bucketEntry?(oldValue=bucketEntry[1],bucketEntry[1]=value):bucket.addEntry(key,value)):(bucket=new Bucket(hash,key,value,this.hasCustomEqualityFunction?this.equalityFunction:null),this.buckets[this.buckets.length]=bucket,this.bucketsByHash[hash]=bucket),oldValue},get:function(key){checkKey(key);var hash=this.hashingFunction(key),bucket=getBucketForHash(this.bucketsByHash,hash);if(bucket){var bucketEntry=bucket.getEntryForKey(key);if(bucketEntry)return bucketEntry[1]}return null},containsKey:function(key){checkKey(key);var bucketKey=this.hashingFunction(key),bucket=getBucketForHash(this.bucketsByHash,bucketKey);return bucket?bucket.containsKey(key):!1},containsValue:function(value){checkValue(value);for(var i=this.buckets.length;i--;)if(this.buckets[i].containsValue(value))return!0;return!1},clear:function(){this.buckets.length=0,this.bucketsByHash={}},isEmpty:function(){return!this.buckets.length},createBucketAggregator:function(bucketFuncName){var that=this;return function(){for(var aggregated=[],i=that.buckets.length;i--;)that.buckets[i][bucketFuncName](aggregated);return aggregated}},keys:function(){return this.createBucketAggregator("keys")()},values:function(){return this.createBucketAggregator("values")()},entries:function(){return this.createBucketAggregator("getEntries")()},remove:function(key){checkKey(key);var bucketIndex,hash=this.hashingFunction(key),oldValue=null,bucket=getBucketForHash(this.bucketsByHash,hash);return bucket&&(oldValue=bucket.removeEntryForKey(key),null!==oldValue&&(bucket.entries.length||(bucketIndex=searchBuckets(this.buckets,hash),arrayRemoveAt(this.buckets,bucketIndex),delete this.bucketsByHash[hash]))),oldValue},size:function(){for(var total=0,i=this.buckets.length;i--;)total+=this.buckets[i].entries.length;return total},each:function(callback){for(var entry,that=this,entries=that.entries(),i=entries.length;i--;)entry=entries[i],callback(entry[0],entry[1])},escapingEach:function(callback){for(var entry,that=this,entries=that.entries(),i=entries.length,context={};i--;){if(entry=entries[i],context=callback(entry[0],entry[1]),context&&context.hasOwnProperty("return"))return context["return"];if(context&&context.hasOwnProperty("retval"))return context.retval;if(context&&context.hasOwnProperty("break"))break}},putAll:function(hashtable,conflictCallback){for(var entry,key,value,thisValue,that=this,entries=hashtable.entries(),i=entries.length,hasConflictCallback=typeof conflictCallback==FUNCTION;i--;)entry=entries[i],key=entry[0],value=entry[1],hasConflictCallback&&(thisValue=that.get(key))&&(value=conflictCallback(key,thisValue,value)),that.put(key,value)},clone:function(){var that=this,clone=new Hashtable(this.hashingFunctionParam,this.equalityFunctionParam);return clone.putAll(that),clone}})}),module("users.timfelgentreff.cassowary.HashSet").requires("users.timfelgentreff.cassowary.Hashtable").toRun(function(){Object.subclass("HashSet","default category",{initialize:function(hashingFunction,equalityFunction){this.hashingFunction=hashingFunction,this.equalityFunction=equalityFunction,this.hashTable=new Hashtable(hashingFunction,equalityFunction)},add:function(o){this.hashTable.put(o,!0)},addAll:function(arr){for(var i=arr.length;i--;)this.hashTable.put(arr[i],!0)},values:function(){return this.hashTable.keys()},remove:function(o){return this.hashTable.remove(o)?o:null},contains:function(o){return this.hashTable.containsKey(o)},clear:function(){this.hashTable.clear()},size:function(){return this.hashTable.size()},isEmpty:function(){return this.hashTable.isEmpty()},clone:function(){var h=new HashSet(this.hashingFunction,this.equalityFunction);return h.addAll(this.hashTable.keys()),h},intersection:function(){for(var val,intersection=new HashSet(this.hashingFunction,this.equalityFunction),values=this.hashSet.values(),i=values.length;i--;)val=values[i],this.hashTable.containsKey(val)&&intersection.add(val);return intersection},union:function(){for(var val,union=this.clone(),values=this.hashSet.values(),i=values.length;i--;)val=values[i],this.hashTable.containsKey(val)||union.add(val);return union},isSubsetOf:function(){for(var values=this.hashTable.keys(),i=values.length;i--;)if(!this.hashSet.contains(values[i]))return!1;return!0},each:function(f){for(var e=this.hashTable.keys(),i=e.length;i--&&i>=0;)f(this.hashTable.keys()[i])},escapingEach:function(callback){return this.hashTable.escapingEach(callback)}})}),module("users.timfelgentreff.cassowary.DwarfCassowary").requires("users.timfelgentreff.cassowary.HashSet").toRun(function(){Object.extend(Global,{ExCLError:function(){return new Error("(ExCLError) An error has occured in CL")}}),Object.extend(ExCLError,{subclass:function(name,category,obj){Global[name]=function(){return new Error(obj.description())}}}),ExCLError.subclass("ExCLConstraintNotFound","default category",{description:function(){return"(ExCLConstraintNotFound) Tried to remove a constraint never added to the tableu"}}),ExCLError.subclass("ExCLInternalError","default category",{initialize:function(s){description_=s},description:function(){return"(ExCLInternalError) "+description_}}),ExCLError.subclass("ExCLNonlinearExpression","default category",{description:function(){return"(ExCLNonlinearExpression) The resulting expression would be nonlinear"}}),ExCLError.subclass("ExCLNotEnoughStays","default category",{description:function(){return"(ExCLNotEnoughStays) There are not enough stays to give specific values to every variable"}}),ExCLError.subclass("ExCLRequiredFailure","default category",{description:function(){return"(ExCLRequiredFailure) A required constraint cannot be satisfied"}}),ExCLError.subclass("ExCLTooDifficult","default category",{description:function(){return"(ExCLTooDifficult) The constraints are too difficult to solve"}}),Object.subclass("ClSymbolicWeight","default category",{initialize:function(w1,w2,w3){this._values=new Array(w1,w2,w3)},times:function(n){return new ClSymbolicWeight(this._values[0]*n,this._values[1]*n,this._values[2]*n)},divideBy:function(n){return new ClSymbolicWeight(this._values[0]/n,this._values[1]/n,this._values[2]/n)},add:function(c){return new ClSymbolicWeight(this._values[0]+c._values[0],this._values[1]+c._values[1],this._values[2]+c._values[2])},subtract:function(c){return new ClSymbolicWeight(this._values[0]-c._values[0],this._values[1]-c._values[1],this._values[2]-c._values[2])},lessThan:function(c){for(var i=0;i<this._values.length;++i){if(this._values[i]<c._values[i])return!0;if(this._values[i]>c._values[i])return!1}return!1},lessThanOrEqual:function(c){for(var i=0;i<this._values.length;++i){if(this._values[i]<c._values[i])return!0;if(this._values[i]>c._values[i])return!1}return!0},equal:function(c){for(var i=0;i<this._values.length;++i)if(this._values[i]!=c._values[i])return!1;return!0},greaterThan:function(c){return!this.lessThanOrEqual(c)},greaterThanOrEqual:function(c){return!this.lessThan(c)},isNegative:function(){return this.lessThan(ClSymbolicWeight.clsZero)},toDouble:function(){sum=0,factor=1,multiplier=1e3;for(var i=this._values.length-1;i>=0;--i)sum+=this._values[i]*factor,factor*=multiplier;return sum},toString:function(){return"["+this._values[0]+","+this._values[1]+","+this._values[2]+"]"},cLevels:function(){return 3}}),ClSymbolicWeight.clsZero=new ClSymbolicWeight(0,0,0),Object.subclass("ClStrength","default category",{initialize:function(name,symbolicWeight,w2,w3){this._name=name,this._symbolicWeight=symbolicWeight instanceof ClSymbolicWeight?symbolicWeight:new ClSymbolicWeight(symbolicWeight,w2,w3)},isRequired:function(){return this==ClStrength.required},toString:function(){return this._name+(this.isRequired()?"":":"+this.symbolicWeight())},symbolicWeight:function(){return this._symbolicWeight},name:function(){return this._name},set_name:function(name){this._name=name},set_symbolicWeight:function(symbolicWeight){this._symbolicWeight=symbolicWeight}}),ClStrength.required=new ClStrength("<Required>",1e3,1e3,1e3),ClStrength.strong=new ClStrength("strong",1,0,0),ClStrength.medium=new ClStrength("medium",0,1,0),ClStrength.weak=new ClStrength("weak",0,0,1),Object.subclass("ClAbstractVariable","default category",{initialize:function(a1,a2){if(this.hash_code=ClAbstractVariable.iVariableNumber++,"string"==typeof a1||null==a1)this._name=a1||"v"+this.hash_code;else{var varnumber=a1,prefix=a2;this._name=prefix+varnumber}},hashCode:function(){return this.hash_code},name:function(){return this._name},setName:function(name){this._name=name},isDummy:function(){return!1},isExternal:function(){throw"abstract isExternal"},isPivotable:function(){throw"abstract isPivotable"},isRestricted:function(){throw"abstract isRestricted"},toString:function(){return"ABSTRACT["+this._name+"]"}}),ClAbstractVariable.iVariableNumber=1,ClAbstractVariable.subclass("ClVariable","default category",{initialize:function($super,name_or_val,value){this._name="",this._value=0,"string"==typeof name_or_val?($super(name_or_val),this._value=value||0):"number"==typeof name_or_val?($super(),this._value=name_or_val):$super(),ClVariable._ourVarMap&&(ClVariable._ourVarMap[this._name]=this)},isDummy:function(){return!1},isExternal:function(){return!0},isPivotable:function(){return!1},isRestricted:function(){return!1},toString:function(){return"["+this.name()+":"+this._value+"]"},value:function(){return this._value},set_value:function(value){this._value=value},change_value:function(value){this._value=value},setAttachedObject:function(o){this._attachedObject=o},getAttachedObject:function(){return this._attachedObject}}),ClVariable.setVarMap=function(map){this._ourVarMap=map},ClVariable.getVarMap=function(){return this._ourVarMap},ClAbstractVariable.subclass("ClDummyVariable","default category",{initialize:function($super,name_or_val,prefix){$super(name_or_val,prefix)},isDummy:function(){return!0},isExternal:function(){return!1},isPivotable:function(){return!1},isRestricted:function(){return!0},toString:function(){return"["+this.name()+":dummy]"}}),ClAbstractVariable.subclass("ClObjectiveVariable","default category",{initialize:function($super,name_or_val,prefix){$super(name_or_val,prefix)},isExternal:function(){return!1},isPivotable:function(){return!1},isRestricted:function(){return!1},toString:function(){return"["+this.name()+":obj]"}}),ClAbstractVariable.subclass("ClSlackVariable","default category",{initialize:function($super,name_or_val,prefix){$super(name_or_val,prefix)},isExternal:function(){return!1},isPivotable:function(){return!0},isRestricted:function(){return!0},toString:function(){return"["+this.name()+":slack]"}}),Object.subclass("ClPoint","default category",{initialize:function(x,y,suffix){this.x=x instanceof ClVariable?x:null!=suffix?new ClVariable("x"+suffix,x):new ClVariable(x),this.y=y instanceof ClVariable?y:null!=suffix?new ClVariable("y"+suffix,y):new ClVariable(y)},SetXY:function(x,y){x instanceof ClVariable?this.x=x:this.x.set_value(x),y instanceof ClVariable?this.y=y:this.y.set_value(y)},X:function(){return this.x},Y:function(){return this.y},Xvalue:function(){return this.x.value()},Yvalue:function(){return this.y.value()},toString:function(){return"("+this.x+", "+this.y+")"}}),Object.subclass("ClLinearExpression","default category",{initialize:function(clv,value,constant){CL.fGC&&print("new ClLinearExpression"),this._constant=constant||0,this._terms=new Hashtable,clv instanceof ClAbstractVariable?this._terms.put(clv,value||1):"number"==typeof clv&&(this._constant=clv)},initializeFromHash:function(constant,terms){return CL.fGC&&print("clone ClLinearExpression"),this._constant=constant,this._terms=terms.clone(),this},multiplyMe:function(x){var that=this;return this._constant*=x,this._terms.each(function(clv,coeff){that._terms.put(clv,coeff*x)}),this},clone:function(){return(new ClLinearExpression).initializeFromHash(this._constant,this._terms)},times:function(x){if("number"==typeof x)return this.clone().multiplyMe(x);if(this.isConstant())return x.times(this._constant);if(x.isConstant())return this.times(x._constant);throw new ExCLNonlinearExpression},plus:function(expr){return expr instanceof ClLinearExpression?this.clone().addExpression(expr,1):expr instanceof ClVariable?this.clone().addVariable(expr,1):void 0},minus:function(expr){return expr instanceof ClLinearExpression?this.clone().addExpression(expr,-1):expr instanceof ClVariable?this.clone().addVariable(expr,-1):void 0},divide:function(x){if("number"==typeof x){if(CL.approx(x,0))throw new ExCLNonlinearExpression;return this.times(1/x)}if(x instanceof ClLinearExpression){if(!x.isConstant)throw new ExCLNonlinearExpression;return this.times(1/x._constant)}},divFrom:function(){if(!this.isConstant()||CL.approx(this._constant,0))throw new ExCLNonlinearExpression;return x.divide(this._constant)},subtractFrom:function(expr){return expr.minus(this)},addExpression:function(expr,n,subject,solver){expr instanceof ClAbstractVariable&&(expr=new ClLinearExpression(expr),print("addExpression: Had to cast a var to an expression")),this.incrementConstant(n*expr.constant()),n=n||1;var that=this;return expr.terms().each(function(clv,coeff){that.addVariable(clv,coeff*n,subject,solver)}),this},addVariable:function(v,c,subject,solver){return c=c||1,CL.fTraceOn&&CL.fnenterprint("CLE: addVariable:"+v+", "+c),coeff=this._terms.get(v),coeff?(new_coefficient=coeff+c,CL.approx(new_coefficient,0)?(solver&&solver.noteRemovedVariable(v,subject),this._terms.remove(v)):this._terms.put(v,new_coefficient)):CL.approx(c,0)||(this._terms.put(v,c),solver&&solver.noteAddedVariable(v,subject)),this},setVariable:function(v,c){return this._terms.put(v,c),this},anyPivotableVariable:function(){if(this.isConstant())throw new ExCLInternalError("anyPivotableVariable called on a constant");var pivotable=null;try{this._terms.each(function(clv){if(clv.isPivotable())throw pivotable=clv,"NLR"})}catch(e){if("NLR"===e)return pivotable;throw e}return null},substituteOut:function(outvar,expr,subject,solver){var that=this;CL.fTraceOn&&CL.fnenterprint("CLE:substituteOut: "+outvar+", "+expr+", "+subject+", ..."),CL.fTraceOn&&CL.traceprint("this = "+this);var multiplier=this._terms.remove(outvar);this.incrementConstant(multiplier*expr.constant()),expr.terms().each(function(clv,coeff){var old_coeff=that._terms.get(clv);if(old_coeff){var newCoeff=old_coeff+multiplier*coeff;CL.approx(newCoeff,0)?(solver.noteRemovedVariable(clv,subject),that._terms.remove(clv)):that._terms.put(clv,newCoeff)}else that._terms.put(clv,multiplier*coeff),solver.noteAddedVariable(clv,subject)}),CL.fTraceOn&&CL.traceprint("Now this is "+this)},changeSubject:function(old_subject,new_subject){this._terms.put(old_subject,this.newSubject(new_subject))},newSubject:function(subject){CL.fTraceOn&&CL.fnenterprint("newSubject:"+subject);var reciprocal=1/this._terms.remove(subject);return this.multiplyMe(-reciprocal),reciprocal},coefficientFor:function(clv){return this._terms.get(clv)||0},constant:function(){return this._constant},set_constant:function(c){this._constant=c},terms:function(){return this._terms},incrementConstant:function(c){this._constant+=c},isConstant:function(){return 0==this._terms.size()},toString:function(){var bstr="",needsplus=!1;if(!CL.approx(this._constant,0)||this.isConstant()){if(bstr+=this._constant,this.isConstant())return bstr;needsplus=!0}return this._terms.each(function(clv,coeff){needsplus&&(bstr+=" + "),bstr+=coeff+"*"+clv,needsplus=!0}),bstr},Plus:function(e1,e2){return e1.plus(e2)},Minus:function(e1,e2){return e1.minus(e2)},Times:function(e1,e2){return e1.times(e2)},Divide:function(e1,e2){return e1.divide(e2)}}),Object.subclass("ClConstraint","default category",{initialize:function(strength,weight){this.hash_code=ClConstraint.iConstraintNumber++,this._strength=strength||ClStrength.required,this._weight=weight||1,this._times_added=0},hashCode:function(){return this.hash_code},isEditConstraint:function(){return!1},isInequality:function(){return!1},isRequired:function(){return this._strength.isRequired()},isStayConstraint:function(){return!1},strength:function(){return this._strength},weight:function(){return this._weight},toString:function(){return this._strength+" {"+this._weight+"} ("+this.expression()+")"},setAttachedObject:function(o){this._attachedObject=o},getAttachedObject:function(){return this._attachedObject},changeStrength:function(strength){if(0!=this._times_added)throw new ExCLTooDifficult;this.setStrength(strength)},addedTo:function(){++this._times_added},removedFrom:function(){--this._times_added},setStrength:function(strength){this._strength=strength},setWeight:function(weight){this._weight=weight}}),ClConstraint.subclass("ClEditOrStayConstraint","default category",{initialize:function($super,clv,strength,weight){$super(strength,weight),this._variable=clv,this._expression=new ClLinearExpression(this._variable,-1,this._variable.value())},variable:function(){return this._variable},expression:function(){return this._expression},setVariable:function(v){this._variable=v}}),ClEditOrStayConstraint.subclass("ClEditConstraint","default category",{initialize:function($super,clv,strength,weight){$super(clv,strength,weight)},isEditConstraint:function(){return!0},toString:function(){return"edit"+$super()}}),ClEditOrStayConstraint.subclass("ClStayConstraint","default category",{initialize:function($super,clv,strength,weight){$super(clv,strength||ClStrength.weak,weight)},isStayConstraint:function(){return!0},toString:function(){return"stay "+$super()}}),ClConstraint.iConstraintNumber=1,ClConstraint.subclass("ClLinearConstraint","default category",{initialize:function($super,cle,strength,weight){$super(strength,weight),this._expression=cle
},expression:function(){return this._expression},setExpression:function(expr){this._expression=expr}}),ClLinearConstraint.subclass("ClLinearInequality","default category",{initialize:function($super,a1,a2,a3,a4,a5){if(a1 instanceof ClLinearExpression&&a3 instanceof ClAbstractVariable){var cle=a1,op=a2,clv=a3,strength=a4,weight=a5;if($super(cle.clone(),strength,weight),op==CL.LEQ)this._expression.multiplyMe(-1),this._expression.addVariable(clv);else{if(op!=CL.GEQ)throw new ExCLInternalError("Invalid operator in ClLinearInequality constructor");this._expression.addVariable(clv,-1)}}else{if(a1 instanceof ClLinearExpression)return $super(a1,a2,a3);if(a2==CL.GEQ)$super(new ClLinearExpression(a3),a4,a5),this._expression.multiplyMe(-1),this._expression.addVariable(a1);else{if(a2!=CL.LEQ)throw new ExCLInternalError("Invalid operator in ClLinearInequality constructor");$super(new ClLinearExpression(a3),a4,a5),this._expression.addVariable(a1,-1)}}},isInequality:function(){return!0},toString:function($super){return $super()+" >= 0 )"}}),ClLinearConstraint.subclass("ClLinearEquation","default category",{initialize:function($super,a1,a2,a3,a4){if(a1 instanceof ClLinearExpression&&!a2||a2 instanceof ClStrength)$super(a1,a2,a3);else if(a1 instanceof ClAbstractVariable&&a2 instanceof ClLinearExpression){var clv=a1,cle=a2,strength=a3,weight=a4;$super(cle,strength,weight),this._expression.addVariable(clv,-1)}else if(a1 instanceof ClAbstractVariable&&"number"==typeof a2){var clv=a1,val=a2,strength=a3,weight=a4;$super(new ClLinearExpression(val),strength,weight),this._expression.addVariable(clv,-1)}else if(a1 instanceof ClLinearExpression&&a2 instanceof ClAbstractVariable){var cle=a1,clv=a2,strength=a3,weight=a4;$super(cle.clone(),strength,weight),this._expression.addVariable(clv,-1)}else{if(!(a1 instanceof ClLinearExpression||a1 instanceof ClAbstractVariable||"number"==typeof a1)||!(a2 instanceof ClLinearExpression||a2 instanceof ClAbstractVariable||"number"==typeof a2))throw"Bad initializer to ClLinearEquation";a1=a1 instanceof ClLinearExpression?a1.clone():new ClLinearExpression(a1),a2=a2 instanceof ClLinearExpression?a2.clone():new ClLinearExpression(a2),$super(a1,a3,a4),this._expression.addExpression(a2,-1)}CL.Assert(this._strength instanceof ClStrength,"_strength not set")},toString:function(){return $super()+" = 0 )"}}),Object.subclass("ClEditInfo","default category",{initialize:function(cn_,eplus_,eminus_,prevEditConstant_,i_){this.cn=cn_,this.clvEditPlus=eplus_,this.clvEditMinus=eminus_,this.prevEditConstant=prevEditConstant_,this.i=i_},Index:function(){return this.i},Constraint:function(){return this.cn},ClvEditPlus:function(){return this.clvEditPlus},ClvEditMinus:function(){return this.clvEditMinus},PrevEditConstant:function(){return this.prevEditConstant},SetPrevEditConstant:function(prevEditConstant_){this.prevEditConstant=prevEditConstant_},toString:function(){return"<cn="+this.cn+",ep="+this.clvEditPlus+",em="+this.clvEditMinus+",pec="+this.prevEditConstant+",i="+i+">"}}),Object.subclass("ClTableau","default category",{initialize:function(){this._columns=new Hashtable,this._rows=new Hashtable,this._infeasibleRows=new HashSet,this._externalRows=new HashSet,this._externalParametricVars=new HashSet},noteRemovedVariable:function(v,subject){CL.fVerboseTraceOn&&CL.fnenterprint("noteRemovedVariable: "+v+", "+subject),null!=subject&&this._columns.get(v).remove(subject)},noteAddedVariable:function(v,subject){CL.fVerboseTraceOn&&CL.fnenterprint("noteAddedVariable: "+v+", "+subject),subject&&this.insertColVar(v,subject)},getInternalInfo:function(){var retstr="Tableau Information:\n";return retstr+="Rows: "+this._rows.size(),retstr+=" (= "+(this._rows.size()-1)+" constraints)",retstr+="\nColumns: "+this._columns.size(),retstr+="\nInfeasible Rows: "+this._infeasibleRows.size(),retstr+="\nExternal basic variables: "+this._externalRows.size(),retstr+="\nExternal parametric variables: ",retstr+=this._externalParametricVars.size(),retstr+="\n"},toString:function(){var bstr="Tableau:\n";return this._rows.each(function(clv,expr){bstr+=clv,bstr+=" <==> ",bstr+=expr,bstr+="\n"}),bstr+="\nColumns:\n",bstr+=CL.hashToString(this._columns),bstr+="\nInfeasible rows: ",bstr+=CL.setToString(this._infeasibleRows),bstr+="External basic variables: ",bstr+=CL.setToString(this._externalRows),bstr+="External parametric variables: ",bstr+=CL.setToString(this._externalParametricVars)},insertColVar:function(param_var,rowvar){var rowset=this._columns.get(param_var);rowset||this._columns.put(param_var,rowset=new HashSet),rowset.add(rowvar)},addRow:function(aVar,expr){var that=this;CL.fTraceOn&&CL.fnenterprint("addRow: "+aVar+", "+expr),this._rows.put(aVar,expr),expr.terms().each(function(clv){that.insertColVar(clv,aVar),clv.isExternal()&&that._externalParametricVars.add(clv)}),aVar.isExternal()&&this._externalRows.add(aVar),CL.fTraceOn&&CL.traceprint(this.toString())},removeColumn:function(aVar){var that=this;CL.fTraceOn&&CL.fnenterprint("removeColumn:"+aVar);var rows=this._columns.remove(aVar);rows?rows.each(function(clv){var expr=that._rows.get(clv);expr.terms().remove(aVar)}):CL.fTraceOn&&CL.debugprint("Could not find var "+aVar+" in _columns"),aVar.isExternal()&&(this._externalRows.remove(aVar),this._externalParametricVars.remove(aVar))},removeRow:function(aVar){var that=this;CL.fTraceOn&&CL.fnenterprint("removeRow:"+aVar);var expr=this._rows.get(aVar);return CL.Assert(null!=expr),expr.terms().each(function(clv){var varset=that._columns.get(clv);null!=varset&&(CL.fTraceOn&&CL.debugprint("removing from varset "+aVar),varset.remove(aVar))}),this._infeasibleRows.remove(aVar),aVar.isExternal()&&this._externalRows.remove(aVar),this._rows.remove(aVar),CL.fTraceOn&&CL.fnexitprint("returning "+expr),expr},substituteOut:function(oldVar,expr){var that=this;CL.fTraceOn&&CL.fnenterprint("substituteOut:"+oldVar+", "+expr),CL.fTraceOn&&CL.traceprint(this.toString());var varset=this._columns.get(oldVar);varset.each(function(v){var row=that._rows.get(v);row.substituteOut(oldVar,expr,v,that),v.isRestricted()&&row.constant()<0&&that._infeasibleRows.add(v)}),oldVar.isExternal()&&(this._externalRows.add(oldVar),this._externalParametricVars.remove(oldVar)),this._columns.remove(oldVar)},columns:function(){return this._columns},rows:function(){return this._rows},columnsHasKey:function(subject){return null!=this._columns.get(subject)},rowExpression:function(v){return this._rows.get(v)}}),ClTableau.subclass("ClSimplexSolver","default category",{initialize:function($super){$super(),this._stayMinusErrorVars=new Array,this._stayPlusErrorVars=new Array,this._errorVars=new Hashtable,this._markerVars=new Hashtable,this._resolve_pair=new Array(0,0),this._objective=new ClObjectiveVariable("Z"),this._editVarMap=new Hashtable,this._slackCounter=0,this._artificialCounter=0,this._dummyCounter=0,this._epsilon=1e-8,this._fOptimizeAutomatically=!0,this._fNeedsSolving=!1,this._rows=new Hashtable,this._rows.put(this._objective,new ClLinearExpression),this._stkCedcns=new Array,this._stkCedcns.push(0),CL.fTraceOn&&CL.traceprint("objective expr == "+this.rowExpression(this._objective))},addLowerBound:function(v,lower){var cn=new ClLinearInequality(v,CL.GEQ,new ClLinearExpression(lower));return this.addConstraint(cn)},addUpperBound:function(v,upper){var cn=new ClLinearInequality(v,CL.LEQ,new ClLinearExpression(upper));return this.addConstraint(cn)},addBounds:function(v,lower,upper){return this.addLowerBound(v,lower),this.addUpperBound(v,upper),this},addConstraint:function(cn){CL.fTraceOn&&CL.fnenterprint("addConstraint: "+cn);var eplus_eminus=new Array(2),prevEConstant=new Array(1),expr=this.newExpression(cn,eplus_eminus,prevEConstant);prevEConstant=prevEConstant[0];var fAddedOkDirectly=!1;if(fAddedOkDirectly=this.tryAddingDirectly(expr),fAddedOkDirectly||this.addWithArtificialVariable(expr),this._fNeedsSolving=!0,cn.isEditConstraint()){var i=this._editVarMap.size(),clvEplus=eplus_eminus[0],clvEminus=eplus_eminus[1];!clvEplus instanceof ClSlackVariable&&print("clvEplus not a slack variable = "+clvEplus),!clvEminus instanceof ClSlackVariable&&print("clvEminus not a slack variable = "+clvEminus),this._editVarMap.put(cn.variable(),new ClEditInfo(cn,clvEplus,clvEminus,prevEConstant,i))}return this._fOptimizeAutomatically&&(this.optimize(this._objective),this.setExternalVariables()),cn.addedTo(this),cn},addConstraintNoException:function(cn){CL.fTraceOn&&CL.fnenterprint("addConstraintNoException: "+cn);try{return this.addConstraint(cn),!0}catch(e){return!1}},addEditVar:function(v,strength){CL.fTraceOn&&CL.fnenterprint("addEditVar: "+v+" @ "+strength),strength=strength||ClStrength.strong;var cnEdit=new ClEditConstraint(v,strength);return this.addConstraint(cnEdit)},removeEditVar:function(v){var cei=this._editVarMap.get(v),cn=cei.Constraint();return this.removeConstraint(cn),this},beginEdit:function(){return this.solve(),CL.Assert(this._editVarMap.size()>0,"_editVarMap.size() > 0"),this._infeasibleRows.clear(),this.resetStayConstants(),this._stkCedcns.push(this._editVarMap.size()),this},endEdit:function(){CL.Assert(this._editVarMap.size()>0,"_editVarMap.size() > 0"),this.resolve(),this._stkCedcns.pop();var n=this._stkCedcns[this._stkCedcns.length-1];return this.removeEditVarsTo(n),this},removeAllEditVars:function(){return this.removeEditVarsTo(0)},removeEditVarsTo:function(n){try{var that=this;return this._editVarMap.each(function(v,cei){cei.Index()>=n&&that.removeEditVar(v)}),CL.Assert(this._editVarMap.size()==n,"_editVarMap.size() == n"),this}catch(e){throw new ExCLInternalError("Constraint not found in removeEditVarsTo")}},addPointStays:function(listOfPoints){CL.fTraceOn&&CL.fnenterprint("addPointStays"+listOfPoints);for(var weight=1,multiplier=2,i=0;i<listOfPoints.length;i++)this.addPointStay(listOfPoints[i],weight),weight*=multiplier;return this},addPointStay:function(a1,a2,a3){if(a1 instanceof ClPoint){var clp=a1,weight=a2;this.addStay(clp.X(),ClStrength.weak,weight||1),this.addStay(clp.Y(),ClStrength.weak,weight||1)}else{var vx=a1,vy=a2,weight=a3;this.addStay(vx,ClStrength.weak,weight||1),this.addStay(vy,ClStrength.weak,weight||1)}return this},addStay:function(v,strength,weight){var cn=new ClStayConstraint(v,strength||ClStrength.weak,weight||1);return this.addConstraint(cn)},removeConstraint:function(cn){return this.removeConstraintInternal(cn),cn.removedFrom(this),this},removeConstraintInternal:function(cn){var that=this;CL.fTraceOn&&CL.fnenterprint("removeConstraint: "+cn),CL.fTraceOn&&CL.traceprint(this.toString()),this._fNeedsSolving=!0,this.resetStayConstants();var zRow=this.rowExpression(this._objective),eVars=this._errorVars.get(cn);CL.fTraceOn&&CL.traceprint("eVars == "+CL.setToString(eVars)),null!=eVars&&eVars.each(function(clv){var expr=that.rowExpression(clv);null==expr?zRow.addVariable(clv,-cn.weight()*cn.strength().symbolicWeight().toDouble(),that._objective,that):zRow.addExpression(expr,-cn.weight()*cn.strength().symbolicWeight().toDouble(),that._objective,that),CL.fTraceOn&&CL.traceprint("now eVars == "+CL.setToString(eVars))});var marker=this._markerVars.remove(cn);if(null==marker)throw new ExCLConstraintNotFound;if(CL.fTraceOn&&CL.traceprint("Looking to remove var "+marker),null==this.rowExpression(marker)){var col=this._columns.get(marker);CL.fTraceOn&&CL.traceprint("Must pivot -- columns are "+col);var exitVar=null,minRatio=0;col.each(function(v){if(v.isRestricted()){var expr=that.rowExpression(v),coeff=expr.coefficientFor(marker);if(that.fTraceOn&&that.traceprint("Marker "+marker+"'s coefficient in "+expr+" is "+coeff),0>coeff){var r=-expr.constant()/coeff;(null==exitVar||minRatio>r||CL.approx(r,minRatio)&&v.hashCode()<exitVar.hashCode())&&(minRatio=r,exitVar=v)}}}),null==exitVar&&(CL.fTraceOn&&CL.traceprint("exitVar is still null"),col.each(function(v){if(v.isRestricted()){var expr=that.rowExpression(v),coeff=expr.coefficientFor(marker),r=expr.constant()/coeff;(null==exitVar||minRatio>r)&&(minRatio=r,exitVar=v)}})),null==exitVar&&(0==col.size()?this.removeColumn(marker):col.escapingEach(function(v){return v!=that._objective?(exitVar=v,{brk:!0}):void 0})),null!=exitVar&&this.pivot(marker,exitVar)}if(null!=this.rowExpression(marker)){var expr=this.removeRow(marker);expr=null}if(null!=eVars&&eVars.each(function(v){v!=marker&&(that.removeColumn(v),v=null)}),cn.isStayConstraint()){if(null!=eVars)for(var i=0;i<this._stayPlusErrorVars.length;i++)eVars.remove(this._stayPlusErrorVars[i]),eVars.remove(this._stayMinusErrorVars[i])}else if(cn.isEditConstraint()){CL.Assert(null!=eVars,"eVars != null");var cnEdit=cn,clv=cnEdit.variable(),cei=this._editVarMap.get(clv),clvEditMinus=cei.ClvEditMinus();this.removeColumn(clvEditMinus),this._editVarMap.remove(clv)}return null!=eVars&&this._errorVars.remove(eVars),marker=null,this._fOptimizeAutomatically&&(this.optimize(this._objective),this.setExternalVariables()),this},reset:function(){throw CL.fTraceOn&&CL.fnenterprint("reset"),new ExCLInternalError("reset not implemented")},resolveArray:function(newEditConstants){CL.fTraceOn&&CL.fnenterprint("resolveArray"+newEditConstants);var that=this;this._editVarMap.each(function(v,cei){var i=cei.Index();i<newEditConstants.length&&that.suggestValue(v,newEditConstants[i])}),this.resolve()},resolvePair:function(x,y){this._resolve_pair[0]=x,this._resolve_pair[1]=y,this.resolveArray(this._resolve_pair)},resolve:function(){CL.fTraceOn&&CL.fnenterprint("resolve()"),this.dualOptimize(),this.setExternalVariables(),this._infeasibleRows.clear(),this.resetStayConstants()},suggestValue:function(v,x){CL.fTraceOn&&CL.fnenterprint("suggestValue("+v+", "+x+")");var cei=this._editVarMap.get(v);if(null==cei)throw print("suggestValue for variable "+v+", but var is not an edit variable\n"),new ExCLError;cei.Index();var clvEditPlus=cei.ClvEditPlus(),clvEditMinus=cei.ClvEditMinus(),delta=x-cei.PrevEditConstant();return cei.SetPrevEditConstant(x),this.deltaEditConstant(delta,clvEditPlus,clvEditMinus),this},setAutosolve:function(f){return this._fOptimizeAutomatically=f,this},FIsAutosolving:function(){return this._fOptimizeAutomatically},solve:function(){return this._fNeedsSolving&&(this.optimize(this._objective),this.setExternalVariables()),this},setEditedValue:function(v,n){if(!this.FContainsVariable(v))return v.change_value(n),this;if(!CL.approx(n,v.value())){this.addEditVar(v),this.beginEdit();try{this.suggestValue(v,n)}catch(e){throw new ExCLInternalError("Error in setEditedValue")}this.endEdit()}return this},FContainsVariable:function(v){return this.columnsHasKey(v)||null!=this.rowExpression(v)},addVar:function(v){if(!this.FContainsVariable(v)){try{this.addStay(v)}catch(e){throw new ExCLInternalError("Error in addVar -- required failure is impossible")}CL.fTraceOn&&CL.traceprint("added initial stay on "+v)}return this},getInternalInfo:function($super){var retstr=$super();return retstr+="\nSolver info:\n",retstr+="Stay Error Variables: ",retstr+=this._stayPlusErrorVars.length+this._stayMinusErrorVars.length,retstr+=" ("+this._stayPlusErrorVars.length+" +, ",retstr+=this._stayMinusErrorVars.length+" -)\n",retstr+="Edit Variables: "+this._editVarMap.size(),retstr+="\n"},getDebugInfo:function(){var bstr=this.toString();return bstr+=this.getInternalInfo(),bstr+="\n"},toString:function($super){var bstr=$super();return bstr+="\n_stayPlusErrorVars: ",bstr+="["+this._stayPlusErrorVars+"]",bstr+="\n_stayMinusErrorVars: ",bstr+="["+this._stayMinusErrorVars+"]",bstr+="\n",bstr+="_editVarMap:\n"+CL.hashToString(this._editVarMap),bstr+="\n"},getConstraintMap:function(){return this._markerVars},addWithArtificialVariable:function(expr){CL.fTraceOn&&CL.fnenterprint("addWithArtificialVariable: "+expr);var av=new ClSlackVariable(++this._artificialCounter,"a"),az=new ClObjectiveVariable("az"),azRow=expr.clone();CL.fTraceOn&&CL.traceprint("before addRows:\n"+this),this.addRow(az,azRow),this.addRow(av,expr),CL.fTraceOn&&CL.traceprint("after addRows:\n"+this),this.optimize(az);var azTableauRow=this.rowExpression(az);if(CL.fTraceOn&&CL.traceprint("azTableauRow.constant() == "+azTableauRow.constant()),!CL.approx(azTableauRow.constant(),0))throw this.removeRow(az),this.removeColumn(av),new ExCLRequiredFailure;var e=this.rowExpression(av);if(null!=e){if(e.isConstant())return this.removeRow(av),this.removeRow(az),void 0;var entryVar=e.anyPivotableVariable();this.pivot(entryVar,av)}CL.Assert(null==this.rowExpression(av),"rowExpression(av) == null"),this.removeColumn(av),this.removeRow(az)},tryAddingDirectly:function(expr){CL.fTraceOn&&CL.fnenterprint("tryAddingDirectly: "+expr);var subject=this.chooseSubject(expr);return null==subject?(CL.fTraceOn&&CL.fnexitprint("returning false"),!1):(expr.newSubject(subject),this.columnsHasKey(subject)&&this.substituteOut(subject,expr),this.addRow(subject,expr),CL.fTraceOn&&CL.fnexitprint("returning true"),!0)},chooseSubject:function(expr){var that=this;CL.fTraceOn&&CL.fnenterprint("chooseSubject: "+expr);var subject=null,foundUnrestricted=!1,foundNewRestricted=!1,terms=expr.terms(),rv=terms.escapingEach(function(v,c){if(foundUnrestricted){if(!v.isRestricted()&&!that.columnsHasKey(v))return{retval:v}}else if(v.isRestricted()){if(!foundNewRestricted&&!v.isDummy()&&0>c){var col=that._columns.get(v);(null==col||1==col.size()&&that.columnsHasKey(that._objective))&&(subject=v,foundNewRestricted=!0)}}else subject=v,foundUnrestricted=!0});if(void 0!==rv)return rv;if(null!=subject)return subject;var coeff=0,rv=terms.escapingEach(function(v,c){return v.isDummy()?(that.columnsHasKey(v)||(subject=v,coeff=c),void 0):{retval:null}});if(void 0!==rv)return rv;if(!CL.approx(expr.constant(),0))throw new ExCLRequiredFailure;return coeff>0&&expr.multiplyMe(-1),subject},deltaEditConstant:function(delta,plusErrorVar,minusErrorVar){var that=this;CL.fTraceOn&&CL.fnenterprint("deltaEditConstant :"+delta+", "+plusErrorVar+", "+minusErrorVar);var exprPlus=this.rowExpression(plusErrorVar);if(null!=exprPlus)return exprPlus.incrementConstant(delta),exprPlus.constant()<0&&this._infeasibleRows.add(plusErrorVar),void 0;var exprMinus=this.rowExpression(minusErrorVar);if(null!=exprMinus)return exprMinus.incrementConstant(-delta),exprMinus.constant()<0&&this._infeasibleRows.add(minusErrorVar),void 0;var columnVars=this._columns.get(minusErrorVar);columnVars||print("columnVars is null -- tableau is:\n"+this),columnVars.each(function(basicVar){var expr=that.rowExpression(basicVar),c=expr.coefficientFor(minusErrorVar);expr.incrementConstant(c*delta),basicVar.isRestricted()&&expr.constant()<0&&that._infeasibleRows.add(basicVar)})},dualOptimize:function(){CL.fTraceOn&&CL.fnenterprint("dualOptimize:");for(var zRow=this.rowExpression(this._objective);!this._infeasibleRows.isEmpty();){var exitVar=this._infeasibleRows.values()[0];this._infeasibleRows.remove(exitVar);var entryVar=null,expr=this.rowExpression(exitVar);if(null!=expr&&expr.constant()<0){var r,ratio=Number.MAX_VALUE,terms=expr.terms();if(terms.each(function(v,c){if(c>0&&v.isPivotable()){var zc=zRow.coefficientFor(v);r=zc/c,(ratio>r||CL.approx(r,ratio)&&v.hashCode()<entryVar.hashCode())&&(entryVar=v,ratio=r)}}),ratio==Number.MAX_VALUE)throw new ExCLInternalError("ratio == nil (MAX_VALUE) in dualOptimize");this.pivot(entryVar,exitVar)}}},newExpression:function(cn,eplus_eminus,prevEConstant){var that=this;CL.fTraceOn&&CL.fnenterprint("newExpression: "+cn),CL.fTraceOn&&CL.traceprint("cn.isInequality() == "+cn.isInequality()),CL.fTraceOn&&CL.traceprint("cn.isRequired() == "+cn.isRequired());var cnExpr=cn.expression(),expr=new ClLinearExpression(cnExpr.constant()),slackVar=new ClSlackVariable,dummyVar=new ClDummyVariable,eminus=new ClSlackVariable,eplus=new ClSlackVariable,cnTerms=cnExpr.terms();if(cnTerms.each(function(v,c){var e=that.rowExpression(v);null==e?expr.addVariable(v,c):expr.addExpression(e,c)}),cn.isInequality()){if(++this._slackCounter,slackVar=new ClSlackVariable(this._slackCounter,"s"),expr.setVariable(slackVar,-1),this._markerVars.put(cn,slackVar),!cn.isRequired()){++this._slackCounter,eminus=new ClSlackVariable(this._slackCounter,"em"),expr.setVariable(eminus,1);var zRow=this.rowExpression(this._objective),sw=cn.strength().symbolicWeight().times(cn.weight());zRow.setVariable(eminus,sw.toDouble()),this.insertErrorVar(cn,eminus),this.noteAddedVariable(eminus,this._objective)}}else if(cn.isRequired())++this._dummyCounter,dummyVar=new ClDummyVariable(this._dummyCounter,"d"),expr.setVariable(dummyVar,1),this._markerVars.put(cn,dummyVar),CL.fTraceOn&&CL.traceprint("Adding dummyVar == d"+this._dummyCounter);else{++this._slackCounter,eplus=new ClSlackVariable(this._slackCounter,"ep"),eminus=new ClSlackVariable(this._slackCounter,"em"),expr.setVariable(eplus,-1),expr.setVariable(eminus,1),this._markerVars.put(cn,eplus);var zRow=this.rowExpression(this._objective),sw=cn.strength().symbolicWeight().times(cn.weight()),swCoeff=sw.toDouble();0==swCoeff&&(CL.fTraceOn&&CL.traceprint("sw == "+sw),CL.fTraceOn&&CL.traceprint("cn == "+cn),CL.fTraceOn&&CL.traceprint("adding "+eplus+" and "+eminus+" with swCoeff == "+swCoeff)),zRow.setVariable(eplus,swCoeff),this.noteAddedVariable(eplus,this._objective),zRow.setVariable(eminus,swCoeff),this.noteAddedVariable(eminus,this._objective),this.insertErrorVar(cn,eminus),this.insertErrorVar(cn,eplus),cn.isStayConstraint()?(this._stayPlusErrorVars.push(eplus),this._stayMinusErrorVars.push(eminus)):cn.isEditConstraint()&&(eplus_eminus[0]=eplus,eplus_eminus[1]=eminus,prevEConstant[0]=cnExpr.constant())}return expr.constant()<0&&expr.multiplyMe(-1),CL.fTraceOn&&CL.fnexitprint("returning "+expr),expr},optimize:function(zVar){var that=this;CL.fTraceOn&&CL.fnenterprint("optimize: "+zVar),CL.fTraceOn&&CL.traceprint(this.toString());var zRow=this.rowExpression(zVar);CL.Assert(null!=zRow,"zRow != null");for(var entryVar=null,exitVar=null;;){var objectiveCoeff=0,terms=zRow.terms();if(terms.escapingEach(function(v,c){return v.isPivotable()&&objectiveCoeff>c?(objectiveCoeff=c,entryVar=v,{brk:!0}):void 0}),objectiveCoeff>=-this._epsilon)return;CL.fTraceOn&&CL.traceprint("entryVar == "+entryVar+", objectiveCoeff == "+objectiveCoeff);var minRatio=Number.MAX_VALUE,columnVars=this._columns.get(entryVar),r=0;if(columnVars.each(function(v){if(that.fTraceOn&&that.traceprint("Checking "+v),v.isPivotable()){var expr=that.rowExpression(v),coeff=expr.coefficientFor(entryVar);that.fTraceOn&&that.traceprint("pivotable, coeff = "+coeff),0>coeff&&(r=-expr.constant()/coeff,(minRatio>r||CL.approx(r,minRatio)&&v.hashCode()<exitVar.hashCode())&&(minRatio=r,exitVar=v))}}),minRatio==Number.MAX_VALUE)throw new ExCLInternalError("Objective function is unbounded in optimize");this.pivot(entryVar,exitVar),CL.fTraceOn&&CL.traceprint(this.toString())}},pivot:function(entryVar,exitVar){CL.fTraceOn&&CL.fnenterprint("pivot: "+entryVar+", "+exitVar),null==entryVar&&console.log("pivot: entryVar == null"),null==exitVar&&console.log("pivot: exitVar == null");var pexpr=this.removeRow(exitVar);pexpr.changeSubject(exitVar,entryVar),this.substituteOut(entryVar,pexpr),this.addRow(entryVar,pexpr)},resetStayConstants:function(){CL.fTraceOn&&CL.fnenterprint("resetStayConstants");for(var i=0;i<this._stayPlusErrorVars.length;i++){var expr=this.rowExpression(this._stayPlusErrorVars[i]);null==expr&&(expr=this.rowExpression(this._stayMinusErrorVars[i])),null!=expr&&expr.set_constant(0)}},setExternalVariables:function(){var that=this;CL.fTraceOn&&CL.fnenterprint("setExternalVariables:"),CL.fTraceOn&&CL.traceprint(this.toString()),this._externalParametricVars.each(function(v){null!=that.rowExpression(v)?print("Error: variable"+v+" in _externalParametricVars is basic"):v.change_value(0)}),this._externalRows.each(function(v){var expr=that.rowExpression(v);CL.fTraceOn&&CL.debugprint("v == "+v),CL.fTraceOn&&CL.debugprint("expr == "+expr),v.change_value(expr.constant())}),this._fNeedsSolving=!1},insertErrorVar:function(cn,aVar){CL.fTraceOn&&CL.fnenterprint("insertErrorVar:"+cn+", "+aVar);var cnset=this._errorVars.get(aVar);null==cnset&&this._errorVars.put(cn,cnset=new HashSet),cnset.add(aVar)}}),CL={debugprint:function(s){CL.fVerboseTraceOn&&print(s)},traceprint:function(s){CL.fVerboseTraceOn&&print(s)},fnenterprint:function(s){print("* "+s)},fnexitprint:function(s){print("- "+s)},Assert:function(f,description){if(!f)throw new ExCLInternalError("Assertion failed:"+description)},Plus:function(e1,e2){return e1 instanceof ClLinearExpression||(e1=new ClLinearExpression(e1)),e2 instanceof ClLinearExpression||(e2=new ClLinearExpression(e2)),e1.plus(e2)},Minus:function(e1,e2){return e1 instanceof ClLinearExpression||(e1=new ClLinearExpression(e1)),e2 instanceof ClLinearExpression||(e2=new ClLinearExpression(e2)),e1.minus(e2)},Times:function(e1,e2){return e1 instanceof ClLinearExpression&&e2 instanceof ClLinearExpression?e1.times(e2):e1 instanceof ClLinearExpression&&e2 instanceof ClVariable?e1.times(new ClLinearExpression(e2)):e1 instanceof ClVariable&&e2 instanceof ClLinearExpression?new ClLinearExpression(e1).times(e2):e1 instanceof ClLinearExpression&&"number"==typeof e2?e1.times(new ClLinearExpression(e2)):"number"==typeof e1&&e2 instanceof ClLinearExpression?new ClLinearExpression(e1).times(e2):"number"==typeof e1&&e2 instanceof ClVariable?new ClLinearExpression(e2,e1):e1 instanceof ClVariable&&"number"==typeof e2?new ClLinearExpression(e1,e2):e1 instanceof ClVariable&&e2 instanceof ClLinearExpression?new ClLinearExpression(e2,n):void 0},Divide:function(e1,e2){return e1.divide(e2)},approx:function(a,b){return a instanceof ClVariable&&(a=a.value()),b instanceof ClVariable&&(b=b.value()),epsilon=1e-8,0==a?Math.abs(b)<epsilon:0==b?Math.abs(a)<epsilon:Math.abs(a-b)<Math.abs(a)*epsilon},hashToString:function(h){var answer="";return CL.Assert(h instanceof Hashtable),h.each(function(k,v){answer+=k+" => ",answer+=v instanceof Hashtable?CL.hashToString(v):v instanceof HashSet?CL.setToString(v):v+"\n"}),answer},setToString:function(s){CL.Assert(s instanceof HashSet);var answer=s.size()+" {",first=!0;return s.each(function(e){first?first=!1:answer+=", ",answer+=e}),answer+="}\n"}},CL.fDebugOn=!1,CL.fVerboseTraceOn=!1,CL.fTraceOn=!1,CL.fTraceAdded=!1,CL.fGC=!1,CL.GEQ=1,CL.LEQ=2,Object.subclass("Timer","default category",{initialize:function(){this._timerIsRunning=!1,this._elapsedMs=0},Start:function(){this._timerIsRunning=!0,this._startReading=new Date},Stop:function(){this._timerIsRunning=!1,this._elapsedMs+=new Date-this._startReading},Reset:function(){this._timerIsRunning=!1,this._elapsedMs=0},IsRunning:function(){return this._timerIsRunning},ElapsedTime:function(){return this._timerIsRunning?(this._elapsedMs+(new Date-this._startReading))/1e3:this._elapsedMs/1e3}})}),module("users.timfelgentreff.babelsberg.cassowary_ext").requires("users.timfelgentreff.cassowary.DwarfCassowary").toRun(function(){Function.addMethods({shouldBeTrue:function(priority,ctx){return ctx||(ctx=priority,priority=void 0),ClSimplexSolver.getInstance().always({priority:priority,ctx:ctx},this)}}),ClSimplexSolver.addMethods({isConstraintObject:function(){return!0},constraintVariableFor:function(value){if("number"==typeof value||null===value||value instanceof Number){var v=new ClVariable(value+0);return v.solver=this,v.stay(),v}return null},get strength(){return ClStrength},weight:1e3,always:function(opts,func){var ctx=opts.ctx,priority=this.strength[opts.priority];func.varMapping=ctx;var constraint=new Constraint(func,this);return constraint.priority=priority,constraint.enable(),constraint}}),Object.extend(ClSimplexSolver,{getInstance:function(){return this.$$instance||(this.$$instance=new ClSimplexSolver,this.$$instance.setAutosolve(!1)),this.$$instance},resetInstance:function(){this.$$instance=void 0}}),ClAbstractVariable.addMethods({isConstraintObject:function(){return!0},stay:function(strength){var cn=new ClStayConstraint(this,strength||ClStrength.weak,1);return this.solver.addConstraint(cn),this.stayConstraint=cn,cn},removeStay:function(){if(this.stayConstraint)try{this.solver.removeConstraint(this.stayConstraint)}catch(_){this.stayConstraint=null}},suggestValue:function(value){var c=this.cnEquals(value),s=this.solver;s.addConstraint(c);try{s.solve()}finally{s.removeConstraint(c)}},setReadonly:function(bool){if(bool&&!this.readonlyConstraint){var cn=new ClStayConstraint(this,ClStrength.required,1);return this.solver.addConstraint(cn),this.readonlyConstraint=cn,cn}!bool&&this.readonlyConstraint&&(this.solver.removeConstraint(this.readonlyConstraint),this.readonlyConstraint=void 0)},isReadonly:function(){return!!this.readonlyConstraint},plus:function(value){return new ClLinearExpression(this).plus(value)},minus:function(value){return new ClLinearExpression(this).minus(value)},times:function(value){return new ClLinearExpression(this).times(value)},divide:function(value){return new ClLinearExpression(this).divide(value)},cnGeq:function(value){return new ClLinearExpression(this).cnGeq(value)},cnLeq:function(value){return new ClLinearExpression(this).cnLeq(value)},cnOr:function(){return this},cnEquals:function(value){return new ClLinearExpression(this).cnEquals(value)},cnIdentical:function(value){return this.cnEquals(value)},prepareEdit:function(){this.solver.addEditVar(this)},finishEdit:function(){}}),ClLinearExpression.addMethods({isConstraintObject:function(){return!0},cnGeq:function(value){return"string"==typeof value&&(value=parseFloat(value)),new ClLinearInequality(this.minus(value))},cnLeq:function(value){return"string"==typeof value&&(value=parseFloat(value)),value instanceof ClLinearExpression||(value=new ClLinearExpression(value)),!value.minus,new ClLinearInequality(value.minus(this))},cnOr:function(){return this},cnEquals:function(value){return"string"==typeof value&&(value=parseFloat(value)),new ClLinearEquation(this,value)},plus:function(expr){if("string"==typeof expr&&(expr=parseFloat(expr)),expr instanceof ClLinearExpression)return this.clone().addExpression(expr,1);if(expr instanceof ClVariable)return this.clone().addVariable(expr,1);if("number"==typeof expr)return this.clone().addExpression(new ClLinearExpression(expr),1);throw"Not supported: plus with "+expr},times:function(x){if("string"==typeof x&&(x=parseFloat(x)),"number"==typeof x)return this.clone().multiplyMe(x);if(this.isConstant())return x.times(this._constant);if(x.isConstant())return this.times(x._constant);throw new ExCLNonlinearExpression},minus:function(expr){if("string"==typeof expr&&(expr=parseFloat(expr)),expr instanceof ClLinearExpression)return this.clone().addExpression(expr,-1);if(expr instanceof ClVariable)return this.clone().addVariable(expr,-1);if("number"==typeof expr)return this.clone().addExpression(new ClLinearExpression(expr),-1);throw"Not supported: minus with "+expr},divide:function(x){if("string"==typeof x&&(x=parseFloat(x)),"number"==typeof x){if(CL.approx(x,0))throw new ExCLNonlinearExpression;return this.times(1/x)}if(x instanceof ClLinearExpression){if(!x.isConstant)throw new ExCLNonlinearExpression;return this.times(1/x._constant)}throw"Not supported: divide with "+expr}}),ClConstraint.addMethods({isConstraintObject:function(){return!0},enable:function(strength){strength&&this.setStrength(strength),this.solver.addConstraint(this)},disable:function(){this.solver.removeConstraint(this)},cnOr:function(){return this},get solver(){return this._solver||ClSimplexSolver.getInstance()},set solver(value){this._solver=value}})}),module("users.timfelgentreff.deltablue.deltablue").requires().toRun(function(){Object.subclass("DBOrderedCollection",{initialize:function(){this.elms=new Array},add:function(elm){this.elms.push(elm)},at:function(index){return this.elms[index]},size:function(){return this.elms.length},removeFirst:function(){return this.elms.pop()},remove:function(elm){for(var index=0,skipped=0,i=0;i<this.elms.length;i++){var value=this.elms[i];value!=elm?(this.elms[index]=value,index++):skipped++}for(var i=0;skipped>i;i++)this.elms.pop()}}),Object.subclass("DBStrength",{initialize:function(strengthValue,name){this.strengthValue=strengthValue,this.name=name
},nextWeaker:function(){switch(this.strengthValue){case 0:return DBStrength.WEAKEST;case 1:return DBStrength.WEAK_DEFAULT;case 2:return DBStrength.NORMAL;case 3:return DBStrength.STRONG_DEFAULT;case 4:return DBStrength.PREFERRED;case 5:return DBStrength.REQUIRED}}}),Object.extend(DBStrength,{stronger:function(s1,s2){return s1.strengthValue<s2.strengthValue},weaker:function(s1,s2){return s1.strengthValue>s2.strengthValue},weakestOf:function(s1,s2){return this.weaker(s1,s2)?s1:s2},strongest:function(s1,s2){return this.stronger(s1,s2)?s1:s2},REQUIRED:new DBStrength(0,"required"),STONG_PREFERRED:new DBStrength(1,"strongPreferred"),PREFERRED:new DBStrength(2,"preferred"),STRONG_DEFAULT:new DBStrength(3,"strongDefault"),NORMAL:new DBStrength(4,"normal"),WEAK_DEFAULT:new DBStrength(5,"weakDefault"),WEAKEST:new DBStrength(6,"weakest")}),Object.subclass("DBConstraint",{initialize:function(strength,planner){this.planner=planner,this.strength=strength},addDBConstraint:function(){this.addToGraph(),this.planner.incrementalAdd(this)},satisfy:function(mark){if(this.chooseMethod(mark),!this.isSatisfied())return this.strength==DBStrength.REQUIRED&&alert("Could not satisfy a required constraint!"),null;this.markInputs(mark);var out=this.output(),overridden=out.determinedBy;return null!=overridden&&overridden.markUnsatisfied(),out.determinedBy=this,this.planner.addPropagate(this,mark)||alert("Cycle encountered"),out.mark=mark,overridden},destroyDBConstraint:function(){this.isSatisfied()?this.planner.incrementalRemove(this):this.removeFromGraph()},isInput:function(){return!1}}),DBConstraint.subclass("UnaryDBConstraint",{initialize:function($super,v,strength,planner){$super(strength,planner),this.myOutput=v,this.satisfied=!1},addToGraph:function(){this.myOutput.addDBConstraint(this),this.satisfied=!1},chooseMethod:function(mark){this.satisfied=this.myOutput.mark!=mark&&DBStrength.stronger(this.strength,this.myOutput.walkDBStrength)},isSatisfied:function(){return this.satisfied},markInputs:function(){},output:function(){return this.myOutput},recalculate:function(){this.myOutput.walkDBStrength=this.strength,this.myOutput.stay=!this.isInput(),this.myOutput.stay&&this.execute()},markUnsatisfied:function(){this.satisfied=!1},inputsKnown:function(){return!0},removeFromGraph:function(){null!=this.myOutput&&this.myOutput.removeDBConstraint(this),this.satisfied=!1}}),UnaryDBConstraint.subclass("StayDBConstraint",{execute:function(){}}),UnaryDBConstraint.subclass("EditDBConstraint",{isInput:function(){return!0},execute:function(){}});var Direction=new Object;Direction.NONE=0,Direction.FORWARD=1,Direction.BACKWARD=-1,DBConstraint.subclass("BinaryDBConstraint",{initialize:function($super,var1,var2,strength,planner){$super(strength,planner),this.v1=var1,this.v2=var2,this.direction=Direction.NONE},chooseMethod:function(mark){this.v1.mark==mark&&(this.direction=this.v2.mark!=mark&&DBStrength.stronger(this.strength,this.v2.walkDBStrength)?Direction.FORWARD:Direction.NONE),this.v2.mark==mark&&(this.direction=this.v1.mark!=mark&&DBStrength.stronger(this.strength,this.v1.walkDBStrength)?Direction.BACKWARD:Direction.NONE),this.direction=DBStrength.weaker(this.v1.walkDBStrength,this.v2.walkDBStrength)?DBStrength.stronger(this.strength,this.v1.walkDBStrength)?Direction.BACKWARD:Direction.NONE:DBStrength.stronger(this.strength,this.v2.walkDBStrength)?Direction.FORWARD:Direction.BACKWARD},addToGraph:function(){this.v1.addDBConstraint(this),this.v2.addDBConstraint(this),this.direction=Direction.NONE},isSatisfied:function(){return this.direction!=Direction.NONE},markInputs:function(mark){this.input().mark=mark},input:function(){return this.direction==Direction.FORWARD?this.v1:this.v2},output:function(){return this.direction==Direction.FORWARD?this.v2:this.v1},recalculate:function(){var ihn=this.input(),out=this.output();out.walkDBStrength=DBStrength.weakestOf(this.strength,ihn.walkDBStrength),out.stay=ihn.stay,out.stay&&this.execute()},markUnsatisfied:function(){this.direction=Direction.NONE},inputsKnown:function(mark){var i=this.input();return i.mark==mark||i.stay||null==i.determinedBy},removeFromGraph:function(){null!=this.v1&&this.v1.removeDBConstraint(this),null!=this.v2&&this.v2.removeDBConstraint(this),this.direction=Direction.NONE}}),DBConstraint.subclass("UserDBConstraint",{initialize:function($super,strengthOrPredicateOrFormulas,predicateOrFormulasOrPlanner,formulasOrPlanner,planner){var strength,formulas,predicate;planner?(strength=strengthOrPredicateOrFormulas,predicate=predicateOrFormulasOrPlanner,formulas=formulasOrPlanner):formulasOrPlanner?"function"==typeof formulasOrPlanner?(strength=strengthOrPredicateOrFormulas,predicate=predicateOrFormulasOrPlanner,formulas=formulasOrPlanner):(planner=formulasOrPlanner,"function"==typeof strengthOrPredicateOrFormulas?(predicate=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner):(strength=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner)):predicateOrFormulasOrPlanner?"function"==typeof strengthOrPredicateOrFormulas?"function"==typeof predicateOrFormulasOrPlanner?(predicate=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner):(formulas=strengthOrPredicateOrFormulas,planner=predicateOrFormulasOrPlanner):(strength=strengthOrPredicateOrFormulas,formulas=predicateOrFormulasOrPlanner):formulas=strengthOrPredicateOrFormulas,strength=strength||DBStrength.required,$super(strength,planner),this.predicate=predicate,this.formulas=[],this.outputs=[],this.inputs=[],this.satisfied=!1,formulas(this)},formula:function(output,inputs,func){if(inputs.include(output))throw"output cannot be determined by itself";var idx=this.outputs.indexOf(output),len=this.outputs.length;if(idx>=0)throw"multiple formulas for "+output;this.outputs.push(output),inputs.each(function(input){this.inputs.include(input)||this.inputs.push(input)}.bind(this)),this.formulas[len]={inputs:inputs,func:func}},chooseMethod:function(mark){var weakest_output=null,weakest_strength=this.strength;this.outputs.each(function(out){out.mark!=mark&&DBStrength.stronger(weakest_strength,out.walkDBStrength)&&(weakest_strength=out.walkDBStrength,weakest_output=out)}.bind(this)),this.out=weakest_output,this.satisfied=!!this.out},addToGraph:function(){var that=this;this.variables.each(function(ea){ea.addDBConstraint(that)}),this.satisfied=!1},isSatisfied:function(){return this.satisfied},markInputs:function(mark){var out=this.out;this.inputs.each(function(ea){ea!==out&&(ea.mark=mark)})},recalculate:function(){var out=this.out;out.walkDBStrength=this.strength,this.inputs.each(function(ea){out.walkDBStrength=DBStrength.weakestOf(out.walkDBStrength,ea.walkDBStrength)}),out.stay=this.inputs.all(function(ea){return ea.stay}),out.stay&&this.execute()},markUnsatisfied:function(){this.satisfied=!1},inputsKnown:function(mark){var out=this.out;return this.inputs.all(function(i){return i===out||i.mark==mark||i.stay||null==i.determinedBy})},removeFromGraph:function(){var that=this;this.variables.each(function(ea){ea.removeDBConstraint(that)}),this.satisfied=!1},execute:function(){if(!this.predicate||!this.predicate()){var formula=this.formulas[this.outputs.indexOf(this.out)],func=formula.func,inputs=formula.inputs;this.out.value=func.apply(null,inputs.collect(function(ea){return ea.value}).concat([this.out.value]))}},output:function(){return this.out},get variables(){return this.outputs.concat(this.inputs).uniq()}}),BinaryDBConstraint.subclass("ScaleDBConstraint",{initialize:function($super,src,scale,offset,dest,strength,planner){this.direction=Direction.NONE,this.scale=scale,this.offset=offset,$super(src,dest,strength,planner)},addToGraph:function($super){$super(),this.scale.addDBConstraint(this),this.offset.addDBConstraint(this)},removeFromGraph:function($super){$super(),null!=this.scale&&this.scale.removeDBConstraint(this),null!=this.offset&&this.offset.removeDBConstraint(this)},markInputs:function($super,mark){$super(mark),this.scale.mark=this.offset.mark=mark},execute:function(){this.direction==Direction.FORWARD?this.v2.value=this.v1.value*this.scale.value+this.offset.value:this.v1.value=(this.v2.value-this.offset.value)/this.scale.value},recalculate:function(){var ihn=this.input(),out=this.output();out.walkDBStrength=DBStrength.weakestOf(this.strength,ihn.walkDBStrength),out.stay=ihn.stay&&this.scale.stay&&this.offset.stay,out.stay&&this.execute()}}),BinaryDBConstraint.subclass("EqualityDBConstraint",{execute:function(){this.output().value=this.input().value}}),Object.subclass("DBVariable",{initialize:function(name,initialValue,planner){this.planner=planner,this.value=initialValue,this.constraints=new DBOrderedCollection,this.determinedBy=null,this.mark=0,this.walkDBStrength=DBStrength.WEAKEST,this.stay=!0,this.name=name},addDBConstraint:function(c){this.constraints.add(c)},removeDBConstraint:function(c){this.constraints.remove(c),this.determinedBy==c&&(this.determinedBy=null)},assignValue:function(newValue){var edit=new EditDBConstraint(this,DBStrength.REQUIRED,this.planner),edits=new DBOrderedCollection;edit.addDBConstraint(),edits.add(edit);var plan=this.planner.extractDBPlanFromDBConstraints(edits);this.value=newValue;try{plan.execute()}finally{edit.destroyDBConstraint()}}}),Object.subclass("DBPlanner",{initialize:function(){this.currentMark=0},incrementalAdd:function(c){for(var mark=this.newMark(),overridden=c.satisfy(mark);null!=overridden;)overridden=overridden.satisfy(mark)},incrementalRemove:function(c){var out=c.output();c.markUnsatisfied(),c.removeFromGraph();var unsatisfied=this.removePropagateFrom(out),strength=DBStrength.REQUIRED;do{for(var i=0;i<unsatisfied.size();i++){var u=unsatisfied.at(i);u.strength==strength&&this.incrementalAdd(u)}strength=strength.nextWeaker()}while(strength!=DBStrength.WEAKEST)},newMark:function(){return++this.currentMark},makeDBPlan:function(sources){for(var mark=this.newMark(),plan=new DBPlan,todo=sources;todo.size()>0;){var c=todo.removeFirst();c.output().mark!=mark&&c.inputsKnown(mark)&&(plan.addDBConstraint(c),c.output().mark=mark,this.addDBConstraintsConsumingTo(c.output(),todo,c))}return plan},extractDBPlanFromDBConstraints:function(constraints){for(var sources=new DBOrderedCollection,i=0;i<constraints.size();i++){var c=constraints.at(i);c.isInput()&&c.isSatisfied()&&sources.add(c)}return this.makeDBPlan(sources)},addPropagate:function(c,mark){var todo=new DBOrderedCollection;for(todo.add(c);todo.size()>0;){var d=todo.removeFirst();if(d.output().mark==mark)return this.incrementalRemove(c),!1;d.recalculate(),this.addDBConstraintsConsumingTo(d.output(),todo)}return!0},removePropagateFrom:function(out){out.determinedBy=null,out.walkDBStrength=DBStrength.WEAKEST,out.stay=!0;var unsatisfied=new DBOrderedCollection,todo=new DBOrderedCollection;for(todo.add(out);todo.size()>0;){for(var v=todo.removeFirst(),i=0;i<v.constraints.size();i++){var c=v.constraints.at(i);c.isSatisfied()||unsatisfied.add(c)}for(var determining=v.determinedBy,i=0;i<v.constraints.size();i++){var next=v.constraints.at(i);next!=determining&&next.isSatisfied()&&(next.recalculate(),todo.add(next.output()))}}return unsatisfied},addDBConstraintsConsumingTo:function(v,coll,not){for(var determining=v.determinedBy,cc=v.constraints,i=0;i<cc.size();i++){var c=cc.at(i);c!=determining&&c.isSatisfied()&&c!=not&&coll.add(c)}}}),Object.subclass("DBPlan",{initialize:function(){this.v=new DBOrderedCollection},addDBConstraint:function(c){this.v.add(c)},size:function(){return this.v.size()},constraintAt:function(index){return this.v.at(index)},execute:function(){for(var i=0;i<this.size();i++){var c=this.constraintAt(i);c.execute()}}})}),module("users.timfelgentreff.babelsberg.deltablue_ext").requires("users.timfelgentreff.deltablue.deltablue").toRun(function(){Function.addMethods({shouldBeSatisfiedWith:function(priority,methods,ctx){return ctx||(ctx=methods,methods=priority,priority=DBStrength.required),DBPlanner.getInstance().always({priority:priority,methods:methods,ctx:ctx},this)}}),DBPlanner.addMethods({isConstraintObject:function(){return!0},constraintVariableFor:function(value,ivarname){return new DBVariable(ivarname,value,this)},get strength(){return DBStrength},always:function(opts,func){Object.isString(opts.priority)&&(opts.priority=this.strength[opts.priority]);var planner=this,ctx=opts.ctx,priority=opts.priority,methods=opts.methods;func.varMapping=ctx,methods||(methods=func,func=void 0),methods.varMapping=ctx;var cobj=new Constraint(methods,planner),formulas=cobj.constraintvariables.collect(function(v){var v=v.externalVariables(planner);return v?v.removeFormula():null}).compact();if(formulas.length>0){var constraint=new UserDBConstraint(priority,func,function(c){formulas.each(function(m){var inputs=m.inputs.select(function(input){return input instanceof DBVariable});dbgOn(inputs.length!==m.inputs.length),c.formula(m.output,inputs,m.func)})},planner);cobj.addPrimitiveConstraint(constraint)}return cobj.priority=priority,cobj.enable(),cobj},weight:100,addEditVar:function(v){this.currentEdits||(this.currentEdits=new DBOrderedCollection);var edit=new EditDBConstraint(v,DBStrength.REQUIRED,this);return this.currentEdits.add(edit),edit},solve:function(){},beginEdit:function(){if(this.currentEditPlan)throw"Trying to run nested edits - this isn't supported";if(!this.currentEdits)throw"No edit variables - cannot beginEdit";this.currentEditPlan=this.extractDBPlanFromDBConstraints(this.currentEdits)},endEdit:function(){this.currentEdits&&0!==this.currentEdits.length&&this.currentEdits.elms.each(function(edit){edit.destroyDBConstraint()}),this.currentEditPlan=null},resolveArray:function(newValues){if(!this.currentEdits)throw"resolveArray only valid in edit";this.currentEdits.elms.each(function(edit,idx){edit.myOutput.value=newValues[idx]}),this.currentEditPlan.execute()}}),Object.extend(DBPlanner,{getInstance:function(){return this.$$instance||(this.$$instance=new DBPlanner),this.$$instance},resetInstance:function(){this.$$instance=void 0}}),Object.extend(DBStrength,{required:DBStrength.REQUIRED,strong:DBStrength.STRONG_DEFAULT,medium:DBStrength.NORMAL,weak:DBStrength.WEAK_DEFAULT}),DBVariable.addMethods({isConstraintObject:function(){return!0},stay:function(strength){var cn=new StayDBConstraint(this,strength||DBStrength.WEAK_DEFAULT,this.planner);return cn.enable(),this._stayConstraint=cn,cn},setReadonly:function(bool){if(bool&&!this.readonlyConstraint){var cn=new StayDBConstraint(this,DBStrength.required,this.planner);return cn.enable(),this.readonlyConstraint=cn,cn}!bool&&this.readonlyConstraint&&(this.readonlyConstraint.disable(),this.readonlyConstraint=void 0)},isReadonly:function(){return!!this.readonlyConstraint},formula:function(inputs,func){if(!Constraint.current)throw"invalid outside constraint construction";if(this.__formula__)throw"two formulas for the same variable "+this;this.__formula__={output:this,inputs:inputs,func:func}},removeFormula:function(){var f=this.__formula__;return this.__formula__=void 0,f||(f=this.deriveFormula()),f},deriveFormula:function(){},removeStay:function(){if(this._stayConstraint)try{this.planner.removeConstraint(this._stayConstraint)}catch(_){this._stayConstraint=null}},suggestValue:function(value){this.assignValue(value)},prepareEdit:function(){this.editConstraint||(this.editConstraint=this.planner.addEditVar(this))},finishEdit:function(){this.editConstraint=null},cnIdentical:function(other){if(!(other instanceof DBVariable)){other=new DBVariable("___",other,this.planner);var stay=new StayDBConstraint(other,DBStrength.required,this.planner);stay.enable(DBStrength.required)}return new EqualityDBConstraint(this,other,DBStrength.required,Constraint.current.solver)},cnEquals:function(other){other instanceof DBVariable||(other=new DBVariable("constant/"+other,other,this.planner),Constraint.current.addPrimitiveConstraint(new StayDBConstraint(other,DBStrength.required,this.planner)));var self=this;return cloneFunc=function(fromObj){return fromObj.clone?fromObj.clone():fromObj.copy?fromObj.copy():fromObj},new UserDBConstraint(function(c){c.formula(self,[other],cloneFunc),c.formula(other,[self],cloneFunc)},Constraint.current.solver)},cnOr:function(other){return this.value?this:other},equals:function(argument){return this.cnEquals(argument)}}),DBConstraint.addMethods({isConstraintObject:function(){return!0},enable:function(priority){this.strength=priority||this.strength,this.addDBConstraint()},disable:function(){this.destroyDBConstraint()},cnOr:function(){return this}}),EqualityDBConstraint.addMethods({setExecuteFunction:function(func){var orig=this.execute.$originalFunction||this.execute;func.$originalFunction=orig,this.execute=func},unsetExecuteFunction:function(){this.execute=this.execute.$originalFunction||this.execute}})}),module("users.timfelgentreff.babelsberg.core_ext").requires().toRun(function(){Function.addMethods({varMap:function(obj){return this.varMapping=obj,this}})}),module("users.timfelgentreff.babelsberg.constraintinterpreter").requires("users.timfelgentreff.jsinterpreter.Interpreter","cop.Layers","users.timfelgentreff.babelsberg.cassowary_ext","users.timfelgentreff.babelsberg.deltablue_ext","users.timfelgentreff.babelsberg.core_ext","users.timfelgentreff.babelsberg.src_transform","users.timfelgentreff.babelsberg.babelsberg-lively").toRun(function(){Object.subclass("Babelsberg",{initialize:function(){this.defaultSolvers=[]},isConstraintObject:function(){return!0},unconstrain:function(obj,accessor){if(obj){var cvar=ConstrainedVariable.findConstraintVariableFor(obj,accessor);if(cvar){var cGetter=obj.__lookupGetter__(accessor),cSetter=obj.__lookupSetter__(accessor);if(cGetter||cSetter){if(!cGetter.isConstraintAccessor||!cSetter.isConstraintAccessor)throw"too many accessors - unconstrain only works for the very simple case now";ConstrainedVariable.deleteConstraintVariableFor(obj,accessor);var newName=cvar.newIvarname,existingSetter=obj.__lookupSetter__(newName),existingGetter=obj.__lookupGetter__(newName);existingGetter&&obj.__defineGetter__(this.accessor,existingGetter),existingSetter&&obj.__defineSetter__(this.accessor,existingSetter),existingSetter&&existingGetter||delete obj[accessor],obj[accessor]=obj[newName],delete obj[newName];var child=obj[accessor];child&&child instanceof Object&&Object.keys(child).each(function(property){var cvar=ConstrainedVariable.findConstraintVariableFor(child,property);if(cvar){var cGetter=child.__lookupGetter__(property),cSetter=child.__lookupSetter__(property);(cGetter||cSetter)&&cGetter.isConstraintAccessor&&cSetter.isConstraintAccessor&&bbb.unconstrain(child,property)}})}}}},edit:function(obj,accessors){var extVars={},cVars={},solvers=[],callback=function(newObj){if(newObj){var newEditConstants=newObj;Object.isArray(newObj)||(newEditConstants=accessors.map(function(accessor){return newObj[accessor]})),solvers.invoke("resolveArray",newEditConstants),accessors.each(function(a){cVars[a].suggestValue(cVars[a].externalValue)})}else{for(var prop in extVars)extVars[prop].each(function(evar){evar.finishEdit()});solvers.invoke("endEdit")}};return accessors.each(function(accessor){var cvar=ConstrainedVariable.findConstraintVariableFor(obj,accessor);if(!cvar)throw"Cannot edit "+obj+'["'+accessor+"\"], because it isn't constrained";var evars=Properties.values(cvar._externalVariables);if(evars.compact().length<evars.length)throw"Cannot edit "+obj+'["'+accessor+'"], because it is in a recalculate relation';if(cvar.solvers.any(function(s){return!Object.isFunction(s.beginEdit)}))throw"Cannot edit "+obj+'["'+accessor+'"], because it is in a no-edit solver';cVars[accessor]=cvar,extVars[accessor]=evars,solvers=solvers.concat(cvar.solvers).uniq(),evars.each(function(evar){evar.prepareEdit()})}),solvers.invoke("beginEdit"),callback},readonly:function(obj){return obj.isConstraintObject?obj.setReadonly(!0):Constraint.current&&Constraint.current.solver&&Properties.own(obj).each(function(ea){var cvar=ConstrainedVariable.newConstraintVariableFor(obj,ea);cvar.addToConstraint(Constraint.current),cvar.ensureExternalVariableFor(Constraint.current.solver),cvar.isSolveable()&&bbb.readonly(cvar.externalVariables(Constraint.current.solver))}),obj},always:function(opts,func){var solver=opts.solver||this.defaultSolver;if(func.allowTests=opts.allowTests===!0,func.allowUnsolvableOperations=opts.allowUnsolvableOperations===!0,func.debugging=opts.debugging,solver)return solver.always(opts,func);var constraint,errors=[];if(bbb.defaultSolvers.some(function(solver){try{return constraint=solver.always(opts,func),!0}catch(e){return errors.push("\n"+solver.constructor.name+": "+e),!1}}),constraint)return constraint;throw new Error("Must explicitely pass a solver for this constraint. The errors for the tried solvers were:"+errors)}}),Object.extend(Global,{bbb:new Babelsberg}),users.timfelgentreff.jsinterpreter.Send.addMethods({get args(){return this._$args||[]},set args(value){this._$args=value}}),cop.create("ConstraintConstructionLayer").refineObject(users.timfelgentreff.jsinterpreter,{get InterpreterVisitor(){return ConstraintInterpreterVisitor}}).refineClass(users.timfelgentreff.jsinterpreter.Send,{asFunction:function(optFunc){var initializer=optFunc.prototype.initialize.ast().asFunction();return initializer.original=optFunc,initializer}}).refineClass(users.timfelgentreff.jsinterpreter.GetSlot,{set:function(value,frame,interpreter){var obj=interpreter.visit(this.obj),name=interpreter.visit(this.slotName);return obj===Global||obj instanceof lively.Module?obj[name]=value:(obj&&obj.isConstraintObject&&(obj=this.getConstraintObjectValue(obj)),obj[name]=value,cvar=ConstrainedVariable.newConstraintVariableFor(obj,name),Constraint.current&&(cvar.ensureExternalVariableFor(Constraint.current.solver),cvar.addToConstraint(Constraint.current),cvar.isSolveable()&&Constraint.current.addPrimitiveConstraint(cvar.externalVariable.cnEquals(value))),void 0)}}),Object.subclass("Constraint",{initialize:function(predicate,solver){this._enabled=!1,this._predicate=predicate,this.constraintobjects=[],this.constraintvariables=[],this.solver=solver;try{Constraint.current=this;var constraintObject=cop.withLayers([ConstraintConstructionLayer],function(){return predicate.forInterpretation().apply(void 0,[])})}finally{Constraint.current=null}this.addPrimitiveConstraint(constraintObject)},addPrimitiveConstraint:function(obj){"undefined"==typeof obj||this.constraintobjects.include(obj)||(obj.enable||this.haltIfDebugging(),this.constraintobjects.push(obj))},addConstraintVariable:function(v){v&&!this.constraintvariables.include(v)&&this.constraintvariables.push(v)},get predicate(){return this._predicate},get allowUnsolvableOperations(){return this.haltIfDebugging(),!!this.predicate.allowUnsolvableOperations},haltIfDebugging:function(){this.predicate.debugging},get allowTests(){return this.haltIfDebugging(),!!this.predicate.allowTests},get priority(){return this._priority},set priority(value){var enabled=this._enabled;enabled&&this.disable(),this._priority=value,enabled&&this.enable()},get value(){return this.constraintobjects.last()},enable:function(){if(!this._enabled){if(this.constraintobjects.each(function(ea){this.enableConstraintObject(ea)}.bind(this)),0===this.constraintobjects.length)throw new Error("BUG: No constraintobjects were created.");this._enabled=!0,this.solver.solve()}},enableConstraintObject:function(obj,optPriority){if(obj===!0){if(!this.allowTests)throw new Error("Constraint expression returned true, but was not marked as test. If you expected this to be solveable, check that there are no operations in this that cannot be solved by the selected solver (e.g. Cassowary does not support `<', only `<='). Otherwise, if you think this is ok, you must pass `allowTests: true' as option to the constraint.");alertOK("Warning: Constraint expression returned true. Re-running whenever the value changes")}else{if(obj===!1)throw new Error("Constraint expression returned false, no solver available to fix it");if(!obj.enable){var e=new Error("Constraint expression returned an object that does not respond to #enable");throw e.obj=obj,e.constraint=this,e}obj.solver=this.solver,obj.enable(optPriority||this._priority)}},disable:function(){this._enabled&&(this.constraintobjects.each(function(ea){try{ea.disable()}catch(e){}}),this._enabled=!1)},recalculate:function(){var assignments,enabled=this._enabled,cvars=this.constraintvariables,self=this;if(enabled&&this.disable(),this.initialize(this.predicate,this.solver),cvars.select(function(ea){return!this.constraintvariables.include(ea)&&ea.isSolveable()}.bind(this)).each(function(ea){return ea.externalVariable.removeStay()}),enabled){assignments=this.constraintvariables.select(function(ea){return!cvars.include(ea)&&ea.isSolveable()}).collect(function(ea){return ea.externalVariable.cnIdentical(ea.getValue())}),assignments.each(function(ea){try{self.enableConstraintObject(ea)}catch(_){self.enableConstraintObject(ea,self.solver.strength.strong)}});try{this.enable()}catch(_){this._enabled=!0,this.disable(),assignments.invoke("disable"),assignments.invoke("enable",this.solver.strength.strong),this.enable()}finally{assignments.invoke("disable")}}}}),Object.extend(Constraint,{set current(p){return this._previous||(this._previous=[]),null===p?(this._current=this._previous.length>0?this._previous.pop():null,void 0):(this._current&&this._previous.push(this._current),this._current=p,void 0)},get current(){return this._current}}),Object.subclass("ConstrainedVariable",{initialize:function(obj,ivarname,optParentCVar){this.obj=obj,this.ivarname=ivarname,this.newIvarname="$1$1"+ivarname,this.parentConstrainedVariable=optParentCVar,this._constraints=[],this._externalVariables={};var solver=(obj[ivarname],this.currentSolver);dbgOn(!solver),this.ensureExternalVariableFor(solver);var existingSetter=obj.__lookupSetter__(this.ivarname),existingGetter=obj.__lookupGetter__(this.ivarname);existingGetter&&!existingGetter.isConstraintAccessor&&obj.__defineGetter__(this.newIvarname,existingGetter),existingSetter&&!existingSetter.isConstraintAccessor&&obj.__defineSetter__(this.newIvarname,existingSetter),existingGetter||existingSetter||!this.obj.hasOwnProperty(this.ivarname)||this.setValue(obj[ivarname]);try{obj.__defineGetter__(ivarname,function(){return this.getValue()}.bind(this))}catch(e){}var newGetter=obj.__lookupGetter__(this.ivarname);if(!newGetter)return this.externalVariables(solver,null),void 0;obj.__defineSetter__(ivarname,function(newValue){return this.suggestValue(newValue,"source")}.bind(this));var newSetter=obj.__lookupSetter__(this.ivarname);newSetter.isConstraintAccessor=!0,newGetter.isConstraintAccessor=!0},ensureExternalVariableFor:function(solver){var eVar=this.externalVariables(solver),value=this.obj[this.ivarname];this.cachedDefiningSolver=null,this.cachedDefiningVar=null,eVar||null===eVar||this.externalVariables(solver,solver.constraintVariableFor(value,this.ivarname,this))},get currentSolver(){return Constraint.current?Constraint.current.solver:null},suggestValue:function(value,source){if(ConstrainedVariable.$$callingSetters)return value;if(value!==this.storedValue){var callSetters=!ConstrainedVariable.$$optionalSetters,priorValue=this.storedValue;ConstrainedVariable.$$optionalSetters=ConstrainedVariable.$$optionalSetters||[];try{if(this.isSolveable()&&!ConstrainedVariable.isSuggestingValue){var wasReadonly=!1,eVar=this.definingExternalVariable,solver=this.definingSolver;try{solver&&source&&(solver.weight+=987654321,this.findTransitiveConnectedVariables().each(function(cvar){cvar.setDownstreamReadonly(!0)})),ConstrainedVariable.isSuggestingValue=!0,wasReadonly=eVar.isReadonly(),eVar.setReadonly(!1),eVar.suggestValue(value),value=this.externalValue}finally{eVar.setReadonly(wasReadonly),ConstrainedVariable.isSuggestingValue=!1}}if(value!==this.storedValue&&!this.$$isStoring){this.$$isStoring=!0;try{if(this.isSolveable()){var getterSetterPair=this.findOptionalSetter();getterSetterPair&&ConstrainedVariable.$$optionalSetters.push(getterSetterPair)}this.setValue(value),this.updateDownstreamVariables(value),this.updateConnectedVariables()}catch(e){throw source?(this.$$isStoring=!1,value=this.suggestValue(priorValue,source),new Error(e)):e}finally{this.$$isStoring=!1}}if(callSetters){ConstrainedVariable.$$callingSetters=!0;var recvs=[],setters=[];ConstrainedVariable.$$optionalSetters.each(function(ea){var recvIdx=recvs.indexOf(ea.recv);if(-1===recvIdx&&(recvIdx=recvs.length,recvs.push(ea.recv)),setters[recvIdx]=setters[recvIdx]||[],-1===setters[recvIdx].indexOf(ea.setter)){setters[recvIdx].push(ea.setter);try{ea.recv[ea.setter](ea.recv[ea.getter]())}catch(e){alert(e)}}}),ConstrainedVariable.$$callingSetters=!1}}finally{callSetters&&(ConstrainedVariable.$$optionalSetters=null),solver&&source&&(solver.weight-=987654321,this.findTransitiveConnectedVariables().each(function(cvar){cvar.setDownstreamReadonly(!1)}))}}return value},findOptionalSetter:function(){return this.setter?{recv:this.recv,getter:this.getter,setter:this.setter}:this.parentConstrainedVariable?this.parentConstrainedVariable.findOptionalSetter():void 0},get getter(){return this.$getter},get recv(){return this.$recv},set getter(value){if(this.$getter=value,this.recv){var setter=value.replace("get","set");Object.isFunction(this.recv[setter])&&(this.setter=setter)}},set recv(value){if(this.$recv=value,this.getter){var setter=this.getter.replace("get","set");Object.isFunction(value[setter])&&(this.setter=setter)}},setDownstreamReadonly:function(bool){if(bool&&!this.$$downstreamReadonlyVars){this.cachedDefiningSolver=null,this.cachedDefiningVar=null;var defVar=this.definingExternalVariable;this.$$downstreamReadonlyVars=[],this.eachExternalVariableDo(function(eVar){eVar!==defVar&&(eVar.isReadonly()||(eVar.setReadonly(!0),this.$$downstreamReadonlyVars.push(eVar)))}.bind(this))}else!bool&&this.$$downstreamReadonlyVars&&(this.$$downstreamReadonlyVars.each(function(eVar){eVar.setReadonly(!1)}.bind(this)),this.$$downstreamReadonlyVars=null)},findTransitiveConnectedVariables:function(ary){return ary||(ary=[]),-1===ary.indexOf(this)?(ary.push(this),this._constraints.each(function(c){return c.constraintvariables.each(function(cvar){cvar.findTransitiveConnectedVariables(ary)})}),ary):void 0},updateConnectedVariables:function(){this._constraints.collect(function(c){return c.constraintvariables}).flatten().uniq().each(function(cvar){cvar.suggestValue(cvar.getValue())})},updateDownstreamVariables:function(value){var defVar=this.definingExternalVariable;this.eachExternalVariableDo(function(ea){ea!==defVar&&(ea.setReadonly(!1),ea.suggestValue(value),ea.setReadonly(!0))}),this.setValue(value),this._constraints.each(function(c){var eVar=this.externalVariables(c.solver);eVar||c.recalculate()}.bind(this))},addToConstraint:function(constraint){this._constraints.include(constraint)||this._constraints.push(constraint),constraint.addConstraintVariable(this)},get definingSolver(){var solver={weight:-1e3};return this.eachExternalVariableDo(function(eVar){if(eVar){var s=eVar.__solver__;s.weight>solver.weight&&(solver=s)}}),solver},get solvers(){var solvers=[];return this.eachExternalVariableDo(function(eVar){if(eVar){var s=eVar.__solver__;solvers.push(s)}}),solvers},get definingExternalVariable(){return this.externalVariables(this.definingSolver)},isSolveable:function(){return!!this.externalVariable},get storedValue(){return this.obj[this.newIvarname]},get externalValue(){var value;return value="function"==typeof this.externalVariable.value?this.externalVariable.value():this.externalVariable.value},setValue:function(value){this.obj[this.newIvarname]=value},eachExternalVariableDo:function(func){func.bind(this);for(key in this._externalVariables){var eVar=this._externalVariables[key];eVar&&func(eVar,key)}},getValue:function(){return this.isSolveable()?this.externalValue:this.storedValue},get externalVariable(){return this.currentSolver?this.externalVariables(this.currentSolver):this.definingExternalVariable},externalVariables:function(solver,value){if(solver.__uuid__||(solver.__uuid__=Strings.newUUID()),1===arguments.length)return this._externalVariables[solver.__uuid__];
if(value){if(value.__solver__=value.__solver__||solver,value.__cvar__&&value.__cvar__!==this)throw"Inconsistent external variable. This should not happen!";value.__cvar__=this}this._externalVariables[solver.__uuid__]=value||null}}),users.timfelgentreff.jsinterpreter.InterpreterVisitor.subclass("ConstraintInterpreterVisitor",{binaryExpressionMap:{"+":["plus","plus"],"-":["minus"],"*":["times","times"],"/":["divide"],"==":["cnEquals","cnEquals"],"===":["cnIdentical","cnIdentical"],"<=":["cnLeq","cnGeq"],">=":["cnGeq","cnLeq"],"<":["cnLess","cnGreater"],">":["cnGreater","cnLess"],"||":["cnOr","cnOr"]},alternativeExpressionsMapTo:{"+":"-","<=":"<",">=":">","==":"==="},get alternativeExpressionsMap(){var map={};return Properties.own(this.alternativeExpressionsMapTo).each(function(ea){map[this.alternativeExpressionsMapTo[ea]]=ea,map[ea]=this.alternativeExpressionsMapTo[ea]}.bind(this)),map},getConstraintObjectValue:function(o){if(void 0===o||!o.isConstraintObject)return o;var value=o.value;return"function"==typeof value?value.apply(o):value},errorIfUnsolvable:function(op,l,r,res){if("undefined"==typeof res&&(res=r,r=void 0),!(l.isConstraintObject||r&&r.isConstraintObject)||Constraint.current.allowUnsolvableOperations)return"function"==typeof res?res():res;var alternative,msg="`"+op+"' not allowed on "+l;if(void 0!==r){msg="Binary op "+msg+" and "+r;var altOp=this.alternativeExpressionsMap[op];altOp&&(l[this.binaryExpressionMap[altOp][0]]||r[this.binaryExpressionMap[altOp][1]])&&(alternative=altOp)}throw!alternative&&Constraint.current.solver.alternativeOperationFor&&(alternative=Constraint.current.solver.alternativeOperationFor(op)),msg+=". If you want to allow this, pass `allowUnsolvableOperations' to the constraint.",alternative&&(msg+=" You can also rewrite the code to use "+alternative+" instead."),new Error(msg)},visitVariable:function($super,node){return $super(node)},visitCond:function($super,node){var condVal=(this.currentFrame,this.visit(node.condExpr));if(condVal&&condVal.isConstraintObject){var self=this;condVal=this.getConstraintObjectValue(condVal),condVal||(condVal=cop.withoutLayers([ConstraintConstructionLayer],function(){return self.visit(node.condExpr)}))}return condVal?this.visit(node.trueExpr):this.visit(node.falseExpr)},visitUnaryOp:function($super,node){var val=(this.currentFrame,this.visit(node.expr)),rVal=this.getConstraintObjectValue(val),msg="Unary op `"+node.name+"'";switch(node.name){case"-":return val&&val.isConstraintObject&&val.times?val.times(-1):this.errorIfUnsolvable(msg,val,-rVal);case"!":return val&&val.isConstraintObject&&val.not?val.not():!val;case"~":return this.errorIfUnsolvable(msg,val,~rVal);case"typeof":return this.errorIfUnsolvable(msg,val,typeof rVal);default:throw new Error("No semantics for unary op "+node.name)}},invoke:function($super,node,recv,func,argValues){if(!(func||recv&&recv.isConstraintObject)){var error="No such method: "+recv+"."+(node.property&&node.property.value);throw alert(error),new Error(error)}if(!recv||!recv.isConstraintObject)return recv===Math?func===Math.sqrt&&argValues[0].pow||argValues[0].sqrt?argValues[0].pow?this.invoke(node,argValues[0],argValues[0].pow,[.5]):this.invoke(node,argValues[0],argValues[0].sqrt,[]):func===Math.pow&&argValues[0].pow?this.invoke(node,argValues[0],argValues[0].pow,[argValues[1]]):func===Math.sin&&argValues[0].sin?this.invoke(node,argValues[0],argValues[0].sin,[]):func===Math.cos&&argValues[0].cos?this.invoke(node,argValues[0],argValues[0].cos,[]):$super(node,recv,func,argValues):cop.withLayers([ConstraintConstructionLayer],function(){return $super(node,recv,func,argValues)});if(!func)return this.errorIfUnsolvable(node.property&&node.property.value,recv,function(){var value=this.getConstraintObjectValue(recv),prop=this.visit(node.property);return this.invoke(node,value,value[prop],argValues)}.bind(this));var forInterpretation=func.forInterpretation;func.forInterpretation=void 0;try{return cop.withoutLayers([ConstraintConstructionLayer],function(){return $super(node,recv,func,argValues)})}catch(e){return this.errorIfUnsolvable(node.property&&node.property.value,recv,function(){var value=this.getConstraintObjectValue(recv),prop=this.visit(node.property);return this.invoke(node,value,value[prop],argValues)}.bind(this))}finally{func.forInterpretation=forInterpretation}},visitBinaryOp:function($super,node){var op=node.name,leftVal=this.visit(node.left),rightVal=this.visit(node.right);void 0===leftVal&&(leftVal=0),void 0===rightVal&&(rightVal=0);var rLeftVal=leftVal.isConstraintObject?this.getConstraintObjectValue(leftVal):leftVal,rRightVal=rightVal.isConstraintObject?this.getConstraintObjectValue(rightVal):rightVal;switch(node.name){case"&&":if(!leftVal)return leftVal;if(leftVal===!0||leftVal.isConstraintObject){if("function"==typeof leftVal.cnAnd)return leftVal.cnAnd(rightVal);Constraint.current.addPrimitiveConstraint(leftVal)}else Constraint.current.haltIfDebugging();return rightVal;case"-":if(rightVal.isConstraintObject&&rightVal.plus&&Object.isNumber(leftVal))return rightVal.plus(-leftVal);default:var method=this.binaryExpressionMap[node.name];return method?leftVal.isConstraintObject&&"function"==typeof leftVal[method[0]]?leftVal[method[0]](rightVal):rightVal.isConstraintObject&&"function"==typeof rightVal[method[1]]?rightVal[method[1]](leftVal):this.errorIfUnsolvable(op,leftVal,rightVal,eval("rLeftVal "+node.name+" rRightVal")):this.errorIfUnsolvable(op,leftVal,rightVal,$super(node))}},visitGetSlot:function($super,node){if(-1===cop.currentLayers().indexOf(ConstraintConstructionLayer))return $super(node);var cvar,obj=this.visit(node.obj),name=this.visit(node.slotName),cobj=obj?obj[ConstrainedVariable.ThisAttrName]:void 0;if(obj===Global||obj instanceof lively.Module||"string"==typeof obj)return obj[name];if(obj&&obj.isConstraintObject){if(obj["cn"+name])return obj["cn"+name];cobj=obj.__cvar__,obj=this.getConstraintObjectValue(obj)}if(cvar=ConstrainedVariable.newConstraintVariableFor(obj,name,cobj),Constraint.current&&(cvar.ensureExternalVariableFor(Constraint.current.solver),cvar.addToConstraint(Constraint.current)),cvar&&cvar.isSolveable())return cvar.externalVariable;var retval=obj[name];if(!retval||!retval.isConstraintObject){var objStr,retStr,toS=Object.prototype.toString;try{objStr=obj.toString()}catch(e){objStr=toS.apply(obj)}try{retStr=retval.toString()}catch(e){retStr=toS.apply(retval)}console.log(Constraint.current.solver.constructor.name+" cannot reason about the variable "+objStr+"["+name+"], a "+retStr+" of type "+("object"==typeof retval?retval.constructor.name:typeof retval)),Constraint.current.haltIfDebugging()}return retval&&(retval[ConstrainedVariable.ThisAttrName]=cvar),retval},visitReturn:function($super,node){var retVal=$super(node);if(retVal){var cvar=retVal[ConstrainedVariable.ThisAttrName];if(retVal.isConstraintObject&&(cvar=retVal.__cvar__),cvar){var parentFunc=node.parentFunction();parentFunc&&(cvar.getter=parentFunc.name(),cvar.recv=this.currentFrame.mapping["this"])}}return retVal},shouldInterpret:function(frame,func){if(func.sourceModule===Global.users.timfelgentreff.babelsberg.constraintinterpreter)return!1;if("Babelsberg"===func.declaredClass)return!1;var nativeClass=lively.Class.isClass(func)&&void 0===func.superclass;return!(this.isNative(func)||nativeClass)&&"function"==typeof func.forInterpretation},newObject:function($super,func){return func.original?$super(func.original):$super(func)}}),ConstrainedVariable.AttrName="__constrainedVariables__",ConstrainedVariable.ThisAttrName="__lastConstrainedVariableForThis__",Object.extend(ConstrainedVariable,{findConstraintVariableFor:function(obj,ivarname){var l=obj[ConstrainedVariable.AttrName];return l&&l[ivarname]?l[ivarname]:null},newConstraintVariableFor:function(obj,ivarname,cobj){var cvar=this.findConstraintVariableFor(obj,ivarname);return cvar||(cvar=new ConstrainedVariable(obj,ivarname,cobj),obj[ConstrainedVariable.AttrName]=obj[ConstrainedVariable.AttrName]||{},obj[ConstrainedVariable.AttrName][ivarname]=cvar),cvar},deleteConstraintVariableFor:function(obj,ivarname){var l=obj[ConstrainedVariable.AttrName];l&&l[ivarname]&&delete l[ivarname]},isSuggestingValue:!1})});